{% extends "core/dashboard_base.html" %}
{% load form_tags %}

{% block head_extra %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% block dashboard_title %}Баланси{% endblock %}
{% block dashboard_heading %}Баланси{% endblock %}

{% block dashboard_content %}
  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <form method="get" class="d-flex flex-wrap align-items-center gap-2 w-100 flex-md-nowrap">
      <select name="customer" id="balancesUsersCustomer" class="form-select form-select-sm" style="min-width: 240px;" data-placeholder="Усі клієнти">
        <option value="">Усі клієнти</option>
        {% for c in customer_options %}
          <option value="{{ c.id }}" {% if customer_filter|add:'0' == c.id|add:'0' %}selected{% endif %}>
            {% if c.customerprofile.full_name %}{{ c.customerprofile.full_name }}{% else %}{{ c }}{% endif %}
          </option>
        {% endfor %}
      </select>
      <input type="search" name="q" value="{{ q }}" class="form-control form-control-sm flex-grow-1" placeholder="Пошук (ПІБ, email, телефон, компанія)">
      <button type="submit" class="btn btn-primary btn-sm">Фільтрувати</button>
      <a href="{% url 'orders:balances_users' %}" class="btn btn-outline-secondary btn-sm">Скинути</a>
    </form>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="d-none d-md-block border-bottom bg-light">
        <div class="row g-2 align-items-center px-3 py-2 text-uppercase small fw-semibold text-muted">
          <div class="col"><a href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort={% if sort == 'full_name' %}-full_name{% else %}full_name{% endif %}">ПІБ / Компанія</a></div>
          <div class="col">Email</div>
          <div class="col">Телефон</div>
          <div class="col-auto text-end"><a href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort={% if sort == 'balance' %}-balance{% else %}balance{% endif %}">Баланс, грн</a></div>
          <div class="col-12 col-md-3 text-end">Дії</div>
        </div>
      </div>

      {% for u in clients %}
        {% with profile=u.customerprofile %}
          <div class="border-bottom">
            <div class="row g-3 align-items-center px-3 py-3">
              <div class="col-12 col-md">
                <div class="fw-semibold">{{ profile.full_name|default:u.email }}</div>
                {% if profile.company_name %}<div class="text-muted small">{{ profile.company_name }}</div>{% endif %}
              </div>
              <div class="col-12 col-md">
                {{ u.email|default:"—" }}
              </div>
              <div class="col-6 col-md">
                {{ profile.phone|default:"—" }}
              </div>
              <div class="col-6 col-md-auto text-md-end">
                {% with bal=balances|get_item:u.id %}
                  <span class="fw-semibold {% if bal < 0 %}text-danger{% else %}text-success{% endif %}">{{ bal|floatformat:2 }}</span>
                {% endwith %}
              </div>
              <div class="col-12 col-md-3 text-md-end">
                <div class="d-flex flex-wrap gap-2 justify-content-start justify-content-md-end">
                  <a class="btn btn-sm btn-outline-primary" href="{% url 'orders:balances' %}?customer={{ u.id }}">Переглянути</a>
                  <a class="btn btn-sm btn-success" href="{% url 'orders:transaction_create' %}?customer={{ u.id }}">Створити транзакцію</a>
                  <a class="btn btn-sm btn-outline-success" href="{% url 'orders:balances_excel' %}?customer={{ u.id }}">Експорт балансу (Excel)</a>
                  {% with tok=balance_tokens|get_item:u.id %}
                    <a class="btn btn-sm btn-outline-primary" href="{% url 'orders:balance_public' tok %}" target="_blank">Експорт балансу (сторінка)</a>
                  {% endwith %}
                </div>
              </div>
            </div>
          </div>
        {% endwith %}
      {% empty %}
        <div class="text-center text-muted py-4">Немає клієнтів</div>
      {% endfor %}
    </div>
  </div>
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const $customer = $('#balancesUsersCustomer');
      if ($customer.length) {
        $customer.select2({
          width: '100%',
          placeholder: $customer.data('placeholder') || 'Усі клієнти',
          allowClear: true,
        });
        $customer.on('change', function () {
          const form = document.querySelector('form[method="get"]');
          if (form) form.submit();
        });
      }

      const form = document.querySelector('form[method="get"]');
      if (form) {
        const storageKey = 'balancesUsersFilters';
        const readFields = () => {
          const data = {};
          form.querySelectorAll('select[name], input[name]').forEach((el) => {
            data[el.name] = el.value || '';
          });
          return data;
        };
        const writeFields = (data) => {
          Object.keys(data || {}).forEach((name) => {
            const el = form.querySelector(`[name="${name}"]`);
            if (!el) return;
            if (window.jQuery && el.classList.contains('select2-hidden-accessible')) {
              $(el).val(data[name] || '').trigger('change');
            } else {
              el.value = data[name] || '';
            }
          });
        };

        const hasQuery = window.location.search && window.location.search.length > 1;
        if (hasQuery) {
          try { localStorage.setItem(storageKey, JSON.stringify(readFields())); } catch (e) {}
        } else {
          try {
            const saved = localStorage.getItem(storageKey);
            if (saved) {
              writeFields(JSON.parse(saved));
              form.requestSubmit();
            }
          } catch (e) {}
        }

        form.addEventListener('change', function () {
          try { localStorage.setItem(storageKey, JSON.stringify(readFields())); } catch (e) {}
        });
        form.addEventListener('submit', function () {
          try { localStorage.setItem(storageKey, JSON.stringify(readFields())); } catch (e) {}
        });
      }
    });
  </script>
{% endblock %}
