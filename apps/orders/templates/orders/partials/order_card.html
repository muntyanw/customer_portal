{% load form_tags %}
{% with card_cls=card_class|default:"card border-0 shadow-lg" %}
<div class="{{ card_cls }}">
  <div class="card-body p-3">
    <div class="row g-2 align-items-start">
      <div class="col-lg-8 col-md-7 d-flex align-items-start gap-2">
        {% if show_select and order.status == order.STATUS_QUOTE %}
          <input class="form-check-input mt-1" type="checkbox" name="{{ select_name|default:'order_ids' }}" value="{{ order.id }}" form="{{ select_form|default:'bulkForm' }}" aria-label="Обрати замовлення">
        {% endif %}
        <div>
          <div class="fw-semibold">Замовлення №{{ order.id }}</div>
          <div class="small text-muted">{{ order.created_at|date:'d.m.Y H:i' }}</div>
          {% if order.customer %}
            {% with profile=order.customer.customerprofile %}
              <div class="small text-muted">
                Клієнт:
                <a href="{% url 'accounts:profile_other' order.customer.id %}">
                  {% if profile.full_name %}{{ profile.full_name }}{% else %}{{ order.customer }}{% endif %}
                </a>
                {% if profile.phone %} · {{ profile.phone }}{% endif %}
              </div>
            {% endwith %}
          {% endif %}
          {% if show_type %}
            <div class="small text-muted">
              Тип: {% if order.component_items.all|length %}Комплектуючі{% else %}Ролети{% endif %}
            </div>
          {% endif %}
          {% if order.note and show_note|default_if_none:True %}
            <div class="small text-muted text-break" title="{{ order.note|striptags }}">
              {{ order.note|safe }}
            </div>
          {% endif %}
        </div>
      </div>

      <div class="col-auto ms-lg-auto text-lg-end">
        {% with badge=status_badges|get_item:order.status|default:"secondary" %}
          <span class="badge bg-{{ badge }}">{{ order.get_status_display }}</span>
        {% endwith %}
        <div class="fw-semibold {% if show_rate %}fs-5{% endif %} mt-2">{{ order.total_uah_display|default_if_none:0|floatformat:0 }} грн</div>
        {% if show_rate %}
          <div class="small text-muted">Курс: {{ order.display_rate|default:"0.00" }}</div>
        {% endif %}
        {% if order.workbook_file %}
          <div class="small mt-1">
            <a href="{{ order.workbook_file.url }}" download>Скачати файл замовлення (xlsx)</a>
          </div>
        {% endif %}
      </div>
    </div>
    {% if view_url or delete_url or send_to_work_url %}
      <div class="d-flex flex-wrap gap-2 mt-2">
        {% if send_to_work_url %}
          {% if order.status == order.STATUS_QUOTE %}
            <form method="post" action="{{ send_to_work_url }}">
              {% csrf_token %}
              <input type="hidden" name="status_action" value="to_work">
              {% with badge=status_badges|get_item:order.STATUS_IN_WORK|default:"success" %}
                <button
                  type="submit"
                  class="btn btn-sm btn-{{ badge }}"
                  data-order-id="{{ order.id }}"
                  {% if order.customer_id == request.user.id %}data-payment-check="1"{% endif %}
                >
                  <i class="bi bi-play-fill me-1"></i> В роботу
                </button>
              {% endwith %}
            </form>
          {% endif %}
          {% if request.user.is_manager %}
            {% with prev=order.prev_status %}
              {% if prev %}
                {% with badge=status_badges|get_item:prev|default:"secondary" %}
                  <form method="post" action="{{ send_to_work_url }}">
                    {% csrf_token %}
                    <input type="hidden" name="status_action" value="prev">
                    <button type="submit" class="btn btn-sm btn-{{ badge }}">
                      <i class="bi bi-arrow-left-short me-1"></i>{{ status_labels|get_item:prev|default:"Попередній статус" }}
                    </button>
                  </form>
                {% endwith %}
              {% endif %}
            {% endwith %}
            {% if order.status != order.STATUS_QUOTE %}
              {% with nxt=order.next_status %}
                {% if nxt %}
                  {% with badge=status_badges|get_item:nxt|default:"secondary" %}
                    <form method="post" action="{{ send_to_work_url }}">
                      {% csrf_token %}
                      <input type="hidden" name="status_action" value="next">
                      <button type="submit" class="btn btn-sm btn-{{ badge }}">
                        {{ status_labels|get_item:nxt|default:"Наступний статус" }}<i class="bi bi-arrow-right-short ms-1"></i>
                      </button>
                    </form>
                  {% endwith %}
                {% endif %}
              {% endwith %}
            {% endif %}
          {% endif %}
        {% endif %}
        {% if view_url %}
          <a class="btn btn-sm btn-primary" href="{{ view_url }}">
            <i class="bi bi-eye me-1"></i> {{ view_label|default:"Переглянути" }}
          </a>
        {% endif %}
        {% if request.user.is_manager %}
          <a class="btn btn-sm btn-outline-primary" href="{% url 'orders:workbook_download' order.id %}">
            <i class="bi bi-file-earmark-excel me-1"></i> Файл замовлення
          </a>
          {% with proposal_page=proposal_page_urls|get_item:order.id %}
            {% if proposal_page %}
              <a class="btn btn-sm btn-warning text-dark" href="{{ proposal_page }}" target="_blank">
                <i class="bi bi-eye me-1"></i> Комерційна (сторінка)
              </a>
            {% endif %}
          {% endwith %}
          {% with proposal_excel=proposal_excel_urls|get_item:order.id %}
            {% if proposal_excel %}
              <a class="btn btn-sm btn-success" href="{{ proposal_excel }}">
                <i class="bi bi-file-earmark-excel me-1"></i> Комерційна (Excel)
              </a>
            {% endif %}
          {% endwith %}
        {% endif %}
        {% if delete_url %}
          {% if request.user.is_manager or order.status == order.STATUS_QUOTE %}
            <a class="btn btn-sm btn-danger" href="{{ delete_url }}">
              <i class="bi bi-trash me-1"></i> Видалити
            </a>
          {% endif %}
        {% endif %}
      </div>
    {% endif %}
    {% if show_last_status %}
      <div class="small text-muted mt-2">
        Останній статус: {% with log=order.status_logs.first %}{% if log %}{{ log.get_status_display }} · {{ log.created_at|date:'d.m.Y H:i' }} · {{ log.user }}{% else %}—{% endif %}{% endwith %}
      </div>
    {% endif %}
  </div>
</div>
{% endwith %}
