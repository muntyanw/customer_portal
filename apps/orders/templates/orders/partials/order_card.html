{% load form_tags %}
{% with card_cls=card_class|default:"card border-0 shadow-sm" %}
<div class="{{ card_cls }}">
  <div class="card-body d-flex flex-column gap-2">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
      <div class="d-flex align-items-start gap-2">
        {% if show_select %}
          <input class="form-check-input mt-1" type="checkbox" name="{{ select_name|default:'order_ids' }}" value="{{ order.id }}" form="{{ select_form|default:'bulkForm' }}" aria-label="Обрати замовлення">
        {% endif %}
        <div>
        <div class="fw-semibold">Замовлення № {{ order.id }}</div>
        <div class="small text-muted">{{ order.created_at|date:'d.m.Y H:i' }}</div>
        {% if order.customer %}
          {% with profile=order.customer.customerprofile %}
            <div class="small text-muted">
              Клієнт:
              <a href="{% url 'accounts:profile_other' order.customer.id %}">
                {% if profile.full_name %}{{ profile.full_name }}{% else %}{{ order.customer }}{% endif %}
              </a>
              {% if profile.phone %} · {{ profile.phone }}{% endif %}
            </div>
          {% endwith %}
        {% endif %}
        {% if show_type %}
          <div class="small text-muted">
            Тип: {% if order.component_items.all|length %}Комплектуючі{% else %}Ролети{% endif %}
          </div>
        {% endif %}
        {% if order.note and show_note|default_if_none:True %}
          <div class="small text-muted" title="{{ order.note }}">
            {{ order.note|truncatechars:160 }}
          </div>
        {% endif %}
      </div>
      </div>
      <div class="text-end">
        {% with badge=status_badges|get_item:order.status|default:"secondary" %}
          <span class="badge bg-{{ badge }}">{{ order.get_status_display }}</span>
        {% endwith %}
        <div class="fw-semibold {% if show_rate %}fs-5{% endif %} mt-2">{{ order.total_uah_display|default:"0.00" }} грн</div>
        {% if show_rate %}
          <div class="small text-muted">Курс: {{ order.display_rate|default:"0.00" }}</div>
        {% endif %}
        {% if order.workbook_file %}
          <div class="small mt-1">
            <a href="{{ order.workbook_file.url }}" download>Скачати файл замовлення (xlsx)</a>
          </div>
        {% endif %}
      </div>
    </div>
    {% if show_last_status %}
      <div class="small text-muted">
        Останній статус: {% with log=order.status_logs.first %}{% if log %}{{ log.get_status_display }} · {{ log.created_at|date:'d.m.Y H:i' }} · {{ log.user }}{% else %}—{% endif %}{% endwith %}
      </div>
    {% endif %}
    {% if view_url or delete_url or send_to_work_url %}
      <div class="d-flex flex-wrap gap-2">
        {% if view_url %}
          <a class="btn btn-sm btn-outline-primary" href="{{ view_url }}">
            <i class="bi bi-eye me-1"></i> {{ view_label|default:"Переглянути" }}
          </a>
        {% endif %}
        {% if send_to_work_url %}
          {% if order.status == order.STATUS_QUOTE %}
            <form method="post" action="{{ send_to_work_url }}" class="d-inline">
              {% csrf_token %}
              <input type="hidden" name="status_action" value="to_work">
              {% with badge=status_badges|get_item:order.STATUS_IN_WORK|default:"success" %}
                <button
                  type="submit"
                  class="btn btn-sm btn-{{ badge }}"
                  data-order-id="{{ order.id }}"
                  {% if order.customer_id == request.user.id %}data-payment-check="1"{% endif %}
                >
                  <i class="bi bi-play-fill me-1"></i> В роботу
                </button>
              {% endwith %}
            </form>
          {% endif %}
          {% if request.user.is_manager %}
            {% with prev=order.prev_status %}
              {% if prev %}
                {% with badge=status_badges|get_item:prev|default:"secondary" %}
                  <form method="post" action="{{ send_to_work_url }}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="status_action" value="prev">
                    <button type="submit" class="btn btn-sm btn-{{ badge }}">
                      <i class="bi bi-arrow-left-short me-1"></i>{{ status_labels|get_item:prev|default:"Попередній статус" }}
                    </button>
                  </form>
                {% endwith %}
              {% endif %}
            {% endwith %}
            {% if order.status != order.STATUS_QUOTE %}
              {% with nxt=order.next_status %}
                {% if nxt %}
                  {% with badge=status_badges|get_item:nxt|default:"secondary" %}
                    <form method="post" action="{{ send_to_work_url }}" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="status_action" value="next">
                      <button type="submit" class="btn btn-sm btn-{{ badge }}">
                        {{ status_labels|get_item:nxt|default:"Наступний статус" }}<i class="bi bi-arrow-right-short ms-1"></i>
                      </button>
                    </form>
                  {% endwith %}
                {% endif %}
              {% endwith %}
            {% endif %}
          {% endif %}
        {% endif %}
        {% if delete_url %}
          {% if request.user.is_manager or order.status == order.STATUS_QUOTE %}
            <a class="btn btn-sm btn-outline-danger" href="{{ delete_url }}">
              <i class="bi bi-trash me-1"></i> Видалити
            </a>
          {% endif %}
        {% endif %}
      </div>
    {% endif %}
  </div>
</div>
{% endwith %}
