{% extends "core/dashboard_base.html" %}
{% block dashboard_title %}Нове замовлення{% endblock %}
{% block dashboard_heading %}Конструктор замовлення{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .order-total-bar{
      position: sticky; bottom: 0; z-index: 1030;
      background: var(--bs-body-bg); border-top: 1px solid var(--bs-border-color);
    }
    .item-card .price-box .kv{
      display:flex; justify-content:space-between; gap:.75rem;
      font-size:.9rem; color:var(--bs-secondary-color);
    }
    .item-card .price-box .sum{
      display:flex; justify-content:space-between; gap:.75rem;
      font-weight:600; font-size:1.05rem;
    }
    @media (min-width: 992px){
      .item-card .controls-inline{ display:flex; gap:.75rem; }
    }
  </style>
{% endblock %}

{% block dashboard_content %}
<form method="post" id="orderForm" novalidate>{% csrf_token %}
  <div class="mb-3">
    <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
      <div class="fw-semibold" style="display: none;">Джерело прайсу</div>
      <a href="{{ PRICE_SHEET_URL }}" target="_blank" class="small">Відкрити прайс</a>
    </div>
    <input type="url" class="form-control" id="priceUrl" name="price_url"
           value="{{ PRICE_SHEET_URL }}" required style="display: none;">
  </div>

  <!-- Контейнер для карток позицій -->
  <div id="itemsContainer" class="d-flex flex-column gap-3"></div>

  <div class="d-grid mt-2">
    <button type="button" class="btn btn-outline-primary" id="addRow">
      <i class="bi bi-plus-lg me-1"></i> Додати позицію
    </button>
  </div>

  <!-- Підсумок по замовленню -->
  <div class="order-total-bar mt-3 p-3 rounded-3 shadow-sm">
    <div class="d-flex justify-content-between align-items-center">
      <div class="fw-semibold">Разом по замовленню, €</div>
      <div id="orderTotal" class="fs-5 fw-bold">0.00</div>
    </div>
  </div>

  <div class="d-grid mt-3">
    <button type="submit" class="btn btn-success btn-lg">Зберегти замовлення</button>
  </div>
</form>

{% include "orders/_item_template.html" %}
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  <script>
    // ---------- Helpers ----------
    function money(x){ return (Math.round(parseFloat(x||0)*100)/100).toFixed(2); }

    function getCsrf(){
      const m = document.querySelector('meta[name="csrf-token"]');
      if (m && m.content) return m.content;
      const match = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : "";
    }

    if (!window.showToast) {
      window.showToast = (msg, type="info")=>{
        const div = document.createElement('div');
        div.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3 shadow`;
        div.style.zIndex = 2000;
        div.textContent = msg;
        document.body.appendChild(div);
        setTimeout(()=>div.remove(), 2500);
      };
    }

    function itemTemplate(index) {
      const tpl = document.getElementById("item-template");
      const node = tpl.content.cloneNode(true);
      $(node).find(".pos-index").text(index + 1);
      $(node).find("[data-index]").attr("data-index", index);
      return node;
    }

    // ---------- State / cache ----------
    const $container = $("#itemsContainer");
    const priceUrlInput = $("#priceUrl");

    let systemsCache = null;              // список вкладок (систем)
    const sectionsCache = new Map();      // key: system -> [sections]
    const fabricsCache  = new Map();      // key: system|section -> {fabrics, width_bands, magnets_price_eur}

    // ---------- API ----------

    async function loadSystems(){
      const url = priceUrlInput.val();
      const resp = await fetch(`/api/v1/pricing/systems-list?url=${encodeURIComponent(url)}`);
      if(!resp.ok) throw new Error("Cannot load systems");
      const data = await resp.json();
      systemsCache = data.systems || data.sheets || [];
      return systemsCache;
    }

    async function loadSectionsForSystem(system){
      if(sectionsCache.has(system)) return sectionsCache.get(system);

      const url = priceUrlInput.val();
      const resp = await fetch(
        `/api/v1/pricing/system-fabrics?url=${encodeURIComponent(url)}&system=${encodeURIComponent(system)}`
      );
      if(!resp.ok) throw new Error("Cannot load sections");
      const data = await resp.json();
      const sections = data.sections || [];
      sectionsCache.set(system, sections);
      return sections;
    }

    async function loadFabricsForSection(system, section){
      const key = `${system}|||${section}`;
      if(fabricsCache.has(key)) return fabricsCache.get(key);

      const url = priceUrlInput.val();
      const resp = await fetch(
        `/api/v1/pricing/system-fabrics?url=${encodeURIComponent(url)}&system=${encodeURIComponent(system)}&section=${encodeURIComponent(section)}`
      );
      if(!resp.ok) throw new Error("Cannot load fabrics");
      const data = await resp.json();
      fabricsCache.set(key, data);
      return data;
    }

    async function previewPrice({url, system, section, fabric, fabric_color, h, w, magnets, gabaritWidth}){
      $(".load_gif").show();
      const resp = await fetch("/api/v1/pricing/system-preview", {
        method: "POST",
        headers: {"Content-Type":"application/json", "X-CSRFToken": getCsrf()},
        body: JSON.stringify({
          url,
          system_sheet: system,
          section_title: section,
          fabric_name: fabric,
          fabric_color: fabric_color,
          width_mm: w,
          gabarit_height_mm: h,
          gabarit_width_flag: gabaritWidth,
          magnets
        })
      });
      if(!resp.ok){
        const err = await resp.json().catch(()=>({detail:"Error"}));
        throw new Error(err.detail || "Помилка розрахунку");
      }
      $(".load_gif").hide();
      return resp.json();
    }

    // ---------- UI helpers ----------

    function setCardBlockedUntilSection($card, blocked){
      $card.find(".fabric").prop("disabled", blocked);
      $card.find(".fabric_color").prop("disabled", blocked);
      $card.find(".h-mm, .w-mm, .gabarit-width-flag, .magnets, .qty").prop("disabled", blocked);
      $card.find(".need-section-hint").toggle(blocked);
    }

    function setLoadingFabrics($card, isLoading){
      const $fab = $card.find(".fabric");
      if(isLoading){
        $fab.html('<option>Завантаження тканин…</option>').prop("disabled", true);
      }
    }

    function fillSystems($card, preselectSystem){
      const $sys = $card.find(".system-sheet");
      $sys.empty();
      $sys.append('<option value="" selected disabled>— Оберіть систему —</option>');
      (systemsCache || []).forEach(name => {
        $sys.append(new Option(name, name));
      });
      if(preselectSystem && systemsCache && systemsCache.includes(preselectSystem)){
        $sys.val(preselectSystem);
      }
    }

    function fillSectionsForCard($card, system, preselectSection){
      const $sec = $card.find(".table-section");
      $sec.empty();
      $sec.append('<option value="" selected disabled>— Оберіть колір системи —</option>');

      const sections = sectionsCache.get(system) || [];
      sections.forEach(s => {
        // s может быть строкой или объектом { title: "..." }
        const t = (typeof s === "string") ? s : (s.title || "Секція");
        $sec.append(new Option(t, t));
      });

      $sec.prop("disabled", false);

      if(preselectSection){
        $sec.val(preselectSection);
      }
    }


    async function fillFabricsForCard($card, system, section, preselectFabric){
      if(!system || !section){
        setCardBlockedUntilSection($card, true);
        return;
      }
      setLoadingFabrics($card, true);
      try{
        const data = await loadFabricsForSection(system, section);
        const $fab = $card.find(".fabric");
        $fab.empty();
        (data.fabrics || []).forEach(f => $fab.append(new Option(f.name, f.name)));
        if(preselectFabric){
          $fab.val(preselectFabric);
        }
        $fab.prop("disabled", false);
        setCardBlockedUntilSection($card, false);
      }catch(e){
        setCardBlockedUntilSection($card, true);
        window.showToast("Не вдалося завантажити тканини для секції", "danger");
      }finally{
        setLoadingFabrics($card, false);
      }
    }

    function readCardValues($card){
      return {
        system:  $card.find(".system-sheet").val() || "",
        section: $card.find(".table-section").val() || "",
        fabric:  $card.find(".fabric").val() || "",
        fabric_color:  $card.find(".fabric_color").val() || "",
        h:       $card.find(".h-mm").val() || "",
        w:       $card.find(".w-mm").val() || "",
        qty:     $card.find(".qty").val() || "1",
        gw:      $card.find(".gabarit-width-flag").is(":checked"),
        mg:      $card.find(".magnets").is(":checked"),
      };
    }

    function recalcOrderTotal(){
      let sum = 0;
      $container.find(".item-card").each(function(){
        const st = parseFloat($(this).find(".subtotal").text() || "0");
        sum += isNaN(st) ? 0 : st;
      });
      $("#orderTotal").text(money(sum));
    }

    $container.on("change", ".fabric", async function(){
      const $card = $(this).closest(".item-card");
      const fabric = $(this).val();

      if (!fabric){
        fillFabricColorsForCard($card, [], null);
        return;
      }

      try{
        const data = await loadFabricColors(fabric);
        fillFabricColorsForCard($card, data.color_codes || [], null);
      }catch(e){
        window.showToast(e.message || "Не вдалося завантажити кольори тканини", "danger");
        fillFabricColorsForCard($card, [], null);
      }

      // и по сути у тебя уже есть превью:
      previewCard($card);
    });


    async function previewCard($card){
      const url = priceUrlInput.val();
      const system  = $card.find(".system-sheet").val();
      const section = $card.find(".table-section").val();
      const fabric  = $card.find(".fabric").val();
      const fabric_color  = $card.find(".fabric_color").val();
      const h = parseInt($card.find(".h-mm").val() || "0", 10);
      const w = parseInt($card.find(".w-mm").val() || "0", 10);
      const magnets = $card.find(".magnets").is(":checked");
      const gabaritWidth = $card.find(".gabarit-width-flag").is(":checked");
      const qty = Math.max(1, parseInt($card.find(".qty").val() || "1", 10));

      if(!system || !section || !fabric || !fabric_color || !h || !w){ return; }

      try{
        const data = await previewPrice({url, system, section, fabric, fabric_color, h, w, magnets, gabaritWidth});

        const base1 = Number(data.base_price_eur || 0);
        const sur1  = Number(data.surcharge_height_eur || 0);
        const mag1  = Number(data.magnets_price_eur || 0);
        const sub1  = Number(data.subtotal_eur || 0);

        const base = base1 * qty;
        const sur  = sur1  * qty;
        const mag  = mag1  * qty;
        const sub  = sub1  * qty;

        $card.find(".base").text(money(base));
        $card.find(".surcharge").text(money(sur));
        $card.find(".magnets-price").text(money(mag));
        $card.find(".subtotal").text(money(sub));

        $card.find(".base-input").val(money(base));
        $card.find(".surcharge-input").val(money(sur));
        $card.find(".magnets-input").val(money(mag));
        $card.find(".subtotal-input").val(money(sub));

        const rollInfo = (data.fabric_params && data.fabric_params.roll_height_mm) ? data.fabric_params.roll_height_mm : "";
        $card.find(".roll-info-input").val(rollInfo);

        recalcOrderTotal();
      }catch(err){
        window.showToast(err.message || "Помилка розрахунку", "danger");
      }
    }

    // ---------- Обробники ----------

    $("#addRow").on("click", async function(){
      const $prev = $container.find(".item-card").last();
      const prevVals = $prev.length ? readCardValues($prev) : null;

      const idx = $container.children().length;
      $container.append(itemTemplate(idx));
      const $card = $container.find(".item-card").last();

      setCardBlockedUntilSection($card, true);

      if(!systemsCache){
        try{ await loadSystems(); }
        catch(e){ window.showToast("Не вдалося завантажити системи прайсу", "danger"); return; }
      }
      fillSystems($card, prevVals?.system);

      if(prevVals && prevVals.system){
        try{
          await loadSectionsForSystem(prevVals.system);
          fillSectionsForCard($card, prevVals.system, prevVals.section);

          if(prevVals.section){
            await fillFabricsForCard($card, prevVals.system, prevVals.section, prevVals.fabric);

            if(prevVals.h)   $card.find(".h-mm").val(prevVals.h);
            if(prevVals.w)   $card.find(".w-mm").val(prevVals.w);
            if(prevVals.qty) $card.find(".qty").val(prevVals.qty);

            $card.find(".gabarit-width-flag").prop("checked", !!prevVals.gw);
            $card.find(".magnets").prop("checked", !!prevVals.mg);

            previewCard($card);
          }
        }catch(e){
          window.showToast("Не вдалося завантажити секції/тканини", "danger");
        }
      }
    });

    $container.on("click", ".remove-row", function(){
      $(this).closest(".item-card").remove();
      recalcOrderTotal();
    });

    $container.on("change", ".system-sheet", async function(){
      const $card = $(this).closest(".item-card");
      const system = $(this).val();

      $card.find(".table-section").empty().append('<option value="" selected disabled>— Оберіть колір системи —</option>');
      $card.find(".fabric").empty().append('<option value="">Спочатку оберіть колір системи…</option>');
      $card.find(".fabric_color").empty().append('<option value="">Спочатку оберіть колір системи…</option>');
      setCardBlockedUntilSection($card, true);

      if(!system) return;

      try{
        await loadSectionsForSystem(system);
        fillSectionsForCard($card, system, null);
      }catch(e){
        window.showToast("Не вдалося завантажити секції для системи", "danger");
      }
    });

    $container.on("change", ".table-section", async function(){
      const $card = $(this).closest(".item-card");
      const system  = $card.find(".system-sheet").val();
      const section = $(this).val();

      $card.find(".base,.surcharge,.magnets-price,.subtotal").text("0.00");
      if(!system || !section){
        setCardBlockedUntilSection($card, true);
        return;
      }
      await fillFabricsForCard($card, system, section, null);
    });

    $container.on("change keyup", ".fabric, .h-mm, .w-mm, .magnets", function(){
      previewCard($(this).closest(".item-card"));
    });

    $container.on("change keyup", ".qty", function(){
      const v = parseInt(this.value || "1", 10);
      if (isNaN(v) || v < 1) this.value = 1;
      previewCard($(this).closest(".item-card"));
    });

    $("#orderForm").on("submit", function(e){
      let ok = true;
      $container.find(".item-card").each(function(){
        const $c = $(this);
        const sys = $c.find(".system-sheet").val();
        const sec = $c.find(".table-section").val();
        const fab = $c.find(".fabric").val();
        const fabс = $c.find(".fabric_color").val();
        if(!sys || !sec || !fab){
          ok = false;
          if(!sys) $c.find(".system-sheet").addClass("is-invalid");
          if(!sec) $c.find(".table-section").addClass("is-invalid");
          if(!fab) $c.find(".fabric").addClass("is-invalid");
          if(!fabс) $c.find(".fabric_color").addClass("is-invalid");
        }else{
          $c.find(".system-sheet,.table-section,.fabric,.fabric_color").removeClass("is-invalid");
        }
      });
      if(!ok){
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: "smooth" });
        window.showToast("Оберіть систему, колір системи та тканину для кожної позиції", "warning");
      }
    });

    // ---------- Ініціалізація ----------
    (async function(){
      try{
        await loadSystems();
        $("#addRow").trigger("click");
      }catch(e){
        window.showToast("Не вдалося завантажити системи прайсу", "danger");
      }
    })();

    async function loadFabricColors(fabricName){
  const resp = await fetch(`/api/v1/pricing/fabric-colors?fabric=${encodeURIComponent(fabricName)}`);
  if (!resp.ok){
    const err = await resp.json().catch(()=>({detail:"Error"}));
    throw new Error(err.detail || "Не вдалося завантажити кольори тканини");
  }
  return resp.json();
}

function fillFabricColorsForCard($card, codes, preselect){
  const $sel = $card.find(".fabric-color");
  $sel.empty();
  $sel.append('<option value="" selected disabled>— Оберіть колір —</option>');
  (codes || []).forEach(code => {
    $sel.append(new Option(code, code));
  });
  if (preselect){
    $sel.val(preselect);
  }
}

  </script>
{% endblock %}
