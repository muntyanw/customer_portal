{% extends 'core/dashboard_base.html' %}
{% block dashboard_title %}
  Нове замовлення
{% endblock %}
{% block dashboard_heading %}
  Тканинні ролети замовлення №{{ order.id|default:'null' }}
{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Select2 CSS для "умных" селектов -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    .order-total-bar {
      position: sticky;
      bottom: 0;
      z-index: 1030;
      background: var(--bs-body-bg);
      border-top: 1px solid var(--bs-border-color);
    }
    .item-card .price-box .kv {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: var(--bs-secondary-color);
    }
    .item-card .price-box .sum {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-weight: 600;
      font-size: 1.05rem;
    }
    @media (min-width: 992px) {
      .item-card .controls-inline {
        display: flex;
        gap: 0.75rem;
      }
    }
  </style>
{% endblock %}

{% block dashboard_content %}
  <form method="post" id="orderForm" novalidate>
    {% csrf_token %}

    <div class="mb-3">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
        <div class="fw-semibold" style="display: none;">Джерело прайсу</div>
        <a href="{{ PRICE_SHEET_URL }}" target="_blank" class="small">Відкрити прайс</a>
      </div>
      <input type="url" class="form-control" id="priceUrl" name="price_url" value="{{ PRICE_SHEET_URL }}" required style="display: none;" />
    </div>

    <!-- Контейнер для карток позицій -->
    <div id="itemsContainer" class="d-flex flex-column gap-3"></div>

    <div class="d-grid mt-2">
      <button type="button" class="btn btn-outline-primary" id="addRow"><i class="bi bi-plus-lg me-1"></i> Додати позицію</button>
    </div>

    <!-- Підсумок по замовленню -->
    <div class="order-total-bar mt-3 p-3 rounded-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">Разом по замовленню, €</div>
        <div id="orderTotal" class="fs-5 fw-bold">0.00</div>
      </div>
    </div>

    <div class="d-grid mt-3">
      <button type="submit" class="btn btn-success btn-lg">Зберегти замовлення</button>
    </div>
  </form>

  {% include 'orders/_item_template.html' %}
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    // EN: Global builder context from Django
    // UA: Глобальний контекст білдера з Django
    const builderOrderId = {{ order.id|default:"null" }};
    const builderItems = {{ items_json|safe|default:"[]" }};

    const systemConfigCache = new Map() // system -> config
    // ---------- Helpers ----------
    function money(x) {
      return (Math.round(parseFloat(x || 0) * 100) / 100).toFixed(2)
    }
    
    function getCsrf() {
      const m = document.querySelector('meta[name="csrf-token"]')
      if (m && m.content) return m.content
      const match = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/)
      return match ? decodeURIComponent(match[1]) : ''
    }
    
    function itemTemplate(index) {
      const tpl = document.getElementById('item-template')
      const node = tpl.content.cloneNode(true)
      $(node)
        .find('.pos-index')
        .text(index + 1)
      $(node).find('[data-index]').attr('data-index', index)
      return node
    }
    
    // ---------- State / cache ----------
    const $container = $('#itemsContainer')
    const priceUrlInput = $('#priceUrl')
    
    let systemsCache = null // список вкладок (систем)
    let pricesCache = {}
    const sectionsCache = new Map() // key: system -> [sections]
    const fabricsCache = new Map() // key: system|section -> {fabrics, width_bands, magnets_price_eur}
    const fabricColorsCache = new Map()

    let debounceTimer
    function setEventsFromGabarits($card){
      $w_mm = $card.find('.w-mm')
      $h_mm = $card.find('.h-mm')
      $card.find('.h-mm, .w-mm, .qty, .gabarit-width-flag').prop('disabled', false)
      $card.find('.gabarit-width-flag').prop('disabled', false)
      $card.find('.h-mm, .w-mm').on('input', function () {
        clearTimeout(debounceTimer)
        debounceTimer = setTimeout(() => {
          if ($w_mm.val() && $h_mm.val()) {
            previewCard($card)
          }
        }, 600)
      })
      $card.find('.gabarit-width-flag').on('change', function () {
        if ($w_mm.val() && $h_mm.val()) {
          previewCard($card)
        }
      })
      
    }

    function removePriceOptions($card){
        priceOptions.forEach((nameOption, i) => {
            $card.find('.' + nameOption).remove()
        })
    }

    function clearCard($card){
      $card.find('.comment_system_red').html("")
      $card.find('.comment_system_green').html("")
      $card.find('.h-mm').val(0)
      $card.find('.w-mm').val(0)
      $card.find('.qty').val(1)
      removePriceOptions($card)
      recalcPrice()
    }


    async function changeSystemSheet($card){
        clearCard($card)
        const system = $card.find('.system-sheet').val()
      
        const $sec = $card.find('.table-section')
        const $fab = $card.find('.fabric')
        const $fabColor = $card.find('.fabric-color-code')
      
        $sec.empty().append('<option value="" selected disabled>— Оберіть колір системи —</option>')
        $fab.empty().append('<option value="">Спочатку оберіть колір системи…</option>')
        $fabColor.empty().append('<option value="">Спочатку оберіть колір системи…</option>')
      
        $sec.val(null).trigger('change')
        $fab.val(null).trigger('change')
        $fabColor.val(null).trigger('change')
      
        if (!system) return
      
        try {
          await loadSectionsForSystem(system)
          fillSectionsForCard($card, system, null)
        } catch (e) {
          window.showToast('Не вдалося завантажити секції для системи', 'danger')
        }
    }

    // ---------- Select2 init ----------
    function initSelectsForCard($card) {

      $card.find('.fabric').select2({
        width: '100%',
        dropdownParent: $card
      })

      const $table_section = $card.find('.table-section').select2({
        width: '100%',
        dropdownParent: $card
      })

      const $selectSys = $card.find('.system-sheet').select2({
        width: '100%',
        dropdownParent: $card
      })

      const $fabricColor = $card.find('.fabric-color-code').select2({
        width: '100%',
        dropdownParent: $card,
        tags: true,
        createTag: function (params) {
          const term = $.trim(params.term)
          if (term === '') {
            return null
          }
          return {
            id: term,
            text: term,
            newTag: true
          }
        }
      })
      
      $table_section.on('select2:select', function (e) {
        clearCard($card)
      })

      $fabricColor.on('select2:select', function (e) {

        setEventsFromGabarits($card)

        if (!changingProgrammatically) {
          if ($w_mm.val() && $h_mm.val()) {
            previewCard($card)
          }
        }
      })

      $selectSys.on('select2:select', function (e) {
        changeSystemSheet($card)
      })


    }
    
    async function loadSystems() {
      const url = priceUrlInput.val()
      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/systems-list?url=${encodeURIComponent(url)}`)
      hideGlobalLoader()
      if (!resp.ok) throw new Error('Cannot load systems')
      const data = await resp.json()
      systemsCache = data.systems || data.sheets || []
      return systemsCache
    }
    
    async function loadSectionsForSystem(system) {
      if (sectionsCache.has(system)) return sectionsCache.get(system)
    
      const url = priceUrlInput.val()
      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/system-fabrics?url=${encodeURIComponent(url)}&system=${encodeURIComponent(system)}`)
      hideGlobalLoader()
      if (!resp.ok) throw new Error('Cannot load sections')
      const data = await resp.json()
      const sections = data.sections || []
      sectionsCache.set(system, sections)
      return sections
    }
    
    async function loadFabricsForSection(system, section) {
      const key = `${system}|||${section}`
      if (fabricsCache.has(key)) return fabricsCache.get(key)
    
      const url = priceUrlInput.val()
      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/system-fabrics?url=${encodeURIComponent(url)}&system=${encodeURIComponent(system)}&section=${encodeURIComponent(section)}`)
      hideGlobalLoader()
      if (!resp.ok) throw new Error('Cannot load fabrics')
      const data = await resp.json()
      fabricsCache.set(key, data)
      return data
    }
    
    async function previewPrice({ url, system, section, fabric, fabric_color_code, h, w, gabaritWidth }) {
      $('.load_gif').show()
      showGlobalLoader()
      const resp = await fetch('/api/v1/pricing/system-preview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() },
        body: JSON.stringify({
          url,
          system_sheet: system,
          section_title: section,
          fabric_name: fabric,
          fabric_color_code: fabric_color_code,
          width_mm: w,
          gabarit_height_mm: h,
          gabarit_width_flag: gabaritWidth
        })
      })
      hideGlobalLoader()
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: 'Error' }))
        throw new Error(err.detail || 'Помилка розрахунку')
      }
      $('.load_gif').hide()
      return resp.json()
    }
    
    async function loadFabricColors(fabricName) {
      if (!fabricName) return { color_codes: [] }

      if (fabricColorsCache.has(fabricName)) {
        return fabricColorsCache.get(fabricName)
      }

      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/fabric-colors?fabric=${encodeURIComponent(fabricName)}`)
      hideGlobalLoader()
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: 'Error' }))
        throw new Error(err.detail || 'Не вдалося завантажити кольори тканини')
      }
      const data = await resp.json()
      fabricColorsCache.set(fabricName, data)
      return data
    }
    
    function fillFabricColorsForCard($card, codes, preselect) {
      const $sel = $card.find('.fabric-color-code')
      $sel.empty()
      $sel.append('<option value="" selected disabled>— Оберіть колір —</option>')
      ;(codes || []).forEach((code) => {
        $sel.append(new Option(code, code))
      })
      if (preselect) {
        $sel.val(preselect)
      } else {
        $sel.val(null)
      }
      $sel.trigger('change')
    }
    
    function setLoadingFabrics($card, isLoading) {
      const $fab = $card.find('.fabric')
      if (isLoading) {
        $fab.html('<option>Завантаження тканин…</option>').prop('disabled', true)
        $fab.trigger('change')
      }
    }
    
    async function fillSystems($card, preselectSystem) {
      const $sys = $card.find('.system-sheet')
      $sys.empty()
      $sys.append('<option value="" selected disabled>— Оберіть систему —</option>')
      ;(systemsCache || []).forEach((name) => {
        $sys.append(new Option(name, name))
      })
      if (preselectSystem && systemsCache && systemsCache.includes(preselectSystem)) {
        $sys.val(preselectSystem)
      } else {
        $sys.val(null)
      }
      $sys.trigger('change')
    }
    
    async function fillSectionsForCard($card, system, preselectSection) {
      const $sec = $card.find('.table-section')
      $sec.empty()
      $sec.append('<option value="" selected disabled>— Оберіть колір системи —</option>')
    
      const sections = sectionsCache.get(system) || []
      sections.forEach((s) => {
        const t = typeof s === 'string' ? s : s.title || 'Секція'
        $sec.append(new Option(t, t))
      })
    
      $sec.prop('disabled', false)
    
      if (preselectSection) {
        $sec.val(preselectSection)
      } else {
        $sec.val(null)
      }
      //$sec.trigger('change')
    }
    
    async function fillFabricsForCard($card, system, section, preselectFabric) {
      if (!system || !section) {
        return
      }
      setLoadingFabrics($card, true)
      try {
        const data = await loadFabricsForSection(system, section)
        const $fab = $card.find('.fabric')
        $fab.empty()
        ;(data.fabrics || []).forEach((f) => $fab.append(new Option(f.name, f.name)))
        if (preselectFabric) {
          $fab.val(preselectFabric)
        } else {
          $fab.val(null)
        }
        $fab.prop('disabled', false)
        $fab.trigger('change')
      } catch (e) {
        window.showToast('Не вдалося завантажити тканини для секції', 'danger')
      } finally {
        setLoadingFabrics($card, false)
      }
    }
    
    function readCardValues($card) {
      let qtyPriceOptions = {}
      priceOptions.forEach((optionName) => {
      qtyPriceOptions[optionName] = $card
          .find('[name="' + optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty") + '"]').val()
      });
      return {
        system: $card.find('.system-sheet').val() || '',
        section: $card.find('.table-section').val() || '',
        fabric: $card.find('.fabric').val() || '',
        fabric_color_code: $card.find('.fabric-color-code').val() || '',
        h: $card.find('.h-mm').val() || '',
        w: $card.find('.w-mm').val() || '',
        qty: $card.find('.qty').val() || '1',
        gw: $card.find('.gabarit-width-flag').is(':checked'),
        qtyPriceOptions:qtyPriceOptions
      }
    }
    
    async function previewCard($card, preSelectsPriceOptions = {}) {
      const url = priceUrlInput.val()
      const system = $card.find('.system-sheet').val()
      const section = $card.find('.table-section').val()
      const fabric = $card.find('.fabric').val()
      const fabric_color_code = $card.find('.fabric-color-code').val()
      const h = parseInt($card.find('.h-mm').val() || '0', 10)
      const w = parseInt($card.find('.w-mm').val() || '0', 10)
      const magnets = $card.find('.magnets').is(':checked')
      const gabaritWidth = $card.find('.gabarit-width-flag').is(':checked')
      const qty = Math.max(1, parseInt($card.find('.qty').val() || '1', 10))
    
      if (!system || !section || !fabric || !fabric_color_code || !h || !w) {
        return
      }
    
      try {
        const data = await previewPrice({ url, system, section, fabric, fabric_color_code, h, w, gabaritWidth })
        pricesCache[$card.find('.pos-index')] = data
        renderPriceOptions($card, preSelectsPriceOptions)
      } catch (err) {
        $card.find('.h-mm').val(0)
        $card.find('.w-mm').val(0)
        window.showToast(err.message || 'Помилка розрахунку', 'danger')
      }
    }
    
    function copySelectOptionsFromPrevCard($card, selectClass) {
      const $prev = $card.prev('.item-card')
      if ($prev.length === 0) {
        console.warn('No previous .item-card found!')
        return
      }
      const $currentSelect = $card.find(selectClass)
      const $prevSelect = $prev.find(selectClass)
      if ($currentSelect.length === 0 || $prevSelect.length === 0) {
        console.warn('Select not found in one of cards')
        return
      }
      const optionsHtml = $prevSelect.html()
      $currentSelect.html(optionsHtml)
      const prevValue = $prevSelect.val()
      $currentSelect.val(prevValue)
      $currentSelect.trigger('change')
    }

    let changingProgrammatically = false
    
    async function addRowWithData(item) {
      const idx = $container.children().length
      $container.append(itemTemplate(idx))
      const $card = $container.find('.item-card').last()

      changingProgrammatically = true      

      initSelectsForCard($card)

      await fillSystems($card, item.system_sheet)
      await loadSectionsForSystem(item.system_sheet)
      await fillSectionsForCard($card, item.system_sheet, item.table_section)
      await fillFabricsForCard($card, item.system_sheet, item.table_section, item.fabric_name)

      // 3) Колір тканини
      if (item.fabric_name) {
        try {
          const data = await loadFabricColors(item.fabric_name)
          await fillFabricColorsForCard($card, data.color_codes || [], item.fabric_color_code || null)
        } catch (e) {
          window.showToast(e.message || 'Не вдалося завантажити кольори тканини', 'danger')
          await fillFabricColorsForCard($card, [], item.fabric_color_code || null)
        }
      }

      /// 3) размеры
      if (item.height_gabarit_mm) $card.find('.h-mm').val(item.height_gabarit_mm)
      if (item.width_fabric_mm) $card.find('.w-mm').val(item.width_fabric_mm)

      if (item.gabarit_width_flag) {
        $card.find('.gabarit-width-flag .form-check-input').prop('checked', true)
      }

      // 5) количество
      $card.find('.qty').val(item.quantity || 1)

      setEventsFromGabarits($card)
      let preSelectsPriceOptions = {}
      priceOptions.forEach((optionName, index) => {
          let qty = item[optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")]
          if(qty){
            preSelectsPriceOptions[optionName] = qty
          }
      });

      await previewCard($card, preSelectsPriceOptions)

      changingProgrammatically = false

    }

    $('#addRow').on('click', async function () {
      const $prev = $container.find('.item-card').last()
      const prevVals = $prev.length ? readCardValues($prev) : null
    
      const idx = $container.children().length
      $container.append(itemTemplate(idx))
      const $card = $container.find('.item-card').last()
    
      initSelectsForCard($card)
    
      if (!systemsCache) {
          try {
              await loadSystems()
          } catch (e) {
              window.showToast('Не вдалося завантажити системи прайсу', 'danger')
              return
          }
      }
      fillSystems($card, prevVals?.system)
    
      if (prevVals && prevVals.system) {
        try {
          await loadSectionsForSystem(prevVals.system)
          fillSectionsForCard($card, prevVals.system, prevVals.section)
    
          if (prevVals.section) {
            await fillFabricsForCard($card, prevVals.system, prevVals.section, prevVals.fabric)
    
            if (prevVals.fabric_color_code) {
              copySelectOptionsFromPrevCard($card, ".fabric-color-code")
              $card.find('.h-mm, .w-mm, .qty, .gabarit-width-flag').prop('disabled', false)
              $card.find('.gabarit-width-flag .form-check-input').prop('disabled', false)
            }
    
            if (prevVals.h) $card.find('.h-mm').val(prevVals.h)
            if (prevVals.w) $card.find('.w-mm').val(prevVals.w)
            if (prevVals.qty) $card.find('.qty').val(prevVals.qty)
    
            $card.find('.gabarit-width-flag .form-check-input').prop('checked', !prevVals.gw)
            
            {% comment %} let preSelectsPriceOptions = {}
            for (let optionName in prevVals.qtyPriceOptions) {
                let qty = prevVals.qtyPriceOptions[optionName];
                if(qty){
                  reSelectsPriceOptions[optionName] = qty
                }
            } {% endcomment %}

            await previewCard($card, prevVals.qtyPriceOptions)

          }
        } catch (e) {
          window.showToast('Не вдалося завантажити секції/тканини', 'danger')
        }
      }
    })
    
    $container.on('click', '.remove-row', function () {
      $(this).closest('.item-card').remove()
      recalcPrice()
    })
    
    $container.on('change keyup', '.qty', function () {
      const v = parseInt(this.value || '1', 10)
      if (isNaN(v) || v < 1) this.value = 1
      renderPriceOptions($(this).closest('.item-card'))
    })

    let priceOptions = [
      "magnets_price_eur",
      "cord_pvc_tension_price_eur",
      "cord_copper_barrel_price_eur",
      "top_pvc_clip_pair_price_eur",
      "top_pvc_bar_tape_price_eur_mp",
      "bottom_wide_bar_price_eur_mp",     
      "top_bar_scotch_price_eur",     
      "metal_kronsht_price_eur",
      "metal_cord_fix_price_eur"     

    ]

    let priceOptionTexts = [
      "Фіксація магнітами",
      "Фіксація Леска ПВХ з дотяжкою (шт)",
      "Фіксація Леска з мідною діжкою (шт)",
      "Кліпса кріплення для верхньої планки ПВХ, пара",
      "Доплата за верхню планку ПВХ зі скотчем (монтаж без свердління), за м.п.",
      "Доплата за широку нижню планку 10/28, за м.п.",     
      "Скотч на верхню планку для встановлення без свердління, за м.п.",     
      "Доплата за металеві кронштейни, шт",
      "Фіксація лески металева"
    ]
    
    function recalcPrice() {
      let sumTotal = 0
      $('.item-card').each(function (i, card) {
        const $card = $(card)
        let sum = 0
        const gb_width_mm = Number($card.find('.gb_width_mm').val()) || 0

        sum += Number($card.find('.base').text() || 0) + Number($card.find('.surcharge').text() || 0)

        priceOptions.forEach((nameOption) => {
          const optionQtyName = nameOption.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
          const optionQty = Number($card.find('[name="' + optionQtyName + '"]').val())
          if(optionQty>0){
            //if(!nameOption.includes("_mp")){
                sum += Number($card.find(`.price-options-manifest .${nameOption} .price`).val()) || 0
            //}else{
                //sum += Number($card.find('.price-options-manifest .${nameOption} .price').val()  * (gb_width_mm/1000))
            //}
          }
        })
        
        $card.find('.subtotal-input').text(money(sum))
        sumTotal += sum
      })
      
      $('#orderTotal').text(money(Number(sumTotal)))
    }

    function checkPriceOption(el, optionName, optionVal) {
        const $el = $(el);
        const $card = $el.closest('.item-card');         // карточка
        const $block = $el.closest('.op-card');          // конкретная опция
        const $hidden = $block.find('.price-hidden');    // скрытый input
        const $hiddenQty = $block.find('.qty-hidden');    // скрытый input
        const $priceEl = $block.find(`.${optionName} .price`);          // span с ценой
        const $priceMan = $card.find(`.price-options-manifest .${optionName} .price`);          // span с ценой

        if (el.checked) {
            const price = money(Number(optionVal));
            $hidden.val(price);
            $hiddenQty.val(1);
            $priceEl.text(price);
            const gb_width_mm = Number($card.find('.gb_width_mm').val()) || 0
            if(optionName.includes("_mp")){
                $priceMan.text(money(Number(price * (gb_width_mm/1000))))
            }else{
                $priceMan.text(price)
            }
            
        } else {
            $hidden.val(0);
            $hiddenQty.val(0);
            $priceEl.text(0);
            $priceMan.text(0);
        }

        recalcPrice()
    }


    function renderOnePriceOption($card, data, optionName,  i, preSelectsPriceOptions = {}){

      const optionQtyName = optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
      const optionPrice = data[optionName]
      let optionQty = data[optionQtyName]
      const gb_width_mm = Number($card.find('.gb_width_mm').val()) || 0
      if (optionPrice) {

        let check = ""
        let price = 0

        if (optionQty || preSelectsPriceOptions[optionName]) {
          check = 'checked'
          
          if(optionName.includes("_mp")){
              price = money(Number(optionPrice * (gb_width_mm/1000)))
          }else{
              price = money(Number(optionPrice))
          }
          optionQty = 1
        }

        if ($card.find('.' + optionName).length === 0) {
            $card.find('.op-card-list').append(
                `<div class="form-check op-card ${optionName}">` 
                + `<input class="form-check-input price-option" type="checkbox" onchange="checkPriceOption(this, '${optionName}', ${money(Number(optionPrice))})" ${check} />`
                + `<label class="form-check-label">` 
                + priceOptionTexts[i] 
                + ` (<span class="price">${money(Number(optionPrice))}</span> грн)` 
                + `</label><input class="price-hidden" type="hidden" name="${optionName}" value="${price}" />`
                + `</label><input class="qty-hidden" type="hidden" name="${optionQtyName}" value="${optionQty}" />`
                + `</div>`
            );

            $card.find('.price-options-manifest').append(
                  `<div class="kv ${optionName}">`
                + `<span>${priceOptionTexts[i]}</span><span class="price">${price}</span>` 
                + `</div>`
            );
        }else{
          if(optionQty || preSelectsPriceOptions[optionName]){
              $card.find(`[name="${optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")}"]`).val(1)
              $card.find(`.${optionName} .form-check-input`).prop('checked', true)
              $card.find(`.price-options-manifest .${optionName} .price`).val(price)
          }
        }
      }
    }
    
    function renderPriceOptions($card, preSelectsPriceOptions = {}) {
      let numberCard = $card.find('.pos-index')
      let data = pricesCache[numberCard]
      if(!data){
        previewCard($card)
        return
      }

      if(data.comment_system_red){
        $card.find('.comment_system_red').html(data.comment_system_red)
      }
      if(data.comment_system_green){
        $card.find('.comment_system_green').html(data.comment_system_green)
      }

      if(data.GbDiffWidthMm){
        $card.find('.gabarit-width-flag').show()
        $card.find('.gabarit-width-flag .form-check-input').prop('disabled', false)
      }else{
        $card.find('.gabarit-width-flag .form-check-input').hide()
        $card.find('.gabarit-width-flag .form-check-input').prop('disabled', true)
      }

      let qty = $card.find('.qty').val()
      let addMoney = 0
    
      $card.find('.base').text(money(Number(data.base_price_eur || 0) * qty))
      $card.find('.base-input').text(money(Number(data.base_price_eur || 0) * qty))
      $card.find('.surcharge').text(money(Number(data.surcharge_height_eur || 0) * qty))
      $card.find('.surcharge-input').text(money(Number(data.surcharge_height_eur || 0) * qty))
      $card.find('.gb_width_mm').val((Number(data.gb_width_mm || 0)))
    
      priceOptions.forEach((nameOption, i) => {
          renderOnePriceOption($card, data, nameOption, i, preSelectsPriceOptions);
      });

      recalcPrice()
    }
       
    
    $container.on('change', '.table-section', async function () {
      const $card = $(this).closest('.item-card')
      const system = $card.find('.system-sheet').val()
      const section = $(this).val()
    
      $card.find('.base,.surcharge,.magnets-price,.subtotal').text('0.00')
      if (!system || !section) {
        return
      }
      await fillFabricsForCard($card, system, section, null)
    })

    $container.on('select2:select', '.fabric', async function (event) {

      const $card = $(this).closest('.item-card')
      const fabric = $(this).val()
    
      if (!fabric) {
        fillFabricColorsForCard($card, [], null)
        return
      }
    
      try {
        const data = await loadFabricColors(fabric)
        fillFabricColorsForCard($card, data.color_codes || [], null)
      } catch (e) {
        window.showToast(e.message || 'Не вдалося завантажити кольори тканини', 'danger')
        fillFabricColorsForCard($card, [], null)
      }
    
      previewCard($card)
    })
    
    $('#orderForm').on('submit', function (e) {
      let ok = true
      $container.find('.item-card').each(function () {
        const $c = $(this)
        const sys = $c.find('.system-sheet').val()
        const sec = $c.find('.table-section').val()
        const fab = $c.find('.fabric').val()
        const fabc = $c.find('.fabric-color-code').val()
    
        if (!sys || !sec || !fab || !fabc) {
          ok = false
          if (!sys) $c.find('.system-sheet').addClass('is-invalid')
          if (!sec) $c.find('.table-section').addClass('is-invalid')
          if (!fab) $c.find('.fabric').addClass('is-invalid')
          if (!fabc) $c.find('.fabric-color-code').addClass('is-invalid')
        } else {
          $c.find('.system-sheet,.table-section,.fabric,.fabric-color-code').removeClass('is-invalid')
        }
      })
      if (!ok) {
        e.preventDefault()
        window.scrollTo({ top: 0, behavior: 'smooth' })
        window.showToast('Оберіть систему, колір системи, тканину та колір тканини для кожної позиції', 'warning')
      }
    })
    
     // ---------- Ініціалізація ----------
    ;(async function () {
      try {
        await loadSystems()

        if (Array.isArray(builderItems) && builderItems.length > 0) {
          // UA: Режим редагування існуючого замовлення
          // EN: Edit mode – restore existing items
          for (const item of builderItems) {
            await addRowWithData(item)
          }
          recalcPrice()
        } else {
          // UA: Нове замовлення — одна порожня позиція
          // EN: New order – start with single empty card
          $('#addRow').trigger('click')
        }
      } catch (e) {
        console.error(e)
        window.showToast('Не вдалося завантажити системи прайсу', 'danger')
      }
    })()
  </script>
{% endblock %}
