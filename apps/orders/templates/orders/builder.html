{% extends 'core/dashboard_base.html' %}
{% block dashboard_title %}
  Нове замовлення
{% endblock %}
{% block dashboard_heading %}
  Тканинні ролети замовлення №{{ order.id|default:'null' }}
{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Select2 CSS для "умных" селектов -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    .order-total-bar {
      position: sticky;
      bottom: 0;
      z-index: 1030;
      background: var(--bs-body-bg);
      border-top: 1px solid var(--bs-border-color);
    }
    .item-card .price-box .kv {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: var(--bs-secondary-color);
    }
    .item-card .price-box .sum {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-weight: 600;
      font-size: 1.05rem;
    }
    @media (min-width: 992px) {
      .item-card .controls-inline {
        display: flex;
        gap: 0.75rem;
      }
    }
  </style>
{% endblock %}

{% block dashboard_content %}
  <form method="post" id="orderForm" novalidate>
    {% csrf_token %}
    <input type="hidden" name="eur_rate_at_creation" class="eur_rate_at_creation" />

    <div class="mb-3">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
        <div class="fw-semibold" style="display: none;">Джерело прайсу</div>
        <a href="{{ PRICE_SHEET_URL }}" target="_blank" class="small">Відкрити прайс</a>
      </div>
      <input type="url" class="form-control" id="priceUrl" name="price_url" value="{{ PRICE_SHEET_URL }}" required style="display: none;" />
    </div>

    <!-- Контейнер для карток позицій -->
    <div id="itemsContainer" class="d-flex flex-column gap-3"></div>

    <div class="d-grid mt-2">
      <button type="button" class="btn btn-outline-primary" id="addRow"><i class="bi bi-plus-lg me-1"></i> Додати позицію</button>
    </div>

    <!-- Підсумок по замовленню -->
    <div class="order-total-bar mt-3 p-3 rounded-3 shadow-sm">
      <div class="d-flex justify-content-between align-items-center">
        <div class="fw-semibold">Разом по замовленню</div>
        <div class="text-end">
          <div class="fs-6" style="display:none;">
            <span id="orderTotal">0.00</span>
          </div>
          <div class="">
            <span id="orderTotalUah">0.00</span>
          </div>
        </div>
      </div>
    </div>

    <div class="d-grid mt-3">
      <button type="submit" class="btn btn-success btn-lg">Зберегти замовлення</button>
    </div>
  </form>

  {% include 'orders/_item_template.html' %}
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    // EN: Global builder context from Django
    // UA: Глобальний контекст білдера з Django
    const builderOrderId = {{ order.id|default:"null" }}
    const builderItems = {{ items_json|safe|default:"[]" }}
    const eur_rate = parseFloat(
      '{{ eur_rate|default:"0.00" }}'
        .replace(/\s/g, '')
        .replace(',', '.')
    )

    const systemConfigCache = new Map() // system -> config

    // ---------- Helpers ----------
    function money(x) {
      return (Math.round(parseFloat(x || 0) * 100) / 100).toFixed(2)
    }

    // UA: Конвертація EUR → UAH (тільки для фронта)
    // EN: EUR → UAH conversion (frontend-only)
    function eurToUahRaw(x) {
      return Number(x || 0) * Number(eur_rate || 0)
    }
    function eurToUah(x) {
      return money(eurToUahRaw(x))
    }

    // UA: Записуємо курс, який піде на бекенд
    // EN: Save rate that will be sent to backend
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.eur_rate_at_creation').forEach(function (el) {
        el.value = eur_rate
      })
    })

    function getCsrf() {
      const m = document.querySelector('meta[name="csrf-token"]')
      if (m && m.content) return m.content
      const match = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/)
      return match ? decodeURIComponent(match[1]) : ''
    }

    function itemTemplate(index) {
      const tpl = document.getElementById('item-template')
      const node = tpl.content.cloneNode(true)
      $(node)
        .find('.pos-index')
        .text(index + 1)
      $(node).find('[data-index]').attr('data-index', index)
      return node
    }

    const $container = $('#itemsContainer')
    const priceUrlInput = $('#priceUrl')

    let systemsCache = null
    let pricesCache = {}
    const sectionsCache = new Map() 
    const fabricsCache = new Map() 
    const fabricColorsCache = new Map()

    let debounceTimer
    function setEventsFromGabarits($card) {
      const $w_mm = $card.find('.w-mm')
      const $h_mm = $card.find('.h-mm')

      $card.find('.h-mm, .w-mm, .qty, .gabarit-width-flag').prop('disabled', false)
      $card.find('.gabarit-width-flag .form-check-input').prop('disabled', false)

      function setDebounce(fn) {
        const prevTimer = $card.data('gabaritsDebounceTimer')
        if (prevTimer) {
          clearTimeout(prevTimer)
        }
        const t = setTimeout(fn, 600)
        $card.data('gabaritsDebounceTimer', t)
      }

      $card.find('.h-mm, .w-mm')
        .off('input.gabarits')
        .on('input.gabarits', function () {
          setDebounce(() => {
            if (Number($w_mm.val()) > 0 && Number($h_mm.val()) > 0) {
              previewCard($card)
            }
          })
        })

      $card.find('.gabarit-width-flag .form-check-input')
        .off('change.gabarits')
        .on('change.gabarits', function () {
          if (Number($w_mm.val()) > 0 && Number($h_mm.val()) > 0) {
            previewCard($card)
          }
        })
    }


    // UA: Прибирає всі додаткові опції з картки (і чекбокси, і рядки в таблиці)
    // EN: Remove all extra options from card (option cards + table rows)
    function removePriceOptions($card) {
      // 1) карточки с чекбоксами
      priceOptionsConfig.forEach((option) => {
        $card.find('.op-card.' + option.key).remove()
      })

      // 2) строки в таблице манифеста
      priceOptionsConfig.forEach((option) => {
        $card.find('.price-options-manifest .' + option.key + '-row').remove()
      })
    }

    // UA: Повністю очищає картку позиції (без видалення самої позиції)
    // EN: Fully reset card state (without removing the card itself)
    function clearCard($card) {
      // комментарии
      $card.find('.comment_system_red').empty()
      $card.find('.comment_system_green').empty()

      // габариты и количество
      $card.find('.h-mm').val(0)
      $card.find('.w-mm').val(0)
      $card.find('.qty').val(1)
      $card.find('.gb_width_mm').val(0)

      // базовые цены в price-box (EUR + UAH)
      const $priceBox = $card.find('.price-box')
      $priceBox.find('.base').text('0.00')
      $priceBox.find('.base-uah').text('0.00')
      $priceBox.find('.surcharge').text('0.00')
      $priceBox.find('.surcharge-uah').text('0.00')
      $priceBox.find('.subtotal-input').text('0.00')
      $priceBox.find('.subtotal-uah').text('0.00')

      // скрытые поля для базы/надбавки/итога (на бекенд идут только EUR)
      $card.find('input[name="base_price_eur"]').val('0')
      $card.find('input[name="surcharge_height_eur"]').val('0')
      $card.find('input[name="subtotal_eur"]').val('0')

      // все дополнительные опции (карточки + строки в таблице)
      removePriceOptions($card)

      // пересчёт общего итога
      recalcPrice()
    }


    async function changeSystemSheet($card){
        clearCard($card)
        const system = $card.find('.system-sheet').val()

        const $sec = $card.find('.table-section')
        const $fab = $card.find('.fabric')
        const $fabColor = $card.find('.fabric-color-code')

        $sec.empty().append('<option value="" selected disabled>— Оберіть колір системи —</option>')
        $fab.empty().append('<option value="">Спочатку оберіть колір системи…</option>')
        $fabColor.empty().append('<option value="">Спочатку оберіть колір системи…</option>')

        $sec.val(null).trigger('change')
        $fab.val(null).trigger('change')
        $fabColor.val(null).trigger('change')

        if (!system) return

        try {
          let data = await loadSectionsForSystem(system)
          if(data.exist_control_side){
            $card.find('.control_side').removeClass('d-none')
          }else{
            $card.find('.control_side').addClass('d-none')
          }
          enableCheckGabarit($card, data.GbDiffWidthMm, false)
          fillSectionsForCard($card, system, null)
        } catch (e) {
          window.showToast('Не вдалося завантажити секції для системи', 'danger')
        }
    }

    // ---------- Select2 init ----------
    function initSelectsForCard($card) {

      $card.find('.fabric').select2({
        width: '100%',
        dropdownParent: $card
      })

      const $table_section = $card.find('.table-section').select2({
        width: '100%',
        dropdownParent: $card
      })

      const $selectSys = $card.find('.system-sheet').select2({
        width: '100%',
        dropdownParent: $card
      })

      const $fabricColor = $card.find('.fabric-color-code').select2({
        width: '100%',
        dropdownParent: $card,
        tags: true,
        createTag: function (params) {
          const term = $.trim(params.term)
          if (term === '') {
            return null
          }
          return {
            id: term,
            text: term,
            newTag: true
          }
        }
      })

      $table_section.on('select2:select', function (e) {
        clearCard($card)
      })

      $fabricColor.on('select2:select', function (e) {

        setEventsFromGabarits($card)

        if (!changingProgrammatically) {
          if (Number($w_mm.val()) > 0 && Number($h_mm.val()) > 0) {
            previewCard($card)
          }
        }
      })

      $selectSys.on('select2:select', function (e) {
        changeSystemSheet($card)
      })


    }

    async function loadSystems() {
      const url = priceUrlInput.val()
      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/systems-list?url=${encodeURIComponent(url)}`)
      hideGlobalLoader()
      if (!resp.ok) throw new Error('Cannot load systems')
      const data = await resp.json()
      systemsCache = data.systems || data.sheets || []
      return systemsCache
    }

    async function loadSectionsForSystem(system) {
      if (sectionsCache.has(system)) return sectionsCache.get(system)

      const url = priceUrlInput.val()
      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/system-fabrics?url=${encodeURIComponent(url)}&system=${encodeURIComponent(system)}`)
      hideGlobalLoader()
      if (!resp.ok) throw new Error('Cannot load sections')
      const data = await resp.json()
      const sections = data.sections || []
      sections.GbDiffWidthMm = data.GbDiffWidthMm
      sections.exist_control_side = data.exist_control_side
      sectionsCache.set(system, sections)
      return sections
    }

    async function loadFabricsForSection(system, section) {
      const key = `${system}|||${section}`
      if (fabricsCache.has(key)) return fabricsCache.get(key)

      const url = priceUrlInput.val()
      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/system-fabrics?url=${encodeURIComponent(url)}&system=${encodeURIComponent(system)}&section=${encodeURIComponent(section)}`)
      hideGlobalLoader()
      if (!resp.ok) throw new Error('Cannot load fabrics')
      const data = await resp.json()
      fabricsCache.set(key, data)
      return data
    }

    async function previewPrice({ url, system, section, fabric, fabric_color_code, h, w, gabarit_width_flag }) {
      $('.load_gif').show()
      showGlobalLoader()
      const resp = await fetch('/api/v1/pricing/system-preview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() },
        body: JSON.stringify({
          url,
          system_sheet: system,
          section_title: section,
          fabric_name: fabric,
          fabric_color_code: fabric_color_code,
          width_mm: w,
          gabarit_height_mm: h,
          gabarit_width_flag: gabarit_width_flag
        })
      })
      hideGlobalLoader()
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: 'Error' }))
        throw new Error(err.detail || 'Помилка розрахунку')
      }
      $('.load_gif').hide()
      return resp.json()
    }

    async function loadFabricColors(fabricName) {
      if (!fabricName) return { color_codes: [] }

      if (fabricColorsCache.has(fabricName)) {
        return fabricColorsCache.get(fabricName)
      }

      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/fabric-colors?fabric=${encodeURIComponent(fabricName)}`)
      hideGlobalLoader()
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: 'Error' }))
        throw new Error(err.detail || 'Не вдалося завантажити кольори тканини')
      }
      const data = await resp.json()
      fabricColorsCache.set(fabricName, data)
      return data
    }

    function fillFabricColorsForCard($card, codes, preselect) {
      const $sel = $card.find('.fabric-color-code')
      $sel.empty()
      $sel.append('<option value="" selected disabled>— Оберіть колір —</option>')
      ;(codes || []).forEach((code) => {
        $sel.append(new Option(code, code))
      })
      if (preselect) {
        $sel.val(preselect)
      } else {
        $sel.val(null)
      }
      $sel.trigger('change')
    }

    function setLoadingFabrics($card, isLoading) {
      const $fab = $card.find('.fabric')
      if (isLoading) {
        $fab.html('<option>Завантаження тканин…</option>').prop('disabled', true)
        $fab.trigger('change')
      }
    }

    async function fillSystems($card, preselectSystem) {
      const $sys = $card.find('.system-sheet')
      $sys.empty()
      $sys.append('<option value="" selected disabled>— Оберіть систему —</option>')
      ;(systemsCache || []).forEach((name) => {
        $sys.append(new Option(name, name))
      })
      if (preselectSystem && systemsCache && systemsCache.includes(preselectSystem)) {
        $sys.val(preselectSystem)
      } else {
        $sys.val(null)
      }
      $sys.trigger('change')
    }

    async function fillSectionsForCard($card, system, preselectSection) {
      const $sec = $card.find('.table-section')
      $sec.empty()
      $sec.append('<option value="" selected disabled>— Оберіть колір системи —</option>')

      const sections = sectionsCache.get(system) || []
      sections.forEach((s) => {
        const t = typeof s === 'string' ? s : s.title || 'Секція'
        $sec.append(new Option(t, t))
      })

      $sec.prop('disabled', false)

      if (preselectSection) {
        $sec.val(preselectSection)
      } else {
        $sec.val(null)
      }
      //$sec.trigger('change')
    }

    async function fillFabricsForCard($card, system, section, preselectFabric) {
      if (!system || !section) {
        return
      }
      setLoadingFabrics($card, true)
      try {
        const data = await loadFabricsForSection(system, section)
        const $fab = $card.find('.fabric')
        $fab.empty().append('<option value="" selected disabled>— Оберіть тканину —</option>')
        ;(data.fabrics || []).forEach((f) => $fab.append(new Option(f.name, f.name)))
        if (preselectFabric) {
          $fab.val(preselectFabric)
        } else {
          $fab.val(null)
        }
        $fab.prop('disabled', false)
        $fab.trigger('change')
      } catch (e) {
        window.showToast('Не вдалося завантажити тканини для секції', 'danger')
      } finally {
        setLoadingFabrics($card, false)
      }
    }

    function readCardValues($card) {
      let qtyPriceOptions = {}
      priceOptionsConfig.forEach((option) => {
        let optionQtyName = option.key.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
        let qty = $card.find('[name="' + optionQtyName + '"]').val()
        if(qty!=undefined){
          qtyPriceOptions[optionQtyName] = $card.find('[name="' + optionQtyName + '"]').val()
        }
      });
      return {
        system: $card.find('.system-sheet').val() || '',
        section: $card.find('.table-section').val() || '',
        fabric: $card.find('.fabric').val() || '',
        fabric_color_code: $card.find('.fabric-color-code').val() || '',
        //h: $card.find('.h-mm').val() || '',
        //w: $card.find('.w-mm').val() || '',
        qty: $card.find('.qty').val() || '1',
        //gw: $card.find('.gabarit-width-flag .form-check-input').is(':checked'),
        control_side_exist: !$card.find('.control_side select').hasClass("d-none"),
        control_side: $card.find('.control_side select').val(),
        qtyPriceOptions:qtyPriceOptions
      }
    }

    async function previewCard($card, preSelectsPriceOptions = {}) {
      const url = priceUrlInput.val()
      const system = $card.find('.system-sheet').val()
      const section = $card.find('.table-section').val()
      const fabric = $card.find('.fabric').val()
      const fabric_color_code = $card.find('.fabric-color-code').val()
      const h = parseInt($card.find('.h-mm').val() || '0', 10)
      const w = parseInt($card.find('.w-mm').val() || '0', 10)
      const magnets = $card.find('.magnets').is(':checked')
      const gabarit_width_flag = $card.find('.gabarit-width-flag .form-check-input').is(':checked')
      const qty = Math.max(1, parseInt($card.find('.qty').val() || '1', 10))

      if(Object.keys(preSelectsPriceOptions).length > 0){
        renderPriceOptions($card, 0, preSelectsPriceOptions)
        return
      }

      if (!system || !section || !fabric || !fabric_color_code || !h || !w) {
        return
      }

      try {
        const data = await previewPrice({ url, system, section, fabric, fabric_color_code, h, w, gabarit_width_flag })
        pricesCache[$card.find('.pos-index')] = data
        renderPriceOptions($card, 0, preSelectsPriceOptions)
      } catch (err) {
        $card.find('.h-mm').val(0)
        $card.find('.w-mm').val(0)
        window.showToast(err.message || 'Помилка розрахунку', 'danger')
      }
    }

    function copySelectOptionsFromPrevCard($card, selectClass) {
      const $prev = $card.prev('.item-card')
      if ($prev.length === 0) {
        console.warn('No previous .item-card found!')
        return
      }
      const $currentSelect = $card.find(selectClass)
      const $prevSelect = $prev.find(selectClass)
      if ($currentSelect.length === 0 || $prevSelect.length === 0) {
        console.warn('Select not found in one of cards')
        return
      }
      const optionsHtml = $prevSelect.html()
      $currentSelect.html(optionsHtml)
      const prevValue = $prevSelect.val()
      $currentSelect.val(prevValue)
      $currentSelect.trigger('change')
    }

    let changingProgrammatically = false

    async function addRowWithData(item) {
      const idx = $container.children().length
      $container.append(itemTemplate(idx))
      const $card = $container.find('.item-card').last()

      changingProgrammatically = true

      initSelectsForCard($card)

      await fillSystems($card, item.system_sheet)
      await loadSectionsForSystem(item.system_sheet)
      await fillSectionsForCard($card, item.system_sheet, item.table_section)
      await fillFabricsForCard($card, item.system_sheet, item.table_section, item.fabric_name)

      // 3) Колір тканини
      if (item.fabric_name) {
        try {
          const data = await loadFabricColors(item.fabric_name)
          await fillFabricColorsForCard($card, data.color_codes || [], item.fabric_color_code || null)
        } catch (e) {
          window.showToast(e.message || 'Не вдалося завантажити кольори тканини', 'danger')
          await fillFabricColorsForCard($card, [], item.fabric_color_code || null)
        }
      }

      /// 3) размеры
      if (item.height_gabarit_mm) $card.find('.h-mm').val(item.height_gabarit_mm)
      if (item.width_fabric_mm) $card.find('.w-mm').val(item.width_fabric_mm)
      if(item.control_side){
        $card.find('.control_side').removeClass("d-none")
        if (item.control_side) $card.find('.control_side select').val(item.control_side)
      }else{
        $card.find('.control_side').addClass("d-none")
      }
      

      // 5) количество
      $card.find('.qty').val(item.quantity || 1)

      setEventsFromGabarits($card)
      let preSelectsPriceOptions = {}
      priceOptionsConfig.forEach((option, index) => {
          let price = item[option.key]
          let qty = item[option.key.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")]
          if(qty){
            preSelectsPriceOptions[option.key] = price
            preSelectsPriceOptions[option.key.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")] = qty
          }
      });

      preSelectsPriceOptions.base_price_eur = item.base_price_eur
      preSelectsPriceOptions.comment_system_red = ""
      preSelectsPriceOptions.comment_system_green = ""
      preSelectsPriceOptions.gb_width_mm = item.gb_width_mm
      preSelectsPriceOptions.GbDiffWidthMm = item.GbDiffWidthMm


      preSelectsPriceOptions.gabarit_width_flag = item.gabarit_width_flag

      await previewCard($card, preSelectsPriceOptions)

      changingProgrammatically = false

    }

    $('#addRow').on('click', async function () {
      const $prev = $container.find('.item-card').last()
      const prevVals = $prev.length ? readCardValues($prev) : null

      const idx = $container.children().length
      $container.append(itemTemplate(idx))
      const $card = $container.find('.item-card').last()

      initSelectsForCard($card)

      if (!systemsCache) {
          try {
              await loadSystems()
          } catch (e) {
              window.showToast('Не вдалося завантажити системи прайсу', 'danger')
              return
          }
      }
      fillSystems($card, prevVals?.system)

      if (prevVals && prevVals.system) {
        try {
          await loadSectionsForSystem(prevVals.system)
          fillSectionsForCard($card, prevVals.system, prevVals.section)

          if (prevVals.section) {
            await fillFabricsForCard($card, prevVals.system, prevVals.section, prevVals.fabric)

            if (prevVals.fabric_color_code) {
              copySelectOptionsFromPrevCard($card, ".fabric-color-code")
              $card.find('.h-mm, .w-mm, .qty, .gabarit-width-flag').prop('disabled', false)
              $card.find('.gabarit-width-flag .form-check-input').prop('disabled', false)
            }

            //if (prevVals.h) $card.find('.h-mm').val(prevVals.h)
            //if (prevVals.w) $card.find('.w-mm').val(prevVals.w)
            if (prevVals.qty) $card.find('.qty').val(prevVals.qty)

            //$card.find('.gabarit-width-flag .form-check-input').prop('checked', !prevVals.gw)
            $cside = $card.find('.control_side select')
            if(prevVals.control_side_exist){
              $card.find('.control_side').removeClass("d-none")
              $cside.val(prevVals.control_side)
            }else{
              $card.find('.control_side').addClass("d-none")
            }
            

            await previewCard($card, prevVals.qtyPriceOptions)

          }
        } catch (e) {
          window.showToast('Не вдалося завантажити секції/тканини', 'danger')
        }
      }
    })

    $container.on('click', '.remove-row', function () {
      $(this).closest('.item-card').remove()
      recalcPrice()
    })

    $container.on('change', '.qty', function () {
      const v = parseInt(this.value || '1', 10)
      if (isNaN(v) || v < 1) this.value = 1
      renderPriceOptions($(this).closest('.item-card'), v)
    })

   // UA: Конфігурація додаткових опцій ціни
  // EN: Price options configuration
  const priceOptionsConfig = [
    {
      key: "magnets_price_eur",
      label: "Фіксація магнітами",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "cord_pvc_tension_price_eur",
      label: "Фіксація Леска ПВХ з дотяжкою (шт)",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "cord_copper_barrel_price_eur",
      label: "Фіксація Леска з мідною діжкою (шт)",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "top_pvc_clip_pair_price_eur",
      label: "Кліпса кріплення для верхньої планки ПВХ, пара",
      unit: "пара",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "top_pvc_bar_tape_price_eur_mp",
      label: "Доплата за верхню планку ПВХ зі скотчем (монтаж без свердління), за м.п.",
      unit: "м.п.",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "bottom_wide_bar_price_eur_mp",
      label: "Доплата за широку нижню планку 10/28, за м.п.",
      unit: "м.п.",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "top_bar_scotch_price_eur_mp",
      label: "Скотч на верхню планку для встановлення без свердління, за м.п.",
      unit: "м.п.",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "metal_kronsht_price_eur",
      label: "Доплата за металеві кронштейни, шт",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "metal_cord_fix_price_eur",
      label: "Фіксація лески металева",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "motor_no_remote_price_eur",
      label: "Доплата за електродвигун без пульта (під вимикач, вимикач в вартість не входить), шт",
      unit: "шт",
      type: "motor",
      defaultChecked: false,
    },
    {
      key: "motor_with_remote_price_eur",
      label: "Доплата за електродвигун з одноканальним пультом ДУ (входить до вартості), шт",
      unit: "шт",
      type: "motor",
      defaultChecked: false,
    },
    {
      key: "middle_bracket_price_eur",
      label: "Доплата за проміжковий кронштейн, шт",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "remote_5ch_price_eur",
      label: "Доплата за 5-ти канальний пульт ДУ, шт",
      unit: "шт",
      type: "remote",
      defaultChecked: false,
      changeQty: true
    },
    {
      key: "remote_15ch_price_eur",
      label: "Доплата за 15-ти канальний пульт ДУ, шт",
      unit: "шт",
      type: "remote",
      defaultChecked: false,
      changeQty: true
    },
  ];

    // UA: Створює або повертає рядок опції в таблиці манифесту
    // EN: Create or get option row in manifest table
    function ensureOptionRow($card, optionName, labelText) {
      const $tbody = $card.find('.price-options-manifest')
      let $row = $tbody.find('.' + optionName + '-row')
      if ($row.length === 0) {
        $row = $(`
          <tr class="${optionName}-row">
            <td class="label">${labelText}</td>
            <td class="text-end">
              <span class="man-price-one" style="display:none;">0.00</span> 
              <div class="">
                <span class="man-price-one-uah">0.00</span>
              </div>
            </td>
            <td class="text-center">
              <span class="man-qty">0</span>
            </td>
            <td class="text-end">
              <span class="price" style="display:none;">0.00</span>
              <div class="">
                <span class="price-uah">0.00</span>
              </div>
            </td>
          </tr>
        `)
        $tbody.append($row)
      }
      return $row
    }


   function recalcPrice() {
      let sumTotal = 0

      $('.item-card').each(function (_, card) {
        const $card = $(card)
        let sum = 0

        // база + надбавка
        const base = Number($card.find('.base').text() || 0)
        const surcharge = Number($card.find('.surcharge').text() || 0)

        sum += base + surcharge

        // опции: только те, что имеют строку в таблице
        priceOptionsConfig.forEach((opt) => {
          const nameOption = opt.key
          const $row = $card.find('.price-options-manifest .' + nameOption + '-row')
          if ($row.length === 0) return

          const $unit = $row.find('.man-price-one')
          const $qty = $row.find('.man-qty')
          const $total = $row.find('.price')

          const unitEur = Number($unit.text() || 0)

          const qty = Number($qty.text() || 0)
          const totalEur = unitEur * qty

          $total.text(money(totalEur))
          $row.find('.man-price-one-uah').text(eurToUah(unitEur))
          $row.find('.price-uah').text(eurToUah(totalEur))

          sum += totalEur
        })

        // subtotal по позиции
        $card.find('.subtotal-input').text(money(sum))
        $card.find('.subtotal-uah').text(eurToUah(sum))

        sumTotal += sum
      })

      $('#orderTotal').text(money(sumTotal)).hide()
      $('#orderTotalUah').text(eurToUah(sumTotal))
    }
    

   function checkPriceOption(el, optionName, optionVal) {
      const $el = $(el)
      const $card = $el.closest('.item-card')
      const $block = $el.closest('.op-card')
      const $hidden = $block.find('.price-hidden')
      const $hiddenQty = $block.find('.qty-hidden')
      const $blockValQty = $block.find('.option-qty-value')
      const $buttons = $block.find('.qty-button')
      const labelText = $block.find('.option-title').text()
      const commonQty = Number($card.find('.qty').val() || 1)

      const gb_width_mm = Number($card.find('.gb_width_mm').val() || 0)
      const unitEur = Number(optionVal)

      if (el.checked) {
        // qty для опции = qty позиции
        const qty = commonQty > 0 ? commonQty : 1
        const gb = Number($card.find('.gb_width_mm').val() || 0)
        const unitEurEffective = calcOptionUnitEur(optionName, optionVal, gb)


        const totalEur = unitEurEffective * qty

        // скрытые поля (в EUR)
        $hidden.val(money(totalEur))
        $hiddenQty.val(qty)
        $blockValQty.text(qty)
        $buttons.prop('disabled', false)

        // строка в таблице
        const $row = ensureOptionRow($card, optionName, labelText)
        $row.find('.man-price-one').text(money(unitEurEffective))
        $row.find('.man-price-one-uah').text(eurToUah(unitEurEffective))
        $row.find('.man-qty').text(qty)
        $row.find('.price').text(money(totalEur))
        $row.find('.price-uah').text(eurToUah(totalEur))

      } else {
        // сброс
        $buttons.prop('disabled', true)
        $hidden.val(0)
        $hiddenQty.val(0)
        $blockValQty.text(0)

        // убираем строку опции из таблицы
        $card.find('.price-options-manifest .' + optionName + '-row').remove()
      }

      recalcPrice()
    }


    function changeQty(el, optionName, optionPrice, price, diffQty){
      const $card = $(el).closest('.item-card')
      let optionQty = Number($card.find(`[name="${optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")}"]`).val())
      optionQty = optionQty + Number(diffQty)

      setOneOption($card, optionName, optionQty, optionPrice, price)
      recalcPrice()
    }

    function setOneOption($card, optionName, optionQty, optionPrice, pricePerItemEur) {
      const $block = $card.find('.op-card.' + optionName)
      const $hidden = $block.find('.price-hidden')
      const $hiddenQty = $block.find('.qty-hidden')
      const $blockValQty = $block.find('.option-qty-value')
      const labelText = $block.find('.option-title').text()
      const gb_width_mm = Number($card.find('.gb_width_mm').val() || 0)

      if (optionQty <= 0) {
        // выключаем опцию
        $block.find('.form-check-input').prop('checked', false)
        $hidden.val(0)
        $hiddenQty.val(0)
        $blockValQty.text(0)
        $card.find('.price-options-manifest .' + optionName + '-row').remove()
        recalcPrice()
        return
      }

      // включаем чекбокс
      $block.find('.form-check-input').prop('checked', true)

      const gb = Number($card.find('.gb_width_mm').val() || 0)
      const unitEurEffective = calcOptionUnitEur(optionName, optionPrice, gb)

      const totalEur = unitEurEffective * optionQty

      $hidden.val(money(totalEur))
      $hiddenQty.val(optionQty)
      $blockValQty.text(optionQty)

      const $row = ensureOptionRow($card, optionName, labelText)
      $row.find('.man-price-one').text(money(unitEurEffective))
      $row.find('.man-price-one-uah').text(eurToUah(unitEurEffective))
      $row.find('.man-qty').text(optionQty)
      $row.find('.price').text(money(totalEur))
      $row.find('.price-uah').text(eurToUah(totalEur))

      recalcPrice()
    }

    function changeQty(el, optionName, optionPrice, price, diffQty) {
      const $card = $(el).closest('.item-card')
      const qtyName = optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
      let optionQty = Number($card.find(`[name="${qtyName}"]`).val() || 0)
      optionQty = optionQty + Number(diffQty)
      $card.find(`[name="${qtyName}"]`).val(optionQty)
      setOneOption($card, optionName, optionQty, optionPrice, price)
    }

    function calcOptionUnitEur(optionName, optionPrice, gb_width_mm) {
      // UA: якщо опція за м.п.
      // EN: if price is per linear meter
      if (optionName.includes("_mp")) {
        return Number(optionPrice) * (Number(gb_width_mm) / 1000)
      }
      // UA: за штуку
      // EN: per piece
      return Number(optionPrice)
    }


   function renderOnePriceOption($card, optionPrice, option, commonQty, preSelectoptionQty) {
      const optionName = option.key
      const optionQtyName = optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
      if (!optionPrice) return

      let optionQty = 0
      if (preSelectoptionQty) {
        optionQty = Number(preSelectoptionQty)
      } else {
        optionQty = Number($card.find(`[name="${optionQtyName}"]`).val() || 0)
      }
      if (Number.isNaN(optionQty)) optionQty = 0

      {% comment %} const gb = Number($card.find('.gb_width_mm').val() || 0)
      const unitEur = calcOptionUnitEur(optionName, optionPrice, gb)

      const unitEurFormatted = money(unitEur)
      const unitUahFormatted = eurToUah(unitEur) {% endcomment %}

      let checkedAttr = ""
      let disabledAttr = "disabled"
      if (optionQty > 0 || commonQty > 0) {
        checkedAttr = "checked"
        disabledAttr = ""
      }

      if ($card.find('.' + optionName).length === 0) {
        let htmlPriceOption =
          `<div class="op-card ${optionName} price-option-card border rounded-3 mb-2 bg-light-subtle">`
          + `<div class="d-flex align-items-center justify-content-between gap-2">`
          +   `<div class="d-flex align-items-center gap-2">`
          +     `<input class="form-check-input price-option mt-0" type="checkbox"`
          +       ` onchange="checkPriceOption(this, '${optionName}', '${optionPrice}')" ${checkedAttr} />`
          +     `<div class="d-flex flex-column">`
          +       `<span class="fw-semibold option-title">${option.label}</span>`
          +     `</div>`
          +   `</div>`
          +   `<div class="text-end">`
          +     `<span class="badge rounded-pill text-bg-primary">`
          +       `<span class="price" style="display:none;">${optionPrice}</span>`
          +       `&nbsp;&nbsp;`
          +       `<span class="price-uah">${eurToUah(optionPrice)}</span>`
          +     `</span>`
          +   `</div>`
          + `</div>`

        if (option.changeQty) {
          htmlPriceOption +=
            `<div class="d-flex align-items-center justify-content-between mt-2">`
            + `<div class="btn-group btn-group-sm" role="group" aria-label="Кількість">`
            +   `<button type="button" class="btn btn-outline-secondary qty-button qty-minus"`
            +     ` onclick="javascript:changeQty(this, '${optionName}', ${optionPrice}, 0, -1)" ${disabledAttr}>`
            +     `<i class="bi bi-dash"></i>`
            +   `</button>`
            +   `<span class="option-qty-value px-2">${optionQty}</span>`
            +   `<button type="button" class="btn btn-outline-secondary qty-button qty-plus"`
            +     ` onclick="javascript:changeQty(this, '${optionName}', ${optionPrice}, 0, 1)" ${disabledAttr}>`
            +     `<i class="bi bi-plus"></i>`
            +   `</button>`
            + `</div>`
            + `</div>`
        }

        htmlPriceOption +=
          `<input class="price-hidden" type="hidden" name="${optionName}" value="0" />`
          + `<input class="qty-hidden" type="hidden" name="${optionQtyName}" value="${optionQty}" />`
          + `</div>`

        $card.find('.op-card-list').append(htmlPriceOption)
      }

      // если у нас уже есть qty > 0 (редактирование заказа) — сразу создаём строку в таблице
      if (optionQty > 0) {
        setOneOption($card, optionName, optionQty, optionPrice, 0)
      }
    }

    function enableCheckGabarit($card, GbDiffWidthMm, checked){
      if (GbDiffWidthMm) {
        $card.find('.gabarit-width-flag').show()
        $card.find('.gabarit-width-flag .form-check-input').prop('disabled', false)
      } else {
        $card.find('.gabarit-width-flag').hide()
        $card.find('.gabarit-width-flag .form-check-input').prop('disabled', true)
      }
      $card.find('.gabarit-width-flag .form-check-input').prop('checked', checked)
    }


    function renderPriceOptions($card, commonQty, preSelectsPriceOptions = {}) {
      let numberCard = $card.find('.pos-index')
      let data = pricesCache[numberCard]
      if (!data && Object.keys(preSelectsPriceOptions).length == 0) {
        previewCard($card)
        return
      }

      if (preSelectsPriceOptions.comment_system_red || data?.comment_system_red) {
        $card.find('.comment_system_red').html(preSelectsPriceOptions.comment_system_red ?? data?.comment_system_red)
      }
      if (preSelectsPriceOptions.comment_system_green || data?.comment_system_green) {
        $card.find('.comment_system_green').html(preSelectsPriceOptions.comment_system_green ?? data?.comment_system_green)
      }

      let GbDiffWidthMm = preSelectsPriceOptions.GbDiffWidthMm  ?? data?.GbDiffWidthMm
      enableCheckGabarit($card, GbDiffWidthMm, preSelectsPriceOptions.gabarit_width_flag)

      let qty = Number($card.find('.qty').val() || 1)

      const baseOne = Number(data?.base_price_eur || preSelectsPriceOptions.base_price_eur || 0)
      const surchargeOne = Number(data?.surcharge_height_eur || preSelectsPriceOptions.surcharge_height_eur || 0)
      const baseTotal = baseOne * qty
      const surchargeTotal = surchargeOne * qty

      $card.find('.base').text(money(baseTotal))
      $card.find('.base-input').val(money(baseTotal))

      $card.find('.surcharge').text(money(surchargeTotal))
      $card.find('.surcharge-input').val(money(surchargeTotal))

      $card.find('.base-uah').text(eurToUah(baseTotal))
      $card.find('.surcharge-uah').text(eurToUah(surchargeTotal))

      $card.find('.gb_width_mm').val((Number(preSelectsPriceOptions.gb_width_mm || data?.gb_width_mm || 0)))

      priceOptionsConfig.forEach((option) => {
        const optionName = option.key
        const optionQtyName = optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
        const price = preSelectsPriceOptions[optionName] ?? (data ? data[optionName]:undefined)
        renderOnePriceOption($card, price, option, commonQty, preSelectsPriceOptions[optionQtyName]);
      })

      recalcPrice()
    }


    $container.on('change', '.table-section', async function () {
      const $card = $(this).closest('.item-card')
      const system = $card.find('.system-sheet').val()
      const section = $(this).val()

      $card.find('.base,.surcharge,.magnets-price,.subtotal').text('0.00')
      $card.find('.base-uah,.surcharge-uah,.subtotal-uah').text('0.00')
      if (!system || !section) {
        return
      }
      await fillFabricsForCard($card, system, section, null)
    })

    $container.on('select2:select', '.fabric', async function (event) {

      const $card = $(this).closest('.item-card')
      const fabric = $(this).val()

      if (!fabric) {
        fillFabricColorsForCard($card, [], null)
        return
      }

      try {
        const data = await loadFabricColors(fabric)
        fillFabricColorsForCard($card, data.color_codes || [], null)
      } catch (e) {
        window.showToast(e.message || 'Не вдалося завантажити кольори тканини', 'danger')
        fillFabricColorsForCard($card, [], null)
      }

      previewCard($card)
    })

    $('#orderForm').on('submit', function (e) {
      let ok = true
      $container.find('.item-card').each(function () {
        const $c = $(this)
        const sys = $c.find('.system-sheet').val()
        const sec = $c.find('.table-section').val()
        const fab = $c.find('.fabric').val()
        const fabc = $c.find('.fabric-color-code').val()

        if (!sys || !sec || !fab || !fabc) {
          ok = false
          if (!sys) $c.find('.system-sheet').addClass('is-invalid')
          if (!sec) $c.find('.table-section').addClass('is-invalid')
          if (!fab) $c.find('.fabric').addClass('is-invalid')
          if (!fabc) $c.find('.fabric-color-code').addClass('is-invalid')
          if(!$c.find('.control_side').hasClass("d-none")){
              if (!$c.find('.control_side select').val()) $c.find('.control_side select').addClass('is-invalid')
          }
        } else {
          $c.find('.system-sheet,.table-section,.fabric,.fabric-color-code,.control_side select').removeClass('is-invalid')
        }
      })
      if (!ok) {
        e.preventDefault()
        window.scrollTo({ top: 0, behavior: 'smooth' })
        window.showToast('Оберіть систему, колір системи, тканину та колір тканини для кожної позиції', 'warning')
      }
    })

     // ---------- Ініціалізація ----------
    ;(async function () {
      try {
        await loadSystems()

        if (Array.isArray(builderItems) && builderItems.length > 0) {
          // UA: Режим редагування існуючого замовлення
          // EN: Edit mode – restore existing items
          for (const item of builderItems) {
            await addRowWithData(item)
          }
          recalcPrice()
        } else {
          // UA: Нове замовлення — одна порожня позиція
          // EN: New order – start with single empty card
          $('#addRow').trigger('click')
        }
      } catch (e) {
        console.error(e)
        window.showToast('Не вдалося завантажити системи прайсу', 'danger')
      }
    })()
  </script>
{% endblock %}
