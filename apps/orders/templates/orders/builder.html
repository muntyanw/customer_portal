{% extends 'core/dashboard_base.html' %}
{% load l10n %}
{% block dashboard_title %}
  Нове замовлення
{% endblock %}
{% block dashboard_heading %}
  Тканинні ролети замовлення №{{ order.id|default:'null' }}
{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Select2 CSS для "умных" селектов -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    .order-summary-bar {
      position: static;
      background: var(--bs-body-bg);
      border-bottom: 1px solid var(--bs-border-color);
      box-shadow: none;
      padding: 0.75rem 1rem;
    }
.order-total-bar {
  background: var(--bs-body-bg);
  border-top: 1px solid var(--bs-border-color);
}
    .item-card .price-box .kv {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: var(--bs-secondary-color);
    }
    .item-card .price-box .sum {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-weight: 600;
      font-size: 1.05rem;
    }
    .order-summary-label {
      font-size: 0.8rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--bs-body-color);
    }
    .order-summary-value {
      font-weight: 700;
      font-size: 1.35rem;
      color: var(--bs-body-color);
    }
    .order-summary-note {
      min-width: 260px;
    }
    @media (max-width: 576px) {
      .order-summary-bar {
        padding: 0.5rem 0.75rem;
      }
      .order-summary-label {
        font-size: 0.65rem;
      }
      .order-summary-value {
        font-size: 1.1rem;
      }
      .order-summary-bar .form-control-sm {
        padding: 0.3rem 0.5rem;
        font-size: 0.9rem;
      }
      .order-summary-bar .d-flex.flex-wrap {
        gap: 0.35rem;
      }
      updateGabaritHidden($card)
    }
    .readonly-mode .select2-container,
    .readonly-mode .select2-selection {
      pointer-events: none !important;
    }
    @media (min-width: 992px) {
      .item-card .controls-inline {
        display: flex;
        gap: 0.75rem;
      }
    }
  </style>
{% endblock %}

{% block dashboard_content %}
  <form method="post" id="orderForm" novalidate>
    {% csrf_token %}
    <input type="hidden" name="eur_rate_at_creation" class="eur_rate_at_creation" />
    <input type="hidden" name="eur_rate" id="orderEurRateInput" />
    <input type="hidden" name="total_eur" id="orderTotalInput" value="{{ order.total_eur|default:'0.00' }}" />
    <input type="hidden" name="status_action" id="statusActionInput" value="save" />
    <input type="hidden" name="next_url" id="nextUrlInput" value="" />
    <input type="hidden" id="customerDiscountValue" value="{{ customer_discount_percent_js|default:'0' }}">
    <fieldset {% if readonly %}disabled{% endif %}>

    <div class="mb-3">
      <div class="small text-muted mb-2">
        Ознайомтесь, будь ласка, з технічними характеристиками і умовами. Клієнт самостійно несе відповідальність за правильність обраної системи, розмірів, комплектації та інші параметри.
      </div>
      <div class="d-flex flex-wrap align-items-center gap-2">
        <div class="d-flex flex-wrap gap-2">
          <a href="{{ PRICE_SHEET_URL }}" target="_blank" class="btn btn-primary btn-sm">Відкрити прайс</a>
          <a href="https://docs.google.com/document/d/1uz2k8hqnaLxlmxB-u1BUmaEmW3pw4QIF/edit" target="_blank" class="btn btn-secondary btn-sm text-white">Технічні характеристики</a>
        </div>
        {% if request.user.is_manager or request.user.is_superuser %}
          <div class="ms-auto d-flex flex-column gap-1" style="min-width:260px;">
            <label class="form-label fw-semibold mb-0" for="orderCustomer">Клієнт</label>
            <select id="orderCustomer" name="customer_id" class="form-select form-select-sm">
              <option value="">— Оберіть клієнта —</option>
              {% for c in customers_filter_list %}
                <option
                  value="{{ c.user.id }}"
                  data-discount="{{ c.discount_percent|default_if_none:0|stringformat:'0.2f' }}"
                  {% if order and order.customer_id == c.user.id %}selected{% elif not order and request.user.id == c.user.id %}selected{% endif %}
                >
                  {% if c.full_name %}{{ c.full_name }}{% else %}{{ c.user.email }}{% endif %}
                </option>
              {% endfor %}
            </select>
            <div class="invalid-feedback">Оберіть клієнта.</div>
          </div>
        {% endif %}
        <div class="ms-auto d-flex align-items-center gap-2">
          <span class="text-muted small text-uppercase">Статус</span>
          <span class="badge bg-primary">
            {% if order %}{{ order.get_status_display }}{% else %}Прорахунок{% endif %}
          </span>
        </div>
      </div>
      <input type="url" class="form-control" id="priceUrl" name="price_url" value="{{ PRICE_SHEET_URL }}" required style="display: none;" />
    </div>

    <div class="order-summary-bar p-3 rounded-3 shadow-sm mb-3">
      <div class="d-flex flex-wrap align-items-end gap-3">
        <div class="d-flex flex-column">
          <div class="order-summary-label mb-1">Всього, грн</div>
          <div class="order-summary-value"><span id="orderTotalBaseUah">0.00</span></div>
        </div>
       
        <div class="d-flex flex-column financial-only" {% if not can_view_financial_controls %}style="display:none !important"{% endif %}>
          <label class="order-summary-label mb-1" for="orderMarkup">Націнка на роздріб, %</label>
          <input
            type="number"
            step="0.01"
            min="0"
            class="form-control form-control-sm"
            id="orderMarkup"
            name="markup_percent"
            value="{{ order.markup_percent|default_if_none:0|unlocalize }}"
          />
        </div>
        <div class="d-flex flex-column financial-only" {% if not can_view_financial_controls %}style="display:none !important"{% endif %}>
          <div class="order-summary-label mb-1">З націнкою та дод. посл.</div>
          <div class="order-summary-value"><span id="orderTotalUah">0.00</span></div>
        </div>
        <div class="flex-grow-1 order-summary-note ms-lg-auto">
          <label class="order-summary-label mb-1" for="orderNote">Примітка до замовлення</label>
          <input
            type="text"
            class="form-control form-control-sm"
            id="orderNote"
            name="note"
            placeholder="Коротка примітка..."
            value="{{ order.note|default_if_none:'' }}"
            {% if readonly %}disabled{% endif %}
          />
        </div>
      </div>
      <div class="d-none">
        <span id="orderTotal">{{ order.total_eur|default:'0.00' }}</span>
      </div>
    </div>

    <div class="row g-2 align-items-end mb-3 financial-only" {% if not can_view_financial_controls %}style="display:none !important"{% endif %}>
      <div class="col-12 col-md-6">
        <label class="form-label fw-semibold" for="extraServiceLabel">Додаткова послуга</label>
        <input
          type="text"
          class="form-control"
          id="extraServiceLabel"
          name="extra_service_label"
          placeholder="Доставка, монтаж тощо"
          value="{{ order.extra_service_label|default_if_none:'' }}"
          {% if readonly %}disabled{% endif %}
        />
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label fw-semibold" for="extraServiceAmount">Сума, грн</label>
        <input
          type="number"
          step="0.01"
          min="0"
          class="form-control"
          id="extraServiceAmount"
          name="extra_service_amount_uah"
          value="{{ order.extra_service_amount_uah|default_if_none:0|stringformat:'0.2f' }}"
          {% if readonly %}disabled{% endif %}
        />
        {% if readonly %}
          <div class="form-text text-muted">{{ order.extra_service_amount_uah|default_if_none:'0'|floatformat:2 }} грн</div>
        {% endif %}
      </div>
    </div>

    <!-- Контейнер для карток позицій -->
    <div id="itemsContainer" class="d-flex flex-column gap-3"></div>

    <div class="d-grid mt-2">
      <button type="button" class="btn btn-outline-primary" id="addRow"><i class="bi bi-plus-lg me-1"></i> Додати позицію</button>
    </div>

    <!-- Підсумок по замовленню -->
    <div class="order-total-bar mt-3 p-3 rounded-3 shadow-sm">
      {% if not readonly %}
        <div class="d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-primary" name="status_action" value="save" data-status-action="save">Зберегти</button>
          {% if order %}
            {% if order.status == order.STATUS_QUOTE %}
              <button type="submit" class="btn btn-success" name="status_action" value="to_work" data-status-action="to_work">В роботу</button>
            {% endif %}
            {% if request.user.is_manager %}
              <div class="ms-auto d-flex gap-2">
                {% if order.prev_status %}
                  <button type="submit" class="btn btn-outline-primary" name="status_action" value="prev" data-status-action="prev">Попередній статус</button>
                {% endif %}
                {% if next_status_label %}
                  <button type="submit" class="btn btn-outline-primary" name="status_action" value="next" data-status-action="next">
                    Наступний статус{% if next_status_label %}: {{ next_status_label }}{% endif %}
                  </button>
                {% endif %}
                <a class="btn btn-outline-primary" href="{% url 'orders:workbook_download' order.id %}">
                  <i class="bi bi-file-earmark-excel me-1"></i> Файл замовлення
                </a>
              </div>
            {% endif %}
          {% else %}
            <button type="submit" class="btn btn-success" name="status_action" value="to_work" data-status-action="to_work">В роботу</button>
          {% endif %}
        </div>
      {% endif %}
      {% if order and can_view_financial_controls %}
        {% if proposal_page_url or proposal_excel_url %}
          <div class="d-flex flex-wrap gap-2 mt-2">
            {% if proposal_page_url %}
              <a class="btn btn-warning text-dark proposal-link" href="{{ proposal_page_url }}" data-proposal-url="{{ proposal_page_url }}" target="_blank">
                <i class="bi bi-eye me-1"></i> Комерційна пропозиція (сторінка)
              </a>
            {% endif %}
            {% if proposal_excel_url %}
              <a class="btn btn-success proposal-link" href="{{ proposal_excel_url }}" data-proposal-url="{{ proposal_excel_url }}">
                <i class="bi bi-file-earmark-excel me-1"></i> Комерційна пропозиція (Excel)
              </a>
            {% endif %}
          </div>
        {% endif %}
      {% endif %}
    </div>

    </fieldset>
  </form>

  <div class="modal fade" id="unsavedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Зберегти зміни?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Є незбережені зміни. Бажаєте зберегти замовлення?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="unsavedExitBtn">Вийти без збереження</button>
          <button type="button" class="btn btn-primary" id="unsavedSaveBtn">Зберегти</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="sendToWorkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Відправити замовлення в роботу?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Відправити замовлення в роботу після збереження?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="sendToWorkSkipBtn">Не відправляти</button>
          <button type="button" class="btn btn-success" id="sendToWorkBtn">Відправити</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Оплата замовлення</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0" id="paymentModalText" style="white-space: pre-wrap;"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="paymentCancelBtn">Не відправляти</button>
          <button type="button" class="btn btn-success" id="paymentConfirmBtn">Відправити</button>
        </div>
      </div>
    </div>
  </div>

  {% if status_logs %}
    <div class="card border-0 shadow-sm mt-3">
      <div class="card-body">
        <h6 class="mb-3">Історія статусів</h6>
        <div class="list-group list-group-flush">
          {% for log in status_logs %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">{{ log.get_status_display }}</div>
                <div class="small text-muted">{{ log.created_at|date:'d.m.Y H:i' }}</div>
              </div>
              {% if log.user %}<div class="small text-muted">{{ log.user }}</div>{% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  {% include 'orders/_item_template.html' %}
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    // UA: Виводимо тости ближче до центру екрана на сторінці білдера
    window.showToast = function (message, type = "primary") {
      const id = "toast-" + Math.random().toString(36).slice(2)
      const html = `
        <div id="${id}" class="toast align-items-center text-bg-${type} border-0 position-fixed top-50 start-50 translate-middle shadow"
             role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 2000;">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `
      document.body.insertAdjacentHTML("beforeend", html)
      const el = document.getElementById(id)
      const toast = new bootstrap.Toast(el, { delay: 9000 })
      toast.show()
      el.addEventListener("hidden.bs.toast", () => el.remove())
    }

    // EN: Global builder context from Django
    // UA: Глобальний контекст білдера з Django
    const builderOrderId = {{ order.id|default:"null" }}
    const builderItems = {{ items_json|safe|default:"[]" }}
    const paymentMessage = "{{ payment_message_text|default:''|escapejs }}"
    const paymentShortageRaw = "{{ payment_shortage.shortage|default:''|escapejs }}"
    const paymentShortage = paymentShortageRaw ? parseFloat(paymentShortageRaw.replace(',', '.')) : null
    const paymentShortageOrders = {{ payment_shortage.orders|default:"[]"|safe }}
    const isManager = {{ request.user.is_manager|yesno:"true,false" }}
    const isStaff = {{ request.user.is_staff|yesno:"true,false" }}
    const isSuperuser = {{ request.user.is_superuser|yesno:"true,false" }}
    const currentUserId = {{ request.user.id|default:0 }}
    const isOwner = {{ request.user.id }} === {{ order.customer_id|default:request.user.id }}
    const eur_rate = parseFloat(
      '{{ builder_rate|default:"0.00" }}'
        .replace(/\s/g, '')
        .replace(',', '.')
    )
    const markup_initial = parseFloat(
      '{{ order.markup_percent|default:"0" }}'
        .replace(/\s/g, '')
        .replace(',', '.')
    ) || 0
    const isReadonlyFront = {{ readonly|yesno:"true,false" }}

    let isDirty = false
    let pendingExitUrl = null
    let unsavedModal = null
    let sendToWorkModal = null
    let paymentModal = null
    let suppressDirty = true
    let initWait = 2

    function finishInit() {
      initWait -= 1
      if (initWait <= 0) {
        suppressDirty = false
      }
    }

    function markDirty() {
      if (suppressDirty) return
      isDirty = true
    }

    function submitWithAction(action) {
      $('#statusActionInput').val(action)
      isDirty = false
      document.getElementById('orderForm').requestSubmit()
    }

    function buildPaymentMessage() {
      const rawOrders = Array.isArray(paymentShortageOrders) ? paymentShortageOrders : []
      const orderIds = []
      if (builderOrderId) orderIds.push(builderOrderId)
      rawOrders.forEach((id) => {
        if (id && !orderIds.includes(id)) orderIds.push(id)
      })
      let msg = "Обов'язково вкажіть у платежі в полі «Призначення платежу» наступний текст:\n\n" + paymentMessage
      if (paymentShortage !== null && orderIds.length) {
        msg += "\n\nЗамовлення №" + orderIds.join(", №") + " на суму " + paymentShortage + " грн"
      }
      return msg
    }

    function requestToWork() {
      if (isOwner && paymentMessage) {
        const msg = buildPaymentMessage()
        const box = document.getElementById('paymentModalText')
        if (box) box.textContent = msg
        paymentModal.show()
        return
      }
      submitWithAction('to_work')
    }

    const systemConfigCache = new Map() // system -> config

    function enforceReadonly() {
      if (!isReadonlyFront) return
      const $form = $('#orderForm')
      $form.addClass('readonly-mode')
      $form.find('input, select, textarea, button').prop('disabled', true)
      $form.find('select').prop('disabled', true).trigger('change.select2')
      $form.find('a').prop('disabled', false)
      $('#addRow').off('click')
      $form.on('mousedown.readonly click.readonly', 'select, .select2-selection', function (e) {
        e.preventDefault()
        return false
      })
    }

    // ---------- Helpers ----------
    function money(x) {
      return (Math.round(parseFloat(x || 0) * 100) / 100).toFixed(2)
    }

    // UA: Конвертація EUR → UAH (тільки для фронта)
    // EN: EUR → UAH conversion (frontend-only)
    function eurToUahRaw(x) {
      return Number(x || 0) * Number(eur_rate || 0)
    }
    function eurToUah(x) {
      return money(eurToUahRaw(x))
    }
    function uahTotal(x) {
      return String(Math.ceil(eurToUahRaw(x)))
    }

    // UA: Записуємо курс, який піде на бекенд
    // EN: Save rate that will be sent to backend
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.eur_rate_at_creation').forEach(function (el) {
        el.value = eur_rate
      })
      const rateInput = document.getElementById('orderEurRateInput')
      if (rateInput) {
        rateInput.value = eur_rate
      }
      const markupInput = document.getElementById('orderMarkup')
      if (markupInput) {
        markupInput.value = markup_initial
      }
      const nextUrlInput = document.getElementById('nextUrlInput')
      $('#orderForm').on('input change', 'input, select, textarea', function () {
        if (this.type === 'hidden') return
        markDirty()
      })

      window.addEventListener('beforeunload', function (e) {
        if (!isDirty) return
        const msg = 'Є незбережені зміни. Ви впевнені, що хочете вийти?'
        e.preventDefault()
        e.returnValue = msg
        return msg
      })

      $('#orderForm').on('submit', function () {
        isDirty = false
      })

      unsavedModal = new bootstrap.Modal(document.getElementById('unsavedModal'))
      sendToWorkModal = new bootstrap.Modal(document.getElementById('sendToWorkModal'))
      paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'))

      document.getElementById('unsavedSaveBtn').addEventListener('click', function () {
        if (nextUrlInput) nextUrlInput.value = pendingExitUrl || ''
        unsavedModal.hide()
        sendToWorkModal.show()
      })

      document.getElementById('unsavedExitBtn').addEventListener('click', function () {
        isDirty = false
        if (nextUrlInput) nextUrlInput.value = ''
        unsavedModal.hide()
        if (pendingExitUrl) {
          window.location.href = pendingExitUrl
        }
      })

      document.getElementById('sendToWorkBtn').addEventListener('click', function () {
        sendToWorkModal.hide()
        requestToWork()
      })

      document.getElementById('sendToWorkSkipBtn').addEventListener('click', function () {
        sendToWorkModal.hide()
        submitWithAction('save')
      })

      document.getElementById('paymentConfirmBtn').addEventListener('click', function () {
        paymentModal.hide()
        submitWithAction('to_work')
      })

      document.getElementById('paymentCancelBtn').addEventListener('click', function () {
        paymentModal.hide()
      })

      document.addEventListener('click', function (e) {
        const link = e.target.closest('a')
        if (!link) return
        const href = link.getAttribute('href') || ''
        if (!href || href.startsWith('#') || link.target === '_blank' || link.hasAttribute('download')) return
        if (!isDirty) return
        e.preventDefault()
        pendingExitUrl = link.href
        unsavedModal.show()
      })
      if (isReadonlyFront) {
        const $form = $('#orderForm')
        $form.find('input, select, textarea, button').prop('disabled', true)
        $form.find('a').prop('disabled', false) // allow navigation
      }
      function updateFinancialVisibility() {
        if (isSuperuser) {
          $('.financial-only').removeAttr('style')
          return
        }
        const $customer = $('#orderCustomer')
        if (!$customer.length) {
          return
        }
        const selectedId = Number($customer.val() || 0)
        if (selectedId === currentUserId) {
          $('.financial-only').removeAttr('style')
        } else {
          $('.financial-only').attr('style', 'display:none !important')
        }
      }
      if (isManager || {{ request.user.is_superuser|yesno:"true,false" }}) {
        $('#orderCustomer').select2({
          width: '100%',
          placeholder: 'Оберіть клієнта',
          allowClear: true,
        })
        $('#orderCustomer').on('change', function () {
          const pct = Number($(this).find('option:selected').data('discount') || 0)
          $('#customerDiscountValue').val(pct)
          updateFinancialVisibility()
          recalcPrice()
        })
        updateFinancialVisibility()
      }
      enforceReadonly()
      finishInit()
    })

    function getCsrf() {
      const m = document.querySelector('meta[name="csrf-token"]')
      if (m && m.content) return m.content
      const match = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/)
      return match ? decodeURIComponent(match[1]) : ''
    }

    function itemTemplate(index) {
      const tpl = document.getElementById('item-template')
      const node = tpl.content.cloneNode(true)
      $(node)
        .find('.pos-index')
        .text(index + 1)
      $(node).find('[data-index]').attr('data-index', index)
      return node
    }

    const $container = $('#itemsContainer')
    const priceUrlInput = $('#priceUrl')

    let systemsCache = null
    let pricesCache = {}
    const sectionsCache = new Map() 
    const fabricsCache = new Map() 
    const fabricColorsCache = new Map()

    let debounceTimer
    function setEventsFromGabarits($card) {
      const $w_mm = $card.find('.w-mm')
      const $h_mm = $card.find('.h-mm')
      const $qtyInput = $card.find('.qty')

      $card.find('.h-mm, .w-mm, .qty, .gabarit-width-flag, .fabric-height-flag').prop('disabled', false)
      $card.find('.gabarit-width-flag .form-check-input, .fabric-height-flag .form-check-input').prop('disabled', false)

    function setDebounce(fn) {
      const prevTimer = $card.data('gabaritsDebounceTimer')
      if (prevTimer) {
        clearTimeout(prevTimer)
      }
      const t = setTimeout(fn, 600)
      $card.data('gabaritsDebounceTimer', t)
    }

      $card.find('.h-mm, .w-mm')
        .off('input.gabarits')
        .on('input.gabarits', function () {
          setDebounce(() => {
            if (Number($w_mm.val()) > 0 && Number($h_mm.val()) > 0) {
              previewCard($card)
            }
          })
        })

      $card.find('.gabarit-width-flag .form-check-input')
        .off('change.gabarits')
        .on('change.gabarits', function () {
          updateGabaritHidden($card)
          if (Number($w_mm.val()) > 0 && Number($h_mm.val()) > 0) {
            previewCard($card)
          }
        })

      $card.find('.fabric-height-flag .form-check-input')
        .off('change.gabarits')
        .on('change.gabarits', function () {
          updateFabricHeightHidden($card)
          if (Number($w_mm.val()) > 0 && Number($h_mm.val()) > 0) {
            previewCard($card)
          }
        })

      $qtyInput
        .off('input.qtychange')
        .on('input.qtychange', function () {
          previewCard($card)
          syncOptionsQty($card)
        })
    }

    function updateGabaritHidden($card) {
      const $h = $card.find('.gabarit-width-flag-hidden')
      if (!$h.length) return
      const checked = $card.find('.gabarit-width-flag .form-check-input').is(':checked')
      $h.val(checked ? '1' : '0')
    }

    function updateFabricHeightHidden($card) {
      const $h = $card.find('.fabric-height-flag-hidden')
      if (!$h.length) return
      const checked = $card.find('.fabric-height-flag .form-check-input').is(':checked')
      $h.val(checked ? '1' : '0')
    }


    // UA: Прибирає всі додаткові опції з картки (і чекбокси, і рядки в таблиці)
    // EN: Remove all extra options from card (option cards + table rows)
    function removePriceOptions($card) {
      // 1) карточки с чекбоксами
      priceOptionsConfig.forEach((option) => {
        $card.find('.op-card.' + option.key).remove()
      })

      // 2) строки в таблице манифеста
      priceOptionsConfig.forEach((option) => {
        $card.find('.price-options-manifest .' + option.key + '-row').remove()
      })
    }

    // UA: Повністю очищає картку позиції (без видалення самої позиції)
    // EN: Fully reset card state (without removing the card itself)
    function clearCard($card) {
      // комментарии
      $card.find('.comment_system_red').empty()
      $card.find('.comment_system_green').empty()

      // габариты и количество
      $card.find('.h-mm').val(0)
      $card.find('.w-mm').val(0)
      $card.find('.qty').val(1)
      $card.find('.gb_width_mm').val(0)
      $card.find('.gabarit-width-flag-hidden').val('0')
      $card.find('.fabric-height-flag-hidden').val('0')

      // базовые цены в price-box (EUR + UAH)
      const $priceBox = $card.find('.price-box')
      $priceBox.find('.base').text('0.00')
      $priceBox.find('.base-uah').text('0.00')
      $priceBox.find('.surcharge').text('0.00')
      $priceBox.find('.surcharge-uah').text('0.00')
      $priceBox.find('.subtotal-input').text('0.00').val('0')
      $priceBox.find('.subtotal-uah').text('0.00')

      // скрытые поля для базы/надбавки/итога (на бекенд идут только EUR)
      $card.find('input[name="base_price_eur"]').val('0')
      $card.find('input[name="surcharge_height_eur"]').val('0')
      $card.find('input[name="subtotal_eur"]').val('0')

      // все дополнительные опции (карточки + строки в таблице)
      removePriceOptions($card)

      // пересчёт общего итога
      recalcPrice()
    }


    async function changeSystemSheet($card){
        clearCard($card)
        const system = $card.find('.system-sheet').val()

        const $sec = $card.find('.table-section')
        const $fab = $card.find('.fabric')
        const $fabColor = $card.find('.fabric-color-code')

        $sec.empty().append('<option value="" selected disabled>— Оберіть колір системи —</option>')
        $fab.empty().append('<option value="">Спочатку оберіть колір системи…</option>')
        $fabColor.empty().append('<option value="">Спочатку оберіть колір системи…</option>')

        $sec.val(null).trigger('change')
        $fab.val(null).trigger('change')
        $fabColor.val(null).trigger('change')

        if (!system) return

        try {
          let data = await loadSectionsForSystem(system, $card)
          if(data.exist_control_side){
            $card.find('.control_side').removeClass('d-none')
          }else{
            $card.find('.control_side').addClass('d-none')
          }
          enableCheckGabarit($card, data.GbDiffWidthMm ?? 0, false, false, system)
          fillSectionsForCard($card, system, null)
        } catch (e) {
          window.showToast('Не вдалося завантажити секції для системи', 'danger')
        }
    }

    // ---------- Select2 init ----------
    function initSelectsForCard($card) {

      $card.find('.fabric').select2({
        width: '100%',
        dropdownParent: $card
      })

      const $table_section = $card.find('.table-section').select2({
        width: '100%',
        dropdownParent: $card
      })

      const $selectSys = $card.find('.system-sheet').select2({
        width: '100%',
        dropdownParent: $card
      })

      const $fabricColor = $card.find('.fabric-color-code').select2({
        width: '100%',
        dropdownParent: $card,
        tags: true,
        createTag: function (params) {
          const term = $.trim(params.term)
          if (term === '') {
            return null
          }
          return {
            id: term,
            text: term,
            newTag: true
          }
        }
      })

      $table_section.on('select2:select', function (e) {
        clearCard($card)
        const system = $card.find('.system-sheet').val()
        const posIndex = Number($card.find('.pos-index').text())
        const cachedSection = sectionsCache.get(system) || {}
        const cachedPrice = pricesCache[posIndex] || {}
        const gbDiff = cachedPrice.GbDiffWidthMm ?? cachedSection.GbDiffWidthMm ?? 0
        enableCheckGabarit($card, gbDiff, false, false, system)
      })

      $fabricColor.on('select2:select', function (e) {

        setEventsFromGabarits($card)

        const $w_mm = $card.find('.w-mm')
        const $h_mm = $card.find('.h-mm')

        if (!changingProgrammatically) {
          if (Number($w_mm.val()) > 0 && Number($h_mm.val()) > 0) {
            previewCard($card)
          }
        }
      })

      $selectSys.on('select2:select', function (e) {
        changeSystemSheet($card)
      })


    }

    async function loadSystems() {
      const url = priceUrlInput.val()
      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/systems-list?url=${encodeURIComponent(url)}`)
      hideGlobalLoader()
      if (!resp.ok) throw new Error('Cannot load systems')
      const data = await resp.json()
      systemsCache = data.systems || data.sheets || []
      return systemsCache
    }

    async function loadSectionsForSystem(system, $card) {
      if (sectionsCache.has(system)) return sectionsCache.get(system)

      const url = priceUrlInput.val()
      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/system-fabrics?url=${encodeURIComponent(url)}&system=${encodeURIComponent(system)}`)
      hideGlobalLoader()
      if (!resp.ok) throw new Error('Cannot load sections')
      const data = await resp.json()
      let posIndex = Number($card.find('.pos-index').text())
      pricesCache[posIndex] = data
      const sections = data.sections || []
      sections.GbDiffWidthMm = data.GbDiffWidthMm
      sections.exist_control_side = data.exist_control_side
      sectionsCache.set(system, sections)
      return sections
    }

    async function loadFabricsForSection(system, section) {
      const key = `${system}|||${section}`
      if (fabricsCache.has(key)) return fabricsCache.get(key)

      const url = priceUrlInput.val()
      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/system-fabrics?url=${encodeURIComponent(url)}&system=${encodeURIComponent(system)}&section=${encodeURIComponent(section)}`)
      hideGlobalLoader()
      if (!resp.ok) throw new Error('Cannot load fabrics')
      const data = await resp.json()
      const sectionMeta = sectionsCache.get(system) || {}
      if (sectionMeta.GbDiffWidthMm !== undefined) {
        data.GbDiffWidthMm = sectionMeta.GbDiffWidthMm
      }
      fabricsCache.set(key, data)
      return data
    }

    async function previewPrice({ url, system, section, fabric, fabric_color_code, h, w, gabarit_width_flag, fabric_height_flag }) {
      $('.load_gif').show()
      showGlobalLoader()
      const resp = await fetch('/api/v1/pricing/system-preview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrf() },
        body: JSON.stringify({
          url,
          system_sheet: system,
          section_title: section,
          fabric_name: fabric,
          fabric_color_code: fabric_color_code,
          width_mm: w,
          gabarit_height_mm: h,
          gabarit_width_flag: gabarit_width_flag,
          fabric_height_flag: fabric_height_flag
        })
      })
      hideGlobalLoader()
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: 'Error' }))
        throw new Error(err.detail || 'Помилка розрахунку')
      }
      $('.load_gif').hide()
      return resp.json()
    }

    async function loadFabricColors(fabricName) {
      if (!fabricName) return { color_codes: [] }

      if (fabricColorsCache.has(fabricName)) {
        return fabricColorsCache.get(fabricName)
      }

      showGlobalLoader()
      const resp = await fetch(`/api/v1/pricing/fabric-colors?fabric=${encodeURIComponent(fabricName)}`)
      hideGlobalLoader()
      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: 'Error' }))
        throw new Error(err.detail || 'Не вдалося завантажити кольори тканини')
      }
      const data = await resp.json()
      fabricColorsCache.set(fabricName, data)
      return data
    }

    function fillFabricColorsForCard($card, codes, preselect) {
      const $sel = $card.find('.fabric-color-code')
      $sel.empty()
      $sel.append('<option value="" selected disabled>— Оберіть колір —</option>')
      ;(codes || []).forEach((code) => {
        $sel.append(new Option(code, code))
      })
      if (preselect) {
        $sel.val(preselect)
      } else {
        $sel.val(null)
      }
      $sel.trigger('change')
    }

    function setLoadingFabrics($card, isLoading) {
      const $fab = $card.find('.fabric')
      if (isLoading) {
        $fab.html('<option>Завантаження тканин…</option>').prop('disabled', true)
        $fab.trigger('change')
      }
    }

    async function fillSystems($card, preselectSystem) {
      const $sys = $card.find('.system-sheet')
      $sys.empty()
      $sys.append('<option value="" selected disabled>— Оберіть систему —</option>')
      ;(systemsCache || []).forEach((name) => {
        $sys.append(new Option(name, name))
      })
      if (preselectSystem && systemsCache && systemsCache.includes(preselectSystem)) {
        $sys.val(preselectSystem)
      } else {
        $sys.val(null)
      }
      $sys.trigger('change')
    }

    const SYSTEM_COLORS = [
      'біла',
      'коричнева',
      'графіт',
      'золотий дуб',
      'сіра'

    ]

    function extractColorFromTitle(title) {
      if (!title) return null

      const lowerTitle = title.toLowerCase()

      for (const color of SYSTEM_COLORS) {
        if (lowerTitle.includes(color.toLowerCase())) {
          return color
        }
      }

      return null
    }


    async function fillSectionsForCard($card, system, preselectSection) {
      const $sec = $card.find('.table-section')
      $sec.empty()
      $sec.append('<option value="" selected disabled>— Оберіть колір системи —</option>')

      const sections = sectionsCache.get(system) || []

      sections.forEach((s) => {
        const originalTitle = typeof s === 'string' ? s : (s.title || 'Секція')

        const colorTitle = extractColorFromTitle(originalTitle)

        const optionText = colorTitle || originalTitle

        const option = new Option(optionText, originalTitle)

        // if (typeof s === 'object') {
        //   $(option).data('row', s.row).data('col', s.col)
        // }

        $sec.append(option)
      })

      $sec.prop('disabled', false)

      if (preselectSection) {
        $sec.val(preselectSection)
      } else {
        $sec.val(null)
      }
      // $sec.trigger('change')
    }


    async function fillFabricsForCard($card, system, section, preselectFabric) {
      if (!system || !section) {
        return
      }
      setLoadingFabrics($card, true)
      try {
        const data = await loadFabricsForSection(system, section)
        const $fab = $card.find('.fabric')
        $fab.empty().append('<option value="" selected disabled>— Оберіть тканину —</option>')
        ;(data.fabrics || []).forEach((f) => $fab.append(new Option(f.name, f.name)))
        if (preselectFabric) {
          $fab.val(preselectFabric)
        } else {
          $fab.val(null)
        }
        $fab.prop('disabled', false)
        $fab.trigger('change')
        let posIndex = Number($card.find('.pos-index').text())
        pricesCache[posIndex] = data
        previewCard($card)
      } catch (e) {
        window.showToast('Не вдалося завантажити тканини для секції', 'danger')
      } finally {
        setLoadingFabrics($card, false)
      }
    }

    function readCardValues($card, typeOperation) {
      let qtyPriceOptions = {}
      priceOptionsConfig.forEach((option) => {
        let optionQtyName = option.key.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
        const $row = $card.find('.price-options-manifest .' + option.key + '-row')
        if (!$row.length) {
          return
        }
        const qty = $row.find('.man-qty').text()
        const price = $row.find('.price').text()
        if (price !== undefined && price !== "0" && price !== "0.00") {
          qtyPriceOptions[option.key] = price
        } else {
          qtyPriceOptions[option.key] = "0"
        }
        if (qty) {
          qtyPriceOptions[optionQtyName] = qty
        }
      });
      return {
        system: $card.find('.system-sheet').val() || '',
        section: $card.find('.table-section').val() || '',
        fabric: $card.find('.fabric').val() || '',
        fabric_color_code: $card.find('.fabric-color-code').val() || '',
        //h: $card.find('.h-mm').val() || '',
        //w: $card.find('.w-mm').val() || '',
        qty: $card.find('.qty').val() || '1',
        //gw: $card.find('.gabarit-width-flag .form-check-input').is(':checked'),
        control_side_exist: !$card.find('.control_side').hasClass("d-none"),
        control_side: $card.find('.control_side select').val(),
        qtyPriceOptions:qtyPriceOptions
      }
    }

    async function previewCard($card, preSelectsPriceOptions = {}) {
      const url = priceUrlInput.val()
      const system = $card.find('.system-sheet').val()
      const section = $card.find('.table-section').val()
      const fabric = $card.find('.fabric').val()
      const fabric_color_code = $card.find('.fabric-color-code').val()
      const h = parseInt($card.find('.h-mm').val() || '0', 10)
      const w = parseInt($card.find('.w-mm').val() || '0', 10)
      const magnets = $card.find('.magnets').is(':checked')
      const gabarit_width_flag = $card.find('.gabarit-width-flag .form-check-input').is(':checked')
      const fabric_height_flag = $card.find('.fabric-height-flag .form-check-input').is(':checked')
      const qty = Math.max(1, parseInt($card.find('.qty').val() || '1', 10))
      const selectFlags = {
        gabarit_width_flag,
        fabric_height_flag
      }
      const mergedPreselect = { ...selectFlags, ...preSelectsPriceOptions }

      if (!system || !section){
        return
      }

      if (!fabric || !fabric_color_code || !h || !w) {
        renderPriceOptions($card, 0, mergedPreselect)
        return
      }

      try {
        const data = await previewPrice({ url, system, section, fabric, fabric_color_code, h, w, gabarit_width_flag, fabric_height_flag })
        let posIndex = Number($card.find('.pos-index').text())
        pricesCache[posIndex] = data
        renderPriceOptions($card, 0, mergedPreselect)
      } catch (err) {
        $card.find('.h-mm').val(0)
        $card.find('.w-mm').val(0)
        window.showToast(err.message || 'Помилка розрахунку', 'danger')
      }
    }

    document.addEventListener('click', function (e) {
      const link = e.target.closest('.proposal-link')
      if (!link) return
      const url = link.dataset.proposalUrl || link.href
      if (!url) return
      e.preventDefault()
      if (isDirty) {
        const nextUrlInput = document.getElementById('nextUrlInput')
        const statusActionInput = document.getElementById('statusActionInput')
        if (nextUrlInput) nextUrlInput.value = url
        if (statusActionInput) statusActionInput.value = 'save'
        document.getElementById('orderForm').requestSubmit()
      } else {
        window.open(url, '_blank')
      }
    })

    function copySelectOptionsFromPrevCard($card, selectClass) {
      const $prev = $card.prev('.item-card')
      if ($prev.length === 0) {
        console.warn('No previous .item-card found!')
        return
      }
      const $currentSelect = $card.find(selectClass)
      const $prevSelect = $prev.find(selectClass)
      if ($currentSelect.length === 0 || $prevSelect.length === 0) {
        console.warn('Select not found in one of cards')
        return
      }
      const optionsHtml = $prevSelect.html()
      $currentSelect.html(optionsHtml)
      const prevValue = $prevSelect.val()
      $currentSelect.val(prevValue)
      $currentSelect.trigger('change')
    }

    let changingProgrammatically = false

    async function addRowWithData(item) {
      const idx = $container.children().length
      $container.append(itemTemplate(idx))
      const $card = $container.find('.item-card').last()

      changingProgrammatically = true

      initSelectsForCard($card)

      await fillSystems($card, item.system_sheet)
      await loadSectionsForSystem(item.system_sheet, $card)
      await fillSectionsForCard($card, item.system_sheet, item.table_section)
      await fillFabricsForCard($card, item.system_sheet, item.table_section, item.fabric_name)

      // 3) Колір тканини
      if (item.fabric_name) {
        try {
          const data = await loadFabricColors(item.fabric_name)
          await fillFabricColorsForCard($card, data.color_codes || [], item.fabric_color_code || null)
        } catch (e) {
          window.showToast(e.message || 'Не вдалося завантажити кольори тканини', 'danger')
          await fillFabricColorsForCard($card, [], item.fabric_color_code || null)
        }
      }

      /// 3) размеры
      if (item.height_gabarit_mm) $card.find('.h-mm').val(item.height_gabarit_mm)
      if (item.width_fabric_mm) $card.find('.w-mm').val(item.width_fabric_mm)
      $card.find('.gabarit-width-flag .form-check-input').prop('checked', !!item.gabarit_width_flag)
      updateGabaritHidden($card)
      $card.find('.fabric-height-flag .form-check-input').prop('checked', !!item.fabric_height_flag)
      updateFabricHeightHidden($card)
      if(item.control_side){
        $card.find('.control_side').removeClass("d-none")
        if (item.control_side) $card.find('.control_side select').val(item.control_side)
      }else{
        $card.find('.control_side').addClass("d-none")
      }
      

      // 5) количество
      $card.find('.qty').val(item.quantity || 1)

      setEventsFromGabarits($card)
      let preSelectsPriceOptions = {}
      priceOptionsConfig.forEach((option, index) => {
          let price = $card.find(`.${option.key} .price`).text() //item[option.key]
          let qty = item[option.key.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")]
          if(qty){
            preSelectsPriceOptions[option.key] = price
            preSelectsPriceOptions[option.key.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")] = qty
          }
      });

      preSelectsPriceOptions.base_price_eur = item.base_price_eur
      preSelectsPriceOptions.comment_system_red = item.comment_system_red
      preSelectsPriceOptions.comment_system_green = item.comment_system_green
      preSelectsPriceOptions.gb_width_mm = item.gb_width_mm
      preSelectsPriceOptions.GbDiffWidthMm = item.GbDiffWidthMm
      preSelectsPriceOptions.note = item.note

      preSelectsPriceOptions.gabarit_width_flag = item.gabarit_width_flag
      preSelectsPriceOptions.fabric_height_flag = item.fabric_height_flag

      await previewCard($card, preSelectsPriceOptions)

      changingProgrammatically = false

    }

    $('#addRow').on('click', async function () {
      const $prev = $container.find('.item-card').last()
      const prevVals = $prev.length ? readCardValues($prev) : null

      const idx = $container.children().length
      $container.append(itemTemplate(idx))
      const $card = $container.find('.item-card').last()

      initSelectsForCard($card)

      if (!systemsCache) {
          try {
              await loadSystems()
          } catch (e) {
              window.showToast('Не вдалося завантажити системи прайсу', 'danger')
              return
          }
      }
      fillSystems($card, prevVals?.system)

      if (prevVals && prevVals.system) {
        try {
          const sections = await loadSectionsForSystem(prevVals.system, $card)
          fillSectionsForCard($card, prevVals.system, prevVals.section)

          if (prevVals.section) {
            await fillFabricsForCard($card, prevVals.system, prevVals.section, prevVals.fabric)

            if (prevVals.fabric) {
              try {
                const data = await loadFabricColors(prevVals.fabric)
                fillFabricColorsForCard($card, data.color_codes || [], prevVals.fabric_color_code || null)
              } catch (e) {
                window.showToast(e.message || 'Не вдалося завантажити кольори тканини', 'danger')
                fillFabricColorsForCard($card, [], prevVals.fabric_color_code || null)
              }
              $card.find('.h-mm, .w-mm, .qty, .gabarit-width-flag, .fabric-height-flag').prop('disabled', false)
              $card.find('.gabarit-width-flag .form-check-input, .fabric-height-flag .form-check-input').prop('disabled', false)
            }

            //if (prevVals.h) $card.find('.h-mm').val(prevVals.h)
            //if (prevVals.w) $card.find('.w-mm').val(prevVals.w)
            // quantity: do not copy from previous card (always start with default)

            //$card.find('.gabarit-width-flag .form-check-input').prop('checked', !prevVals.gw)
            const cSideAllowed = sections?.exist_control_side
            const $csideWrap = $card.find('.control_side')
            if (cSideAllowed) {
              $csideWrap.removeClass("d-none")
            } else {
              $csideWrap.addClass("d-none")
              $csideWrap.find('select').val('')
            }
            
            setEventsFromGabarits($card)

            $card.find('.qty').val(1)
            const preOpts = { ...(prevVals.qtyPriceOptions || {}) }
            Object.keys(preOpts).forEach((k) => {
              if (k.endsWith('_qty')) preOpts[k] = 1
            })
            await previewCard($card, preOpts)

          }
        } catch (e) {
          window.showToast('Не вдалося завантажити секції/тканини', 'danger')
        }
      }
    })

    $container.on('click', '.remove-row', function () {
      if (isReadonlyFront) {
        return
      }
      const orderHasId = Boolean(builderOrderId)
      const orderStatus = '{{ order.status }}'
      if (orderHasId && orderStatus !== '{{ order.STATUS_QUOTE }}') {
        return
      }
      $(this).closest('.item-card').remove()
      recalcPrice()
    })

    $container.on('change', '.qty', function () {
      const v = parseInt(this.value || '1', 10)
      if (isNaN(v) || v < 1) this.value = 1
      renderPriceOptions($(this).closest('.item-card'), v)
    })

   // UA: Конфігурація додаткових опцій ціни
  // EN: Price options configuration
  const priceOptionsConfig = [
    {
      key: "magnets_price_eur",
      label: "Фіксація магнітами",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "cord_pvc_tension_price_eur",
      label: "Фіксація Леска ПВХ з дотяжкою (шт)",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "cord_copper_barrel_price_eur",
      label: "Фіксація Леска з мідною діжкою (шт)",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "top_pvc_clip_pair_price_eur",
      label: "Кліпса кріплення для верхньої планки ПВХ, пара",
      unit: "пара",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "top_pvc_bar_tape_price_eur_mp",
      label: "Доплата за верхню планку ПВХ зі скотчем (монтаж без свердління), за м.п.",
      unit: "м.п.",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "bottom_wide_bar_price_eur_mp",
      label: "Доплата за широку нижню планку 10/28, за м.п.",
      unit: "м.п.",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "top_bar_scotch_price_eur_mp",
      label: "Скотч на верхню планку для встановлення без свердління, за м.п.",
      unit: "м.п.",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "metal_kronsht_price_eur",
      label: "Доплата за металеві кронштейни, шт",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "metal_cord_fix_price_eur",
      label: "Фіксація лески металева",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "motor_no_remote_price_eur",
      label: "Доплата за електродвигун без пульта (під вимикач, вимикач в вартість не входить), шт",
      unit: "шт",
      type: "motor",
      defaultChecked: false,
    },
    {
      key: "motor_with_remote_price_eur",
      label: "Доплата за електродвигун з одноканальним пультом ДУ (входить до вартості), шт",
      unit: "шт",
      type: "motor",
      defaultChecked: false,
    },
    {
      key: "middle_bracket_price_eur",
      label: "Доплата за проміжковий кронштейн, шт",
      unit: "шт",
      type: "extra",
      defaultChecked: false,
    },
    {
      key: "remote_5ch_price_eur",
      label: "Доплата за 5-ти канальний пульт ДУ, шт",
      unit: "шт",
      type: "remote",
      defaultChecked: false,
      changeQty: true
    },
    {
      key: "remote_15ch_price_eur",
      label: "Доплата за 15-ти канальний пульт ДУ, шт",
      unit: "шт",
      type: "remote",
      defaultChecked: false,
      changeQty: true
    },
  ];

    // UA: Створює або повертає рядок опції в таблиці манифесту
    // EN: Create or get option row in manifest table
    function ensureOptionRow($card, optionName, labelText) {
      const $tbody = $card.find('.price-options-manifest')
      let $row = $tbody.find('.' + optionName + '-row')
      if ($row.length === 0) {
        $row = $(`
          <tr class="${optionName}-row">
            <td class="label">${labelText}</td>
            <td class="text-end">
              <span class="man-price-one" style="display:none;">0.00</span> 
              <div class="">
                <span class="man-price-one-uah">0.00</span>
              </div>
            </td>
            <td class="text-center">
              <span class="man-qty">0</span>
            </td>
            <td class="text-end">
              <span class="price" style="display:none;">0.00</span>
              <div class="">
                <span class="price-uah">0.00</span>
              </div>
            </td>
          </tr>
        `)
        $tbody.append($row)
      }
      return $row
    }


  function getDiscountMultiplier() {
      const pct = Number($('#customerDiscountValue').val() || 0)
      const safePct = Math.min(Math.max(pct, 0), 100)
      return 1 - safePct / 100
  }

  function recalcPrice() {
      let sumTotal = 0
      const discountMultiplier = getDiscountMultiplier()

      $('.item-card').each(function (_, card) {
        const $card = $(card)
        let sum = 0

        // база + надбавка
        const base = Number($card.find('.base').text() || 0)
        const surcharge = Number($card.find('.surcharge').text() || 0)

        sum += base + surcharge

        // опции: только те, что имеют строку в таблице
        priceOptionsConfig.forEach((opt) => {
          const nameOption = opt.key
          const $row = $card.find('.price-options-manifest .' + nameOption + '-row')
          if ($row.length === 0) return

          const $unit = $row.find('.man-price-one')
          const $qty = $row.find('.man-qty')
          const $total = $row.find('.price')

          const unitEur = Number($unit.text() || 0)

          const qty = Number($qty.text() || 0)
          const totalEur = unitEur * qty

          $total.text(money(totalEur))
          $row.find('.man-price-one-uah').text(eurToUah(unitEur))
          $row.find('.price-uah').text(eurToUah(totalEur))

          sum += totalEur
        })

        const discountedSum = sum * discountMultiplier
        console.log(discountMultiplier)

        // subtotal по позиции
        $card.find('.subtotal-input').text(money(discountedSum)).val(money(discountedSum))
        $card.find('.subtotal-uah').text(eurToUah(discountedSum))

        sumTotal += discountedSum
      })

      const markupPercent = Number($('#orderMarkup').val() || 0)
      const sumWithMarkup = sumTotal * (1 + markupPercent / 100)
      const extraServiceUah = Number($('#extraServiceAmount').val() || 0)
      const baseUah = eurToUahRaw(sumTotal)
      const withMarkupUah = eurToUahRaw(sumWithMarkup)

      $('#orderTotalBaseUah').text(String(Math.ceil(baseUah)))
      $('#orderTotal').text(money(sumTotal)) // hidden EUR base value for backend
      $('#orderTotalUah').text(String(Math.ceil(withMarkupUah + extraServiceUah)))
      $('#orderTotalInput').val(money(sumTotal))
    }

    $('#orderMarkup').on('input change', function () {
      recalcPrice()
    })
    $('#extraServiceAmount').on('input change', function () {
      recalcPrice()
    })
    

   function checkPriceOption(el, optionName, optionVal) {
      const $el = $(el)
      const $card = $el.closest('.item-card')
      const $block = $el.closest('.op-card')
      const $hidden = $block.find('.price-hidden')
      const $hiddenQty = $block.find('.qty-hidden')
      const $blockValQty = $block.find('.option-qty-value')
      const $buttons = $block.find('.qty-button')
      const labelText = $block.find('.option-title').text()
      const commonQty = Number($card.find('.qty').val() || 1)

      const gb_width_mm = Number($card.find('.gb_width_mm').val() || 0)
      const unitEur = Number(optionVal)

      if (el.checked) {
        // qty для опции = qty позиции
        const qty = commonQty > 0 ? commonQty : 1
        const gb = Number($card.find('.gb_width_mm').val() || 0)
        const unitEurEffective = calcOptionUnitEur(optionName, optionVal, gb)


        const totalEur = unitEurEffective * qty

        // скрытые поля (в EUR)
        $hidden.val(money(totalEur))
        $hiddenQty.val(qty)
        $blockValQty.text(qty)
        $buttons.prop('disabled', false)

        // строка в таблице
        const $row = ensureOptionRow($card, optionName, labelText)
        $row.find('.man-price-one').text(money(unitEurEffective))
        $row.find('.man-price-one-uah').text(eurToUah(unitEurEffective))
        $row.find('.man-qty').text(qty)
        $row.find('.price').text(money(totalEur))
        $row.find('.price-uah').text(eurToUah(totalEur))

      } else {
        // сброс
        $buttons.prop('disabled', true)
        $hidden.val(0)
        $hiddenQty.val(0)
        $blockValQty.text(0)

        // убираем строку опции из таблицы
        $card.find('.price-options-manifest .' + optionName + '-row').remove()
      }

      recalcPrice()
    }


    function changeQty(el, optionName, optionPrice, price, diffQty){
      const $card = $(el).closest('.item-card')
      let optionQty = Number($card.find(`[name="${optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")}"]`).val())
      optionQty = optionQty + Number(diffQty)

      setOneOption($card, optionName, optionQty, optionPrice, price)
      recalcPrice()
    }

    function syncOptionsQty($card) {
      const qty = Number($card.find('.qty').val() || 1)
      $card.find('.op-card.price-option-card').each(function () {
        const $block = $(this)
        if (!$block.find('.form-check-input').prop('checked')) return
        const optionName = ($block.attr('class').match(/op-card\s+(\S+)/) || [])[1] || ''
        const unitEur = Number($block.attr('data-unit-eur') || 0)
        setOneOption($card, optionName, qty, unitEur, 0)
      })
    }

    function setOneOption($card, optionName, optionQty, optionPrice, pricePerItemEur) {
      const $block = $card.find('.op-card.' + optionName)
      const unitEurData = Number($block.attr('data-unit-eur') || 0)
      if (!optionPrice && unitEurData) {
        optionPrice = unitEurData
      }
      const $hidden = $block.find('.price-hidden')
      const $hiddenQty = $block.find('.qty-hidden')
      const $blockValQty = $block.find('.option-qty-value')
      const labelText = $block.find('.option-title').text()
      const gb_width_mm = Number($card.find('.gb_width_mm').val() || 0)

      if (optionQty <= 0) {
        // выключаем опцию
        $block.find('.form-check-input').prop('checked', false)
        $hidden.val(0)
        $hiddenQty.val(0)
        $blockValQty.text(0)
        $card.find('.price-options-manifest .' + optionName + '-row').remove()
        recalcPrice()
        return
      }

      // включаем чекбокс
      $block.find('.form-check-input').prop('checked', true)

      const gb = Number($card.find('.gb_width_mm').val() || 0)
      const unitEurEffective = calcOptionUnitEur(optionName, optionPrice, gb)

      const totalEur = unitEurEffective * optionQty

      $hidden.val(money(totalEur))
      $hiddenQty.val(optionQty)
      $blockValQty.text(optionQty)

      const $row = ensureOptionRow($card, optionName, labelText)
      $row.find('.man-price-one').text(money(unitEurEffective))
      $row.find('.man-price-one-uah').text(eurToUah(unitEurEffective))
      $row.find('.man-qty').text(optionQty)
      $row.find('.price').text(money(totalEur))
      $row.find('.price-uah').text(eurToUah(totalEur))

      recalcPrice()
    }

    function changeQty(el, optionName, optionPrice, price, diffQty) {
      const $card = $(el).closest('.item-card')
      const qtyName = optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
      let optionQty = Number($card.find(`[name="${qtyName}"]`).val() || 0)
      optionQty = optionQty + Number(diffQty)
      $card.find(`[name="${qtyName}"]`).val(optionQty)
      setOneOption($card, optionName, optionQty, optionPrice, price)
    }

    function calcOptionUnitEur(optionName, optionPrice, gb_width_mm) {
      // UA: якщо опція за м.п.
      // EN: if price is per linear meter
      if (optionName.includes("_mp")) {
        return Number(optionPrice) * (Number(gb_width_mm) / 1000)
      }
      // UA: за штуку
      // EN: per piece
      return Number(optionPrice)
    }


   function renderOnePriceOption($card, optionPrice, option, commonQty, preSelectoptionQty) {
      const optionName = option.key
      const optionQtyName = optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
      if (!optionPrice) return

      let optionQty = 0
      if (preSelectoptionQty) {
        optionQty = Number(preSelectoptionQty)
      } else {
        optionQty = Number($card.find(`[name="${optionQtyName}"]`).val() || 0)
      }
      if (Number.isNaN(optionQty)) optionQty = 0

      {% comment %} const gb = Number($card.find('.gb_width_mm').val() || 0)
      const unitEur = calcOptionUnitEur(optionName, optionPrice, gb)

      const unitEurFormatted = money(unitEur)
      const unitUahFormatted = eurToUah(unitEur) {% endcomment %}

      let checkedAttr = ""
      let disabledAttr = "disabled"
      if (optionQty > 0 || commonQty > 0) {
        checkedAttr = "checked"
        disabledAttr = ""
      }

      if ($card.find('.' + optionName).length === 0) {
        let htmlPriceOption =
          `<div class="op-card ${optionName} price-option-card border rounded-3 mb-2 bg-light-subtle" data-unit-eur="${optionPrice}">`
          + `<div class="d-flex align-items-center justify-content-between gap-2">`
          +   `<div class="d-flex align-items-center gap-2">`
          +     `<input class="form-check-input price-option mt-0" type="checkbox"`
          +       ` onchange="checkPriceOption(this, '${optionName}', '${optionPrice}')" ${checkedAttr} />`
          +     `<div class="d-flex flex-column">`
          +       `<span class="fw-semibold option-title">${option.label}</span>`
          +     `</div>`
          +   `</div>`
          +   `<div class="text-end">`
          +     `<span class="badge rounded-pill text-bg-primary">`
          +       `<span class="price" style="display:none;">${optionPrice}</span>`
          +       `&nbsp;&nbsp;`
          +       `<span class="price-uah">${eurToUah(optionPrice)}</span>`
          +     `</span>`
          +   `</div>`
          + `</div>`

        if (option.changeQty) {
          htmlPriceOption +=
            `<div class="d-flex align-items-center justify-content-between mt-2">`
            + `<div class="btn-group btn-group-sm" role="group" aria-label="Кількість">`
            +   `<button type="button" class="btn btn-outline-secondary qty-button qty-minus"`
            +     ` onclick="javascript:changeQty(this, '${optionName}', ${optionPrice}, 0, -1)" ${disabledAttr}>`
            +     `<i class="bi bi-dash"></i>`
            +   `</button>`
            +   `<span class="option-qty-value px-2">${optionQty}</span>`
            +   `<button type="button" class="btn btn-outline-secondary qty-button qty-plus"`
            +     ` onclick="javascript:changeQty(this, '${optionName}', ${optionPrice}, 0, 1)" ${disabledAttr}>`
            +     `<i class="bi bi-plus"></i>`
            +   `</button>`
            + `</div>`
            + `</div>`
        }

        htmlPriceOption +=
          `<input class="price-hidden" type="hidden" name="${optionName}" value="0" />`
          + `<input class="qty-hidden" type="hidden" name="${optionQtyName}" value="${optionQty}" />`
          + `</div>`

        $card.find('.op-card-list').append(htmlPriceOption)
      } else {
        $card.find('.' + optionName).attr('data-unit-eur', optionPrice)
      }

      // если у нас уже есть qty > 0 (редактирование заказа) — сразу создаём строку в таблице
      if (optionQty > 0) {
        setOneOption($card, optionName, optionQty, optionPrice, 0)
      }
    }

    function enableCheckGabarit($card, GbDiffWidthMm, checked, heightChecked, systemName){
      const sys = (systemName || '').toString().toLowerCase()
      const isFlatSystem = sys.includes('плоска')

      const $gabarit = $card.find('.gabarit-width-flag')
      const $gabaritInput = $gabarit.find('.form-check-input')
      const $gabaritLabel = $gabarit.find('.gabarit-width-label')
      const $fabricHeight = $card.find('.fabric-height-flag')
      const $fabricHeightInput = $fabricHeight.find('.form-check-input')
      const $heightBlock = $card.find('.height-block')
      // Remember non-zero diff once to avoid hiding checkbox on later zeroed responses
      if (GbDiffWidthMm) {
        $card.data('gbDiffWidthMmPersist', GbDiffWidthMm)
      }
      const persistedGbDiff = $card.data('gbDiffWidthMmPersist') || GbDiffWidthMm
      const hasSavedWidth = Number($card.find('.gb_width_mm').val() || $card.find('.w-mm').val() || 0) > 0

      if (isFlatSystem) {
        $gabarit.show()
        $gabaritInput.prop('disabled', false)
        $gabaritLabel.text('Ширина по тканині')

        $fabricHeight.show()
        $fabricHeightInput.prop('disabled', false)
        $heightBlock.addClass('mt-3')

        $gabaritInput.prop('checked', !!checked)
        $fabricHeightInput.prop('checked', !!heightChecked)
        updateGabaritHidden($card)
        updateFabricHeightHidden($card)
      } else {
        const showGabarit = Boolean(persistedGbDiff) || !!checked || hasSavedWidth
        if (showGabarit) {
          $gabarit.show()
          $gabaritInput.prop('disabled', false)
          $gabaritLabel.text('Габаритна ширина')
          $gabaritInput.prop('checked', !!checked)
          $heightBlock.addClass('mt-3')
        } else {
          $gabarit.hide()
          $gabaritInput.prop('disabled', true).prop('checked', false)
          $heightBlock.removeClass('mt-3')
        }
        $fabricHeight.hide()
        $fabricHeightInput.prop('disabled', true).prop('checked', false)
        $fabricHeightInput.prop('checked', false)
        if (!showGabarit) {
          $heightBlock.removeClass('mt-3')
        }
        updateGabaritHidden($card)
        updateFabricHeightHidden($card)
      }
    }


    function renderPriceOptions($card, commonQty, preSelectsPriceOptions = {}) {
      let numberCard = Number($card.find('.pos-index').text())
      let data = pricesCache[numberCard]
      if (!data && Object.keys(preSelectsPriceOptions).length == 0) {
        previewCard($card)
        return
      }

      if (preSelectsPriceOptions.comment_system_red || data?.comment_system_red) {
        $card.find('.comment_system_red').html(preSelectsPriceOptions.comment_system_red ?? data?.comment_system_red)
      }
      if (preSelectsPriceOptions.comment_system_green || data?.comment_system_green) {
        $card.find('.comment_system_green').html(preSelectsPriceOptions.comment_system_green ?? data?.comment_system_green)
      }

      let GbDiffWidthMm = preSelectsPriceOptions.GbDiffWidthMm  ?? data?.GbDiffWidthMm
      const systemName = $card.find('.system-sheet').val()
      enableCheckGabarit(
        $card,
        GbDiffWidthMm,
        preSelectsPriceOptions.gabarit_width_flag,
        preSelectsPriceOptions.fabric_height_flag,
        systemName
      )

      let qty = Number($card.find('.qty').val() || 1)
      if (preSelectsPriceOptions.note) {
        $card.find('.item-note').val(preSelectsPriceOptions.note)
      }

      const baseOne = Number(data?.base_price_eur || preSelectsPriceOptions.base_price_eur || 0)
      const surchargeOne = Number(data?.surcharge_height_eur || preSelectsPriceOptions.surcharge_height_eur || 0)
      const baseTotal = baseOne * qty
      const surchargeTotal = surchargeOne * qty
      const displayTotal = baseTotal + surchargeTotal

      // Для відображення показуємо все як частину виробу,
      // але в бекенд відправляємо окремо допис висоти.
      $card.find('.base').text(money(displayTotal))
      $card.find('.base-input').val(money(baseTotal))

      $card.find('.surcharge').text('0.00')
      $card.find('.surcharge-input').val(money(surchargeTotal))
      const $surchargeRow = $card.find('.surcharge-row')
      $surchargeRow.addClass('d-none')

      const unitEur = baseOne + surchargeOne
      $card.find('.base-uah').text(eurToUah(unitEur))
      $card.find('.base-qty').text(qty)
      $card.find('.base-total-uah').text(eurToUah(displayTotal))
      $card.find('.surcharge-uah').text('0.00')

      $card.find('.gb_width_mm').val((Number(preSelectsPriceOptions.gb_width_mm || data?.gb_width_mm || 0)))

      priceOptionsConfig.forEach((option) => {
        const optionName = option.key
        const optionQtyName = optionName.replace("_price_eur_mp", "_qty").replace("_price_eur", "_qty")
        const price = preSelectsPriceOptions[optionName] ?? (data ? data[optionName]:undefined)
        renderOnePriceOption($card, price, option, commonQty, preSelectsPriceOptions[optionQtyName]);
      })

      recalcPrice()
    }


    $container.on('change', '.table-section', async function () {
      const $card = $(this).closest('.item-card')
      const system = $card.find('.system-sheet').val()
      const section = $(this).val()

      $card.find('.base,.surcharge,.magnets-price,.subtotal').text('0.00')
      $card.find('.base-uah,.base-qty,.base-total-uah,.surcharge-uah,.subtotal-uah').text('0.00')
      if (!system || !section) {
        return
      }
      await fillFabricsForCard($card, system, section, null)
    })

    $container.on('select2:select', '.fabric', async function (event) {

      const $card = $(this).closest('.item-card')
      const fabric = $(this).val()

      if (!fabric) {
        fillFabricColorsForCard($card, [], null)
        return
      }

      try {
        const data = await loadFabricColors(fabric)
        fillFabricColorsForCard($card, data.color_codes || [], null)
      } catch (e) {
        window.showToast(e.message || 'Не вдалося завантажити кольори тканини', 'danger')
        fillFabricColorsForCard($card, [], null)
      }

      previewCard($card)
    })

    $('#orderForm').on('submit', function (e) {
      let ok = true
      const $cust = $('#orderCustomer')
      if ($cust.length) {
        if (!$cust.val()) {
          ok = false
          $cust.addClass('is-invalid')
        } else {
          $cust.removeClass('is-invalid')
        }
      }
      $container.find('.item-card').each(function () {
        const $c = $(this)
        const sys = $c.find('.system-sheet').val()
        const sec = $c.find('.table-section').val()
        const fab = $c.find('.fabric').val()
        const fabc = $c.find('.fabric-color-code').val()

        if (!sys || !sec || !fab || !fabc) {
          ok = false
          if (!sys) $c.find('.system-sheet').addClass('is-invalid')
          if (!sec) $c.find('.table-section').addClass('is-invalid')
          if (!fab) $c.find('.fabric').addClass('is-invalid')
          if (!fabc) $c.find('.fabric-color-code').addClass('is-invalid')
          if(!$c.find('.control_side').hasClass("d-none")){
              if (!$c.find('.control_side select').val()) $c.find('.control_side select').addClass('is-invalid')
          }
        } else {
          $c.find('.system-sheet,.table-section,.fabric,.fabric-color-code,.control_side select').removeClass('is-invalid')
        }
      })
      if (!ok) {
        e.preventDefault()
        window.scrollTo({ top: 0, behavior: 'smooth' })
        window.showToast('Перевірте форму: клієнт та поля позицій мають бути заповнені', 'warning')
      }
    })

    $('#orderForm').on('click', 'button[data-status-action]', function (e) {
      const action = $(this).data('status-action') || 'save'
      if (action === 'save') {
        e.preventDefault()
        sendToWorkModal.show()
        return
      }
      if (action === 'to_work') {
        e.preventDefault()
        requestToWork()
        return
      }
      $('#statusActionInput').val(action)
    })

     // ---------- Ініціалізація ----------
    ;(async function () {
      try {
        await loadSystems()

        if (Array.isArray(builderItems) && builderItems.length > 0) {
          // UA: Режим редагування існуючого замовлення
          // EN: Edit mode – restore existing items
          for (const item of builderItems) {
            await addRowWithData(item)
          }
          recalcPrice()
        } else {
          // UA: Нове замовлення — одна порожня позиція
          // EN: New order – start with single empty card
          $('#addRow').trigger('click')
        }
      } catch (e) {
        console.error(e)
        window.showToast('Не вдалося завантажити системи прайсу', 'danger')
      } finally {
        finishInit()
      }
    })()
  </script>
{% endblock %}
