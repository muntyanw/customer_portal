{% extends 'core/dashboard_base.html' %}

{% block dashboard_title %}
  Нове замовлення
{% endblock %}

{% block dashboard_heading %}
  Комплектуючі, замовлення №{{ order.id|default:'null' }}
{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    .order-summary-bar {
      position: static;
      background: var(--bs-body-bg);
      border-bottom: 1px solid var(--bs-border-color);
      box-shadow: none;
      padding: 0.75rem 1rem;
    }
.order-total-bar {
  background: var(--bs-body-bg);
  border-top: 1px solid var(--bs-border-color);
}
    .component-card .price-box .kv {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-size: 0.9rem;
      color: var(--bs-secondary-color);
    }
    .component-card .price-box .sum {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      font-weight: 600;
      font-size: 1.05rem;
    }
    .order-summary-label {
      font-size: 0.8rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      font-weight: 700;
      color: var(--bs-body-color);
    }
    .order-summary-value {
      font-weight: 700;
      font-size: 1.35rem;
      color: var(--bs-body-color);
    }
    .order-summary-note {
      min-width: 260px;
    }
    @media (max-width: 576px) {
      .order-summary-bar {
        padding: 0.5rem 0.75rem;
      }
      .order-summary-label {
        font-size: 0.65rem;
      }
      .order-summary-value {
        font-size: 1.1rem;
      }
      .order-summary-bar .form-control-sm {
        padding: 0.3rem 0.5rem;
        font-size: 0.9rem;
      }
      .order-summary-bar .d-flex.flex-wrap {
        gap: 0.35rem;
      }
    }
    .readonly-mode .select2-container,
    .readonly-mode .select2-selection {
      pointer-events: none !important;
    }
  </style>
{% endblock %}

{% block dashboard_content %}
  <form method="post" id="componentsOrderForm" novalidate>
    {% csrf_token %}
    <input type="hidden" name="eur_rate_at_creation" class="eur_rate_at_creation" />
    <input type="hidden" name="status_action" id="statusActionInput" value="save" />
    <input type="hidden" name="next_url" id="nextUrlInput" value="" />
    <fieldset {% if readonly %}disabled{% endif %}>

    <div class="mb-3">
      <div class="small text-muted mb-2">
        Ознайомтесь, будь ласка, з технічними характеристиками і умовами. Клієнт самостійно несе відповідальність за правильність обраної системи, розмірів, комплектації та інші параметри.
      </div>
      <div class="d-flex flex-wrap align-items-center gap-2">
        <div class="d-flex flex-wrap gap-2">
          <a href="{{ PRICE_SHEET_URL }}" target="_blank" class="btn btn-primary btn-sm">Відкрити прайс (Комплектація)</a>
          <a href="https://docs.google.com/document/d/1uz2k8hqnaLxlmxB-u1BUmaEmW3pw4QIF/edit" target="_blank" class="btn btn-secondary btn-sm text-white">Технічні характеристики</a>
        </div>
        {% if request.user.is_manager or request.user.is_superuser %}
          <div class="ms-auto d-flex flex-column gap-1" style="min-width:260px;">
            <label class="form-label fw-semibold mb-0" for="componentsOrderCustomer">Клієнт</label>
            <select id="componentsOrderCustomer" name="customer_id" class="form-select form-select-sm">
              <option value="">— Оберіть клієнта —</option>
              {% for c in customers_filter_list %}
                <option value="{{ c.user.id }}" {% if order and order.customer_id == c.user.id %}selected{% endif %}>
                  {% if c.full_name %}{{ c.full_name }}{% else %}{{ c.user.email }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
        {% endif %}
        <div class="ms-auto d-flex align-items-center gap-2">
          <span class="text-muted small text-uppercase">Статус</span>
          <span class="badge bg-primary">
            {% if order %}{{ order.get_status_display }}{% else %}Прорахунок{% endif %}
          </span>
        </div>
      </div>
      <input type="url" class="form-control" id="componentsPriceUrl" name="price_url" value="{{ PRICE_SHEET_URL }}" required style="display: none;" />
    </div>

    <div class="order-summary-bar p-3 rounded-3 shadow-sm mb-3">
      <div class="d-flex flex-wrap align-items-end gap-3">
        <div class="d-flex flex-column">
          <div class="order-summary-label mb-1">Всього, грн</div>
          <div class="order-summary-value"><span id="componentsOrderTotalBaseUah">0.00</span></div>
        </div>
        <div class="d-flex flex-column">
          <label class="order-summary-label mb-1" for="orderMarkup">Націнка на роздріб, %</label>
          <input
            type="number"
            step="0.01"
            min="0"
            class="form-control form-control-sm"
            id="orderMarkup"
            name="markup_percent"
            value="{{ order.markup_percent|default:'0'|floatformat:2 }}"
          />
        </div>
        <div class="d-flex flex-column">
          <div class="order-summary-label mb-1">З націнкою</div>
          <div class="order-summary-value"><span id="componentsOrderTotalUah">0.00</span></div>
        </div>
        <div class="flex-grow-1 order-summary-note ms-lg-auto">
          <label class="order-summary-label mb-1" for="componentsOrderNote">Примітка до замовлення</label>
          <input
            type="text"
            class="form-control form-control-sm"
            id="componentsOrderNote"
            name="note"
            placeholder="Коротка примітка..."
            value="{{ order.note|default_if_none:'' }}"
            {% if readonly %}disabled{% endif %}
          />
        </div>
      </div>
      <div class="d-none">
        <span id="componentsOrderTotal">0.00</span>
      </div>
    </div>

    <div class="row g-2 align-items-end mb-3">
      <div class="col-12 col-md-6">
        <label class="form-label small fw-semibold" for="extraServiceLabel">Додаткова послуга</label>
        <input
          type="text"
          class="form-control"
          id="extraServiceLabel"
          name="extra_service_label"
          placeholder="Доставка, монтаж тощо"
          value="{{ order.extra_service_label|default_if_none:'' }}"
          {% if readonly %}disabled{% endif %}
        />
      </div>
      <div class="col-12 col-md-3">
        <label class="form-label small fw-semibold" for="extraServiceAmount">Сума, грн</label>
          <input
            type="number"
            step="0.01"
            min="0"
            class="form-control"
            id="extraServiceAmount"
            name="extra_service_amount_uah"
            value="{{ order.extra_service_amount_uah|default_if_none:'0'|floatformat:2 }}"
            {% if readonly %}disabled{% endif %}
          />
      </div>
    </div>

    <!-- Контейнер для карток комплектуючих -->
    <div id="componentsContainer" class="d-flex flex-column gap-3"></div>

    <div class="d-grid mt-2">
      <button type="button" class="btn btn-outline-primary" id="addComponentRow">
        <i class="bi bi-plus-lg me-1"></i> Додати комплектуючу
      </button>
    </div>

    <!-- Підсумок по замовленню -->
    <div class="order-total-bar mt-3 p-3 rounded-3 shadow-sm">
      {% if not readonly %}
        <div class="d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-primary" name="status_action" value="save" data-status-action="save">Зберегти</button>
          {% if order %}
            {% if order.status == order.STATUS_QUOTE %}
              <button type="submit" class="btn btn-success" name="status_action" value="to_work" data-status-action="to_work">В роботу</button>
            {% endif %}
            {% if request.user.is_manager %}
              <div class="ms-auto d-flex gap-2">
                {% if order.prev_status %}
                  <button type="submit" class="btn btn-outline-primary" name="status_action" value="prev" data-status-action="prev">Попередній статус</button>
                {% endif %}
                {% if next_status_label %}
                  <button type="submit" class="btn btn-outline-primary" name="status_action" value="next" data-status-action="next">
                    Наступний статус{% if next_status_label %}: {{ next_status_label }}{% endif %}
                  </button>
                {% endif %}
              </div>
            {% endif %}
          {% else %}
            <button type="submit" class="btn btn-success" name="status_action" value="to_work" data-status-action="to_work">В роботу</button>
          {% endif %}
        </div>
      {% endif %}
      {% if proposal_page_url or proposal_excel_url %}
        <div class="d-flex flex-wrap gap-2 mt-2">
          {% if proposal_page_url %}
            <a class="btn btn-warning text-dark proposal-link" href="{{ proposal_page_url }}" data-proposal-url="{{ proposal_page_url }}" target="_blank">
              <i class="bi bi-eye me-1"></i> Комерційна пропозиція (сторінка)
            </a>
          {% endif %}
          {% if proposal_excel_url %}
            <a class="btn btn-success proposal-link" href="{{ proposal_excel_url }}" data-proposal-url="{{ proposal_excel_url }}">
              <i class="bi bi-file-earmark-excel me-1"></i> Комерційна пропозиція (Excel)
            </a>
          {% endif %}
        </div>
      {% endif %}
    </div>
    </fieldset>
  </form>

  <div class="modal fade" id="unsavedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Зберегти зміни?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Є незбережені зміни. Бажаєте зберегти замовлення?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="unsavedExitBtn">Вийти без збереження</button>
          <button type="button" class="btn btn-primary" id="unsavedSaveBtn">Зберегти</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="sendToWorkModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Відправити замовлення в роботу?</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Відправити замовлення в роботу після збереження?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="sendToWorkSkipBtn">Не відправляти</button>
          <button type="button" class="btn btn-success" id="sendToWorkBtn">Відправити</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Оплата замовлення</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0" id="paymentModalText" style="white-space: pre-wrap;"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" id="paymentCancelBtn">Не відправляти</button>
          <button type="button" class="btn btn-success" id="paymentConfirmBtn">Відправити</button>
        </div>
      </div>
    </div>
  </div>

  {% if status_logs %}
    <div class="card border-0 shadow-sm mt-3">
      <div class="card-body">
        <h6 class="mb-3">Історія статусів</h6>
        <div class="list-group list-group-flush">
          {% for log in status_logs %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold">{{ log.get_status_display }}</div>
                <div class="small text-muted">{{ log.created_at|date:'d.m.Y H:i' }}</div>
              </div>
                {% if log.user %}<div class="small text-muted">{{ log.user }}</div>{% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  {% endif %}

  {# Шаблон однієї картки комплектуючої #}
  <template id="component-item-template">
    <div class="component-card card shadow-sm" data-index>
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">
            Позиція <span class="pos-index">1</span>
          </div>
          {% if order.status == order.STATUS_QUOTE %}
            <button type="button" class="btn btn-sm btn-outline-danger remove-row">
              <i class="bi bi-trash"></i>
            </button>
          {% endif %}
        </div>

        <div class="row g-2 mb-2">
          <div class="col-md-5">
            <label class="form-label small mb-1">Найменування</label>
            <select class="form-select form-select-sm component-name" data-field="name" required>
              <option value="" selected disabled>— Оберіть найменування —</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label small mb-1">Колір</label>
            <select class="form-select form-select-sm component-color" data-field="color">
              <option value="">— Будь-який колір —</option>
            </select>
          </div>
          <div class="col-md-1">
            <label class="form-label small mb-1">Од. вим.</label>
            <input type="text" class="form-control form-control-sm component-unit" data-field="unit" readonly disabled />
          </div>
          <div class="col-md-1">
            <label class="form-label small mb-1">Ціна за од.</label>
            <div class="text-end">
              <input type="text"
                     class="form-control form-control-sm text-end component-price d-none"
                     data-field="price_eur"
                     readonly
                     disabled />
              <input type="text"
                     class="form-control form-control-sm text-end component-price-uah"
                     readonly
                     disabled />
            </div>
          </div>
          <div class="col-md-1">
            <label class="form-label small mb-1">Кількість</label>
            <input type="number" min="0" step="0.001" class="form-control form-control-sm text-end component-qty" data-field="quantity" value="1" />
          </div>
          <div class="col-md-2">
            <label class="form-label small mb-1">Сума по позиції</label>
            <div class="form-control form-control-sm text-end bg-light">
              <div class="d-none">
                <span class="component-subtotal">0.00</span> €
              </div>
              <div>
                <span class="component-subtotal-uah">0.00</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Приховані інпути для сабміту (буде налаштовано в JS) -->
        <div class="d-none hidden-fields">
          <input type="hidden" data-field="name" />
          <input type="hidden" data-field="color" />
          <input type="hidden" data-field="unit" />
          <input type="hidden" data-field="price_eur" />
          <input type="hidden" data-field="quantity" />
        </div>
      </div>
    </div>
  </template>
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    // UA: Виводимо тости ближче до центру екрана на сторінці білдера комплектуючих
    window.showToast = function (message, type = "primary") {
      const id = "toast-" + Math.random().toString(36).slice(2)
      const html = `
        <div id="${id}" class="toast align-items-center text-bg-${type} border-0 position-fixed top-50 start-50 translate-middle shadow"
             role="alert" aria-live="assertive" aria-atomic="true" style="z-index: 2000;">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      `
      document.body.insertAdjacentHTML("beforeend", html)
      const el = document.getElementById(id)
      const toast = new bootstrap.Toast(el, { delay: 9000 })
      toast.show()
      el.addEventListener("hidden.bs.toast", () => el.remove())
    }

    // EN: Global builder context from Django
    // UA: Глобальний контекст білдера з Django
    const builderOrderId = {{ order.id|default:"null" }};
    const builderComponents = {{ components_json|safe|default:"[]" }};
    const paymentMessage = "{{ payment_message_text|default:''|escapejs }}"
    const paymentShortageRaw = "{{ payment_shortage.shortage|default:''|escapejs }}"
    const paymentShortage = paymentShortageRaw ? parseFloat(paymentShortageRaw.replace(',', '.')) : null
    const paymentShortageOrders = {{ payment_shortage.orders|default:"[]"|safe }}
    const isManager = {{ request.user.is_manager|yesno:"true,false" }}
    const isOwner = {{ request.user.id }} === {{ order.customer_id|default:request.user.id }}
    const isReadonlyFront = {{ readonly|yesno:"true,false" }}

    let isDirty = false;
    let pendingExitUrl = null;
    let unsavedModal = null;
    let sendToWorkModal = null;
    let paymentModal = null;
    let suppressDirty = true;
    let initWait = 2;

    function finishInit() {
      initWait -= 1;
      if (initWait <= 0) {
        suppressDirty = false;
      }
    }

    function markDirty() {
      if (suppressDirty) return;
      isDirty = true;
    }

    function submitWithAction(action) {
      $('#statusActionInput').val(action);
      isDirty = false;
      document.getElementById('componentsOrderForm').requestSubmit();
    }

    function buildPaymentMessage() {
      const rawOrders = Array.isArray(paymentShortageOrders) ? paymentShortageOrders : []
      const orderIds = []
      if (builderOrderId) orderIds.push(builderOrderId)
      rawOrders.forEach((id) => {
        if (id && !orderIds.includes(id)) orderIds.push(id)
      })
      let msg = "Обов'язково вкажіть у платежі в полі «Призначення платежу» наступний текст:\n\n" + paymentMessage
      if (paymentShortage !== null && orderIds.length) {
        msg += "\n\nЗамовлення №" + orderIds.join(", №") + " на суму " + paymentShortage + " грн"
      }
      return msg
    }

    function requestToWork() {
      if (isOwner && paymentMessage) {
        const msg = buildPaymentMessage()
        const box = document.getElementById('paymentModalText')
        if (box) box.textContent = msg
        paymentModal.show()
        return
      }
      submitWithAction('to_work')
    }

    function enforceReadonlyComponents() {
      if (!isReadonlyFront) return;
      const $form = $('#componentsOrderForm');
      $form.addClass('readonly-mode');
      $form.find('input, select, textarea, button').prop('disabled', true);
      $form.find('select').prop('disabled', true).trigger('change.select2');
      $form.find('a').prop('disabled', false);
      $('#addComponentRow').off('click');
      $form.on('mousedown.readonly click.readonly', 'select, .select2-selection', function (e) {
        e.preventDefault();
        return false;
      });
    }

    const componentsPriceUrlInput = $('#componentsPriceUrl');
    const $componentsContainer = $('#componentsContainer');

    // EN: EUR rate (may come as "49,3149" → we normalize)
    // UA: Курс EUR (може бути з комою, нормалізуємо)
    const eur_rate = parseFloat('{{ builder_rate|default:"0.00" }}'.replace(',', '.')) || 0;
    const markup_initial = parseFloat('{{ order.markup_percent|default:"0" }}'.replace(',', '.')) || 0;

    // EN: Data cache from /api/v1/pricing/components-list
    // UA: Кеш даних з /api/v1/pricing/components-list
    let componentsData = null;             // { items, names, units, colors }
    let componentsItemsByName = new Map(); // name -> items[]

    // ---------- Helpers ----------
    document.addEventListener('DOMContentLoaded', function () {
      if ({{ readonly|yesno:"true,false" }}) {
        $('#componentsOrderForm').find('input, select, textarea, button').prop('disabled', true)
        $('#componentsOrderForm').find('a').prop('disabled', false)
      }
      if (isReadonlyFront) {
        const $form = $('#componentsOrderForm');
        $form.find('input, select, textarea, button').prop('disabled', true);
        $form.find('a').prop('disabled', false);
      }
      const markupInput = document.getElementById('orderMarkup');
      if (markupInput) {
        const normMarkup = normalizeNumber(markup_initial, 0);
        markupInput.value = normMarkup.toFixed(2);
      }
      const nextUrlInput = document.getElementById('nextUrlInput');

      $('#componentsOrderForm').on('input change', 'input, select, textarea', function () {
        if (this.type === 'hidden') return;
        markDirty();
      });

      window.addEventListener('beforeunload', function (e) {
        if (!isDirty) return;
        const msg = 'Є незбережені зміни. Ви впевнені, що хочете вийти?';
        e.preventDefault();
        e.returnValue = msg;
        return msg;
      });

      $('#componentsOrderForm').on('submit', function () {
        isDirty = false;
      });

      unsavedModal = new bootstrap.Modal(document.getElementById('unsavedModal'));
      sendToWorkModal = new bootstrap.Modal(document.getElementById('sendToWorkModal'));
      paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));

      document.getElementById('unsavedSaveBtn').addEventListener('click', function () {
        if (nextUrlInput) nextUrlInput.value = pendingExitUrl || '';
        unsavedModal.hide();
        sendToWorkModal.show();
      });

      document.getElementById('unsavedExitBtn').addEventListener('click', function () {
        isDirty = false;
        if (nextUrlInput) nextUrlInput.value = '';
        unsavedModal.hide();
        if (pendingExitUrl) {
          window.location.href = pendingExitUrl;
        }
      });

      document.getElementById('sendToWorkBtn').addEventListener('click', function () {
        sendToWorkModal.hide();
        requestToWork();
      });

      document.getElementById('sendToWorkSkipBtn').addEventListener('click', function () {
        sendToWorkModal.hide();
        submitWithAction('save');
      });

      document.getElementById('paymentConfirmBtn').addEventListener('click', function () {
        paymentModal.hide();
        submitWithAction('to_work');
      });

      document.getElementById('paymentCancelBtn').addEventListener('click', function () {
        paymentModal.hide();
      });

      document.addEventListener('click', function (e) {
        const link = e.target.closest('a');
        if (!link) return;
        const href = link.getAttribute('href') || '';
        if (!href || href.startsWith('#') || link.target === '_blank' || link.hasAttribute('download')) return;
        if (!isDirty) return;
        e.preventDefault();
        pendingExitUrl = link.href;
        unsavedModal.show();
      });

      document.addEventListener('click', function (e) {
        const link = e.target.closest('.proposal-link');
        if (!link) return;
        const url = link.dataset.proposalUrl || link.href;
        if (!url) return;
        e.preventDefault();
        if (isDirty) {
          const nextUrlInput = document.getElementById('nextUrlInput');
          const statusActionInput = document.getElementById('statusActionInput');
          if (nextUrlInput) nextUrlInput.value = url;
          if (statusActionInput) statusActionInput.value = 'save';
          document.getElementById('componentsOrderForm').requestSubmit();
        } else {
          window.open(url, '_blank');
        }
      });

      enforceReadonlyComponents();
      finishInit();
    })

    function normalizeUnit(unit) {
      return (unit || '').toString().trim().toLowerCase();
    }

    function isPieceUnit(unit) {
      const norm = normalizeUnit(unit).replace(/\s+/g, '').replace(/\./g, '');
      return norm === 'шт' || norm.startsWith('шт');
    }

    function applyQtyInputSettings($card) {
      const unit = $card.find('.component-unit').val() || '';
      const $qty = $card.find('.component-qty');
      if (isPieceUnit(unit)) {
        $qty.attr('step', '1');
        const v = Math.max(0, Math.floor(parseFloat(($qty.val() || '0').toString().replace(',', '.')) || 0));
        $qty.val(v);
      } else {
        $qty.attr('step', '0.001');
      }
    }

    function money(x) {
      return (Math.round(parseFloat(x || 0) * 100) / 100).toFixed(2);
    }

    // UA: Нормалізуємо число з можливою комою в крапку
    function normalizeNumber(val, fallback = 0) {
      const num = parseFloat((val ?? '').toString().replace(',', '.'));
      return Number.isFinite(num) ? num : fallback;
    }

    // UA: Перевід EUR → UAH (тільки фронт)
    // EN: Convert EUR → UAH (frontend only)
    function eurToUahRaw(x) {
      return Number(x || 0) * Number(eur_rate || 0);
    }
    function eurToUah(x) {
      return money(eurToUahRaw(x));
    }
    function uahTotal(x) {
      return String(Math.ceil(eurToUahRaw(x)));
    }

    function getCsrf() {
      const m = document.querySelector('meta[name="csrf-token"]');
      if (m && m.content) return m.content;
      const match = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
      return match ? decodeURIComponent(match[1]) : '';
    }

    function componentItemTemplate(index) {
      const tpl = document.getElementById('component-item-template');
      const node = tpl.content.cloneNode(true);
      const $node = $(node);

      $node.find('.pos-index').text(index + 1);
      $node.find('[data-index]').attr('data-index', index);

      // UA: Прописуємо name для hidden-полів: components[IDX][field]
      // EN: Set name attributes for hidden inputs: components[IDX][field]
      $node.find('.hidden-fields [data-field]').each(function () {
        const field = this.getAttribute('data-field');
        this.name = `components[${index}][${field}]`;
      });

      return node;
    }

    // ---------- Select2 init ----------

    function initSelectsForComponentCard($card) {
      $card.find('.component-name').select2({
        width: '100%',
        dropdownParent: $card
      });

      $card.find('.component-color').select2({
        width: '100%',
        dropdownParent: $card,
        allowClear: true,
        placeholder: '— Будь-який колір —'
      });
    }

    // ---------- Loading components from API ----------

    async function loadComponentsList() {
      if (componentsData) return componentsData;

      const url = componentsPriceUrlInput.val();
      if (!url) {
        throw new Error('No price URL for components');
      }

      showGlobalLoader();
      const resp = await fetch(
        `/api/v1/pricing/components-list?url=${encodeURIComponent(url)}`
      );
      hideGlobalLoader();

      if (!resp.ok) {
        const err = await resp.json().catch(() => ({ detail: 'Error' }));
        throw new Error(err.detail || 'Не вдалося завантажити комплектуючі');
      }

      let data;
      try {
        data = await resp.json();
      } catch (err) {
        console.error('components-list: invalid JSON', err);
        throw new Error('Невірний формат даних комплектуючих');
      }
      componentsData = data;

      // build name -> items map
      componentsItemsByName = new Map();
      (data.items || []).forEach((item) => {
        const name = item.name || '';
        if (!componentsItemsByName.has(name)) {
          componentsItemsByName.set(name, []);
        }
        componentsItemsByName.get(name).push(item);
      });

      return data;
    }

    // ---------- Fill selects for card ----------

    async function fillNamesForComponentCard($card, preselectName) {
      try {
        if (!componentsData) {
          await loadComponentsList();
        }
      } catch (err) {
        window.showToast((err && err.message) ? err.message : 'Не вдалося завантажити комплектуючі з прайсу', 'danger');
        return;
      }
      const $sel = $card.find('.component-name');
      $sel.empty();
      $sel.append('<option value="" selected disabled>— Оберіть найменування —</option>');
      (componentsData.names || []).forEach((name) => {
        $sel.append(new Option(name, name));
      });

      if (preselectName && (componentsData.names || []).includes(preselectName)) {
        $sel.val(preselectName);
      } else {
        $sel.val(null);
      }
      try {
        $sel.trigger('change');
      } catch (err) {
        console.error('fillNamesForComponentCard: change handler failed', err);
        window.showToast('Не вдалося оновити вибір комплектуючих', 'danger');
      }
    }

    function fillColorsForComponentCard($card, name, preselectColor) {
      if (!componentsData) return;
      const $sel = $card.find('.component-color');
      $sel.empty();
      $sel.append('<option value="">— Будь-який колір —</option>');

      let colors = [];
      if (name && componentsItemsByName.has(name)) {
        const items = componentsItemsByName.get(name);
        const set = new Set();
        items.forEach((it) => {
          if (it.color) set.add(it.color);
        });
        colors = Array.from(set).sort();
      } else {
        colors = componentsData ? (componentsData.colors || []) : [];
      }

      colors.forEach((color) => {
        $sel.append(new Option(color, color));
      });

      if (preselectColor && colors.includes(preselectColor)) {
        $sel.val(preselectColor);
      } else {
        $sel.val('');
      }
      $sel.trigger('change');
    }

    function autoFillUnitAndPrice($card) {
      const name = $card.find('.component-name').val() || '';
      const color = $card.find('.component-color').val() || '';

      let unit = '';
      let price = '';

      if (componentsItemsByName.has(name)) {
        const items = componentsItemsByName.get(name);
        // EN: Try exact match by color first, then fallback to first
        // UA: Спочатку пробуємо знайти за кольором, потім перший елемент
        let candidate = items.find((it) => (it.color || '') === (color || ''));
        if (!candidate) candidate = items[0];

      if (candidate) {
        unit = candidate.unit || '';
        price = candidate.price_eur || '';
      }
    }

    $card.find('.component-unit').val(unit);
    const priceNum = normalizeNumber(price, 0);
    $card.find('.component-price').val(priceNum ? money(priceNum) : '');
    $card.find('.component-price-uah').val(eurToUah(priceNum));
    applyQtyInputSettings($card);

      updateHiddenFieldsFromCard($card);
      recalcComponentsPrice();
    }

    // ---------- Read / write card values ----------

    function readComponentCardValues($card) {
      return {
        name: $card.find('.component-name').val() || '',
        color: $card.find('.component-color').val() || '',
        unit: $card.find('.component-unit').val() || '',
        price_eur: $card.find('.component-price').val() || '',
        quantity: $card.find('.component-qty').val() || '1'
      };
    }

    function updateHiddenFieldsFromCard($card) {
      const values = readComponentCardValues($card);
      const $hiddenContainer = $card.find('.hidden-fields');

      $hiddenContainer.find('[data-field="name"]').val(values.name);
      $hiddenContainer.find('[data-field="color"]').val(values.color);
      $hiddenContainer.find('[data-field="unit"]').val(values.unit);
      $hiddenContainer.find('[data-field="price_eur"]').val(values.price_eur);
      $hiddenContainer.find('[data-field="quantity"]').val(normalizeNumber(values.quantity, 1));
    }

    function recalcComponentsPrice() {
      let sumTotal = 0;

      $componentsContainer.find('.component-card').each(function () {
        const $card = $(this);
        const price = normalizeNumber($card.find('.component-price').val(), 0);
        const qty = normalizeNumber($card.find('.component-qty').val(), 0);

        const subtotal = price * qty;

        // EUR
        $card.find('.component-subtotal').text(money(subtotal));
        // UAH
        $card.find('.component-subtotal-uah').text(eurToUah(subtotal));
        // Unit UAH (на случай ручного изменения цены)
        $card.find('.component-price-uah').val(eurToUah(price));

        sumTotal += subtotal;

        // keep hidden fields in sync
        updateHiddenFieldsFromCard($card);
      });

      const markupPercent = Number($('#orderMarkup').val() || 0);
      const sumWithMarkup = sumTotal * (1 + markupPercent / 100);
      const extraServiceUah = Number($('#extraServiceAmount').val() || 0);
      const baseUah = eurToUahRaw(sumTotal);
      const withMarkupUah = eurToUahRaw(sumWithMarkup);

      $('#componentsOrderTotal').text(money(sumTotal));
      $('#componentsOrderTotalBaseUah').text(String(Math.ceil(baseUah + extraServiceUah)));
      $('#componentsOrderTotalUah').text(String(Math.ceil(withMarkupUah + extraServiceUah)));
    }

    // ---------- Add / remove rows ----------

    async function addComponentRowWithData(initial) {
      const idx = $componentsContainer.children().length;
      $componentsContainer.append(componentItemTemplate(idx));
      const $card = $componentsContainer.find('.component-card').last();
      $card.attr('data-index', idx);

      initSelectsForComponentCard($card);

      await loadComponentsList();
      await fillNamesForComponentCard($card, initial?.name || null);
      fillColorsForComponentCard($card, initial?.name || null, initial?.color || null);

      if (initial?.unit) {
        $card.find('.component-unit').val(initial.unit);
      }
      if (initial?.price_eur) {
        const priceNum = parseFloat(initial.price_eur.toString().replace(',', '.'));
        $card.find('.component-price').val(money(priceNum));
        $card.find('.component-price-uah').val(eurToUah(priceNum));
      }
      if (initial?.quantity) {
        $card.find('.component-qty').val(normalizeNumber(initial.quantity, 1));
      }
      applyQtyInputSettings($card);

      // якщо нема явної ціни — спробуємо взяти з прайсу
      if (!initial?.price_eur && initial?.name) {
        autoFillUnitAndPrice($card);
      } else {
        updateHiddenFieldsFromCard($card);
        recalcComponentsPrice();
      }
    }

    $('#orderMarkup').on('input change', function () {
      recalcComponentsPrice();
    });
    $('#extraServiceAmount').on('input change', function () {
      recalcComponentsPrice();
    });

    $('#addComponentRow').on('click', async function () {
      await addComponentRowWithData(null);
    });

    $componentsContainer.on('click', '.remove-row', function () {
      $(this).closest('.component-card').remove();

      // Перенумерация позиций
      $componentsContainer.find('.component-card').each(function (i) {
        const $card = $(this);
        $card.attr('data-index', i);
        $card.find('.pos-index').text(i + 1);
        $card.find('.hidden-fields [data-field]').each(function () {
          const field = this.getAttribute('data-field');
          this.name = `components[${i}][${field}]`;
        });
      });

      recalcComponentsPrice();
    });

    // ---------- Events ----------

    $componentsContainer.on('change', '.component-name', function () {
      const $card = $(this).closest('.component-card');
      const name = $(this).val() || '';
      fillColorsForComponentCard($card, name, null);
      autoFillUnitAndPrice($card);
    });

    $componentsContainer.on('change', '.component-color', function () {
      const $card = $(this).closest('.component-card');
      autoFillUnitAndPrice($card);
    });

    $componentsContainer.on('input', '.component-qty', function () {
      const $card = $(this).closest('.component-card');
      const unit = $card.find('.component-unit').val() || '';
      let v = parseFloat((this.value || '0').toString().replace(',', '.'));
      if (isNaN(v) || v < 0) v = 0;
      if (isPieceUnit(unit)) {
        v = Math.floor(v);
      }
      this.value = v;
      updateHiddenFieldsFromCard($(this).closest('.component-card'));
      recalcComponentsPrice();
    });

    // ---------- Submit validation ----------

    $('#componentsOrderForm').on('submit', function (e) {
      let ok = true;

      const $cards = $componentsContainer.find('.component-card');
      if ($cards.length === 0) {
        ok = false;
      }

      $cards.each(function () {
        const $c = $(this);
        const name = $c.find('.component-name').val();
        const qty = normalizeNumber($c.find('.component-qty').val(), 0);

        if (!name || qty <= 0) {
          ok = false;
          if (!name) {
            $c.find('.component-name').addClass('is-invalid');
          }
          if (qty <= 0) {
            $c.find('.component-qty').addClass('is-invalid');
          }
        } else {
          $c.find('.component-name, .component-qty').removeClass('is-invalid');
        }
      });

      if (!ok) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: 'smooth' });
        window.showToast('Заповніть найменування та кількість для кожної комплектуючої', 'warning');
      }
    });

    $('#componentsOrderForm').on('click', 'button[data-status-action]', function (e) {
      const action = $(this).data('status-action') || 'save';
      if (action === 'save') {
        e.preventDefault();
        sendToWorkModal.show();
        return;
      }
      if (action === 'to_work') {
        e.preventDefault();
        requestToWork();
        return;
      }
      $('#statusActionInput').val(action);
    });

    // ---------- Init ----------

    (async function () {
      try {
        await loadComponentsList();

        // записываем курс в hidden для бека
        $('.eur_rate_at_creation').val(eur_rate);
        if ({{ request.user.is_manager|yesno:"true,false" }} || {{ request.user.is_superuser|yesno:"true,false" }}) {
          $('#componentsOrderCustomer').select2({
            width: '100%',
            placeholder: 'Оберіть клієнта',
            allowClear: true,
          });
        }

        if (Array.isArray(builderComponents) && builderComponents.length > 0) {
          // EN: Edit mode — restore existing components
          // UA: Редагування існуючого замовлення — відновлюємо позиції
          for (const item of builderComponents) {
            await addComponentRowWithData(item);
          }
          recalcComponentsPrice();
        } else {
          // EN: New order – start with single empty card
          // UA: Нове замовлення — одна порожня позиція
          $('#addComponentRow').trigger('click');
        }
      } catch (e) {
        console.error(e);
        window.showToast(e?.message || 'Не вдалося завантажити комплектуючі з прайсу', 'danger');
      } finally {
        finishInit();
      }
    })();
  </script>
{% endblock %}
