{% extends 'core/dashboard_base.html' %}

{% block head_extra %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block dashboard_title %}{% if request.user.is_manager %}Баланси{% else %}Баланс{% endif %}{% endblock %}
{% block dashboard_heading %}
  <div class="d-flex align-items-center gap-3 flex-wrap">
    <span>{% if request.user.is_manager %}Баланси{% else %}Баланс{% endif %}</span>
    <span class="{% if filtered_balance < 0 %}text-danger{% else %}text-success{% endif %}">
      {{ filtered_balance|default_if_none:0|floatformat:0 }} грн
    </span>
  </div>
{% endblock %}

{% block dashboard_content %}
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form id="balancesFilterForm" method="get" class="row g-2 align-items-end">
        <div class="col-auto">
          <label class="form-label mb-1">Статус</label>
          <select name="status" class="form-select form-select-sm" style="min-width: 160px;">
            <option value="">Усі</option>
            {% for code,label in statuses %}
              <option value="{{ code }}" {% if status_filter == code %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
          </select>
        </div>
        {% if customer_options %}
          <div class="col-auto">
            <label class="form-label mb-1">Клієнт</label>
            <select name="customer" id="balancesCustomerFilter" class="form-select form-select-sm" style="min-width: 180px;">
              <option value="">Усі</option>
              {% for c in customer_options %}
                <option value="{{ c.id }}" {% if customer_filter|add:'0' == c.id|add:'0' %}selected{% endif %}>
                  {% if c.customerprofile.full_name %}{{ c.customerprofile.full_name }}{% else %}{{ c }}{% endif %}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-auto">
            <div class="form-check mt-4">
              <input class="form-check-input" type="checkbox" id="negativeOnly" name="negative" value="1" {% if negative_only %}checked{% endif %}>
              <label class="form-check-label" for="negativeOnly">Негативні баланси</label>
            </div>
          </div>
        {% endif %}
        <div class="col-auto">
          <label class="form-label mb-1">Тип</label>
          <select name="type" class="form-select form-select-sm" style="min-width: 180px;">
            <option value="" {% if not type_filter %}selected{% endif %}>Усі</option>
            <option value="orders" {% if type_filter == 'orders' %}selected{% endif %}>Замовлення</option>
            <option value="transactions" {% if type_filter == 'transactions' %}selected{% endif %}>Транзакції</option>
          </select>
        </div>
        <div class="col-auto d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-primary btn-sm">Фільтрувати</button>
          <a href="{% url 'orders:balances' %}" class="btn btn-outline-secondary btn-sm">Скинути</a>
        </div>
        <div class="col ms-auto d-flex justify-content-end flex-wrap gap-2">
          {% if customer_options %}
            <a href="{% url 'orders:transaction_create' %}?{% if customer_filter %}customer={{ customer_filter }}{% endif %}" class="btn btn-outline-primary">
              <i class="bi bi-cash-coin me-1"></i> Нова транзакція
            </a>
          {% endif %}
          {% with query=request.GET.urlencode %}
            <a href="{% url 'orders:balances_excel' %}{% if query %}?{{ query }}{% endif %}" class="btn btn-success btn-sm">
              <i class="bi bi-download me-1"></i> Експорт балансу (Excel)
            </a>
          {% endwith %}
          {% if balance_page_url %}
            <a href="{{ balance_page_url }}" target="_blank" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-link-45deg me-1"></i> Експорт балансу (сторінка)
            </a>
          {% endif %}
        </div>
      </form>
    </div>
  </div>

  {% if events %}
    <div class="d-flex flex-column gap-3">
      {% for e in events %}
        {% if e.type == 'order' %}
          {% with o=e.object %}
          {% if o.component_items.all|length %}
            {% url 'orders:order_components_builder' o.id as order_view_url %}
          {% else %}
            {% url 'orders:builder_edit' o.id as order_view_url %}
          {% endif %}
          {% include 'orders/partials/order_card.html' with order=o view_url=order_view_url show_type=True show_rate=True show_last_status=True status_badges=status_badges proposal_page_urls=proposal_page_urls proposal_excel_urls=proposal_excel_urls %}
          {% endwith %}
        {% else %}
          {% with tx=e.object %}
          {% include 'orders/partials/transaction_card.html' with tx=tx is_manager=is_manager %}
          {% endwith %}
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center text-muted py-5">
      <i class="bi bi-inbox fs-1 d-block mb-2"></i>
      Поки немає записів.
    </div>
  {% endif %}
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const $customer = $('#balancesCustomerFilter');
      if ($customer.length) {
        $customer.select2({
          width: '100%',
          allowClear: true,
        });
      }

      const form = document.getElementById('balancesFilterForm');
      if (form) {
        const storageKey = 'balancesFilters';
        const readFields = () => {
          const data = {};
          form.querySelectorAll('select[name], input[name]').forEach((el) => {
            data[el.name] = el.value || '';
          });
          return data;
        };
        const writeFields = (data) => {
          Object.keys(data || {}).forEach((name) => {
            const el = form.querySelector(`[name="${name}"]`);
            if (!el) return;
            if (window.jQuery && el.classList.contains('select2-hidden-accessible')) {
              $(el).val(data[name] || '').trigger('change');
            } else if (el.type === 'checkbox') {
              el.checked = data[name] === '1' || data[name] === 'on';
            } else {
              el.value = data[name] || '';
            }
          });
        };

        const hasQuery = window.location.search && window.location.search.length > 1;
        if (hasQuery) {
          try { localStorage.setItem(storageKey, JSON.stringify(readFields())); } catch (e) {}
        } else {
          try {
            const saved = localStorage.getItem(storageKey);
            if (saved) {
              writeFields(JSON.parse(saved));
              form.requestSubmit();
            }
          } catch (e) {}
        }

        form.addEventListener('change', function () {
          try { localStorage.setItem(storageKey, JSON.stringify(readFields())); } catch (e) {}
        });
        form.addEventListener('submit', function () {
          try { localStorage.setItem(storageKey, JSON.stringify(readFields())); } catch (e) {}
        });
      }
    });
  </script>
{% endblock %}
