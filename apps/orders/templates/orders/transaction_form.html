{% extends 'core/dashboard_base.html' %}

{% block dashboard_title %}Нова транзакція{% endblock %}
{% block dashboard_heading %}Нова транзакція{% endblock %}

{% block dashboard_content %}
  <div class="card shadow-sm">
    <div class="card-body">
      <form method="post" class="d-flex flex-column gap-3">
        {% csrf_token %}
        {% if form.non_field_errors %}
          <div class="alert alert-danger mb-0">
            {{ form.non_field_errors }}
          </div>
        {% endif %}

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Клієнт</label>
            <input type="text" class="form-control form-control-sm mb-2" id="customerSearch" placeholder="Почніть вводити ПІБ, телефон або email">
            {{ form.customer }}
          </div>
          <div class="col-md-3">
            <label class="form-label">Тип</label>
            {{ form.type }}
          </div>
          <div class="col-md-3">
            <label class="form-label">Вид оплати</label>
            {{ form.payment_type }}
          </div>
          <div class="col-md-3">
            <label class="form-label">Сума, грн</label>
            {{ form.amount }}
            <div class="form-text">Зберігаємо в EUR за курсом {{ current_rate|default:"-" }} грн</div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Замовлення</label>
            <div class="dropdown w-100" id="orderPicker">
              <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" data-order-toggle>
                Оберіть замовлення
              </button>
              <div class="dropdown-menu w-100 p-2" data-order-menu>
                <input type="text" class="form-control form-control-sm mb-2" id="orderSearch" placeholder="Пошук за номером або назвою">
                <div class="order-options" style="max-height: 240px; overflow-y: auto;"></div>
              </div>
            </div>
            <div class="d-none">
              {{ form.orders }}
            </div>
          </div>
          <div class="col-md-6" data-account-group>
            <label class="form-label">Номер рахунку (для «На рахунок»)</label>
            {{ form.account_number }}
          </div>
          <div class="col-12">
            <label class="form-label">Коментар</label>
            {{ form.description }}
          </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
          <a href="{% url 'orders:list' %}" class="btn btn-outline-secondary">Скасувати</a>
          <button type="submit" class="btn btn-primary">Зберегти</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    (function() {
      const searchInput = document.getElementById("customerSearch");
      const select = document.querySelector("select[data-customer-picker]");
      if (!searchInput || !select) return;
      const options = Array.from(select.options);

      const expandList = () => {
        // показуємо список як лістбокс, щоб одразу бачити варіанти
        const visible = options.filter((opt) => !opt.hidden);
        const size = Math.min(Math.max(visible.length, 2), 10);
        select.size = size;
        select.dataset.open = "true";
      };

      const collapseList = () => {
        select.size = 1;
        delete select.dataset.open;
      };

      const filter = () => {
        const query = (searchInput.value || "").trim().toLowerCase();
        options.forEach((opt) => {
          if (!opt.value) {
            opt.hidden = false;
            return;
          }
          const parts = opt.text.toLowerCase().split("·").map((p) => p.trim()).filter(Boolean);
          const matches = !query || parts.some((part) => part.includes(query));
          // обраний залишаємо видимим, щоб його було видно навіть при іншому фільтрі
          opt.hidden = matches ? false : (select.value !== opt.value);
        });
        expandList();
      };

      searchInput.addEventListener("input", filter);
      searchInput.addEventListener("focus", filter);
      select.addEventListener("focus", expandList);
      const blurTimeout = () => setTimeout(() => collapseList(), 150);
      searchInput.addEventListener("blur", blurTimeout);
      select.addEventListener("blur", blurTimeout);

      // початковий стан — звужений
      collapseList();
    })();

    // filter orders multiselect
    (function() {
      const select = document.querySelector("select[data-order-picker]");
      const picker = document.getElementById("orderPicker");
      if (!select || !picker) return;
      const toggleBtn = picker.querySelector("[data-order-toggle]");
      const menu = picker.querySelector("[data-order-menu]");
      const optionsWrap = menu.querySelector(".order-options");
      const searchInput = document.getElementById("orderSearch");

      const updateSummary = () => {
        const selected = Array.from(select.selectedOptions).filter((opt) => opt.value);
        toggleBtn.textContent = selected.length ? `Вибрано: ${selected.length}` : "Оберіть замовлення";
      };

      const buildOptions = () => {
        optionsWrap.innerHTML = "";
        Array.from(select.options).forEach((opt) => {
          if (!opt.value) return;
          const item = document.createElement("div");
          item.className = "form-check";
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.className = "form-check-input";
          cb.id = `order-opt-${opt.value}`;
          cb.value = opt.value;
          cb.checked = opt.selected;
          cb.dataset.text = opt.text.toLowerCase();
          const label = document.createElement("label");
          label.className = "form-check-label";
          label.htmlFor = cb.id;
          label.textContent = opt.text;
          cb.addEventListener("change", () => {
            opt.selected = cb.checked;
            updateSummary();
          });
          item.appendChild(cb);
          item.appendChild(label);
          optionsWrap.appendChild(item);
        });
      };

      const filter = () => {
        const query = (searchInput.value || "").trim().toLowerCase();
        optionsWrap.querySelectorAll(".form-check").forEach((item) => {
          const cb = item.querySelector("input");
          const match = !query || cb.dataset.text.includes(query);
          item.classList.toggle("d-none", !match);
        });
      };

      toggleBtn.addEventListener("click", () => {
        menu.classList.toggle("show");
      });

      document.addEventListener("click", (e) => {
        if (!picker.contains(e.target)) {
          menu.classList.remove("show");
        }
      });

      searchInput.addEventListener("input", filter);
      buildOptions();
      updateSummary();
    })();

    // toggle account number visibility based on payment type
    (function() {
      const paymentField = document.getElementById("id_payment_type");
      const accountGroup = document.querySelector("[data-account-group]");
      const accountInput = document.getElementById("id_account_number");
      if (!paymentField || !accountGroup || !accountInput) return;
      const toggle = () => {
        if (paymentField.value === "cash") {
          accountGroup.classList.add("d-none");
          accountInput.removeAttribute("required");
          accountInput.value = "";
        } else {
          accountGroup.classList.remove("d-none");
          accountInput.setAttribute("required", "required");
        }
      };
      paymentField.addEventListener("change", toggle);
      toggle();
    })();
  </script>
{% endblock %}
