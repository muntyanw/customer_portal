{% extends "core/dashboard_base.html" %}
{% load form_tags %}

{% block head_extra %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% block dashboard_title %}Користувачі{% endblock %}
{% block dashboard_heading %}Користувачі{% endblock %}

{% block dashboard_content %}
  <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
    <form method="get" class="d-flex flex-wrap align-items-center gap-2 w-100 flex-md-nowrap">
      <select name="customer" id="clientsCustomerFilter" class="form-select form-select-sm" style="min-width: 240px;" data-placeholder="Усі клієнти">
        <option value="">Усі клієнти</option>
        {% for c in customer_options %}
          <option value="{{ c.id }}" {% if customer_filter|add:'0' == c.id|add:'0' %}selected{% endif %}>
            {% if c.customerprofile.full_name %}{{ c.customerprofile.full_name }}{% else %}{{ c }}{% endif %}
          </option>
        {% endfor %}
      </select>
      <input type="search" name="q" value="{{ q }}" class="form-control form-control-sm flex-grow-1" placeholder="Пошук (ПІБ, email, телефон)">
      <button type="submit" class="btn btn-primary btn-sm">Фільтрувати</button>
      <a href="{% url 'accounts:clients_list' %}" class="btn btn-outline-secondary btn-sm">Скинути</a>
    </form>
    <div class="ms-auto d-flex align-items-center gap-2 flex-wrap">
      <div class="btn-group btn-group-sm" role="group" aria-label="Сортування">
        <a class="btn btn-outline-primary {% if sort == 'full_name' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=full_name">Ім'я</a>
        <a class="btn btn-outline-primary {% if sort == '-full_name' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=-full_name">Ім'я ↓</a>
        <a class="btn btn-outline-primary {% if sort == 'email' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=email">Email</a>
        <a class="btn btn-outline-primary {% if sort == '-email' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=-email">Email ↓</a>
        <a class="btn btn-outline-primary {% if sort == 'phone' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=phone">Телефон</a>
        <a class="btn btn-outline-primary {% if sort == '-phone' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=-phone">Телефон ↓</a>
        <a class="btn btn-outline-primary {% if sort == 'company' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=company">Компанія</a>
        <a class="btn btn-outline-primary {% if sort == '-company' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=-company">Компанія ↓</a>
        <a class="btn btn-outline-primary {% if sort == 'balance' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=balance">Баланс</a>
        <a class="btn btn-outline-primary {% if sort == '-balance' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=-balance">Баланс ↓</a>
        <a class="btn btn-outline-primary {% if sort == 'discount' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=discount">Знижка</a>
        <a class="btn btn-outline-primary {% if sort == '-discount' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=-discount">Знижка ↓</a>
        <a class="btn btn-outline-primary {% if sort == 'credit' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=credit">Кредит</a>
        <a class="btn btn-outline-primary {% if sort == '-credit' %}active{% endif %}" href="?{% if q %}q={{ q }}&amp;{% endif %}{% if customer_filter %}customer={{ customer_filter }}&amp;{% endif %}sort=-credit">Кредит ↓</a>
      </div>
      <a href="{% url 'accounts:client_create' %}" class="btn btn-success"><i class="bi bi-plus-lg me-1"></i> Створити акаунт</a>
    </div>
  </div>

  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="d-none d-md-block border-bottom bg-light">
        <div class="row g-2 align-items-center px-3 py-2 text-uppercase small fw-semibold text-muted">
          <div class="col-12 col-md-1"></div>
          <div class="col-12 col-md">Назва компанії</div>
          <div class="col-12 col-md"><a href="?{% if q %}q={{ q }}&amp;{% endif %}sort={% if sort == 'full_name' %}-full_name{% else %}full_name{% endif %}">ПІБ</a></div>
          <div class="col-12 col-md"><a href="?{% if q %}q={{ q }}&amp;{% endif %}sort={% if sort == 'email' %}-email{% else %}email{% endif %}">Email</a></div>
          <div class="col-6 col-md">Телефон</div>
          <div class="col-6 col-md">Баланс</div>
          <div class="col-6 col-md-auto">Знижка, %</div>
          <div class="col-6 col-md-auto">Кредит</div>
          <div class="col-6 col-md-auto">Менеджер</div>
          <div class="col-12 col-md-3">Дії</div>
        </div>
      </div>

      {% for u in clients %}
        <div class="border-bottom">
          <div class="row g-3 align-items-center px-3 py-3">
            <div class="col-12 col-md-1 d-flex justify-content-start justify-content-md-center">
              {% if u.customerprofile.avatar %}
                <img src="{{ u.customerprofile.avatar.url }}" alt="avatar" class="rounded-circle" width="40" height="40">
              {% else %}
                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width:40px; height:40px;">
                  <span class="fw-bold">{{ u.email|default:"?"|slice:":1"|upper }}</span>
                </div>
              {% endif %}
            </div>
            <div class="col-12 col-md">
              <div class="fw-semibold">{% firstof u.customerprofile.company_name u.customerprofile.organization.name "—" %}</div>
              <div class="text-muted small d-md-none">{{ u.customerprofile.phone|default:"—" }}</div>
            </div>
            <div class="col-12 col-md">
              <div class="fw-semibold">{{ u.customerprofile.full_name|default:"—" }}</div>
              <div class="text-muted small d-md-none">{{ u.email }}</div>
            </div>
            <div class="col-12 col-md">
              <div>{{ u.email }}</div>
              <div class="d-md-none text-muted small mt-1">
                {% firstof u.customerprofile.company_name u.customerprofile.organization.name "—" %}
              </div>
            </div>
            <div class="col-6 col-md">
              {{ u.customerprofile.phone|default:"—" }}
            </div>
            <div class="col-6 col-md">
              {% with bal=balances|get_item:u.id %}
                <a class="{% if bal < 0 %}text-danger{% else %}text-success{% endif %}"
                   href="{% url 'orders:balances' %}?customer={{ u.id }}">
                  {{ bal|default:"0.00" }}
                </a>
              {% endwith %}
            </div>
            <div class="col-6 col-md-auto">
              <form method="post" class="discount-form d-inline-flex align-items-center gap-1">
                {% csrf_token %}
                <input type="hidden" name="action" value="set_discount">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <div class="input-group input-group-sm">
                  <input
                    type="number"
                    min="-100"
                    max="100"
                    step="0.01"
                    name="discount_percent"
                    value="{{ u.customerprofile.discount_percent|default_if_none:0|stringformat:'0.2f' }}"
                    class="form-control discount-input"
                    data-initial="{{ u.customerprofile.discount_percent|default_if_none:0|stringformat:'0.2f' }}"
                    data-raw-value="{{ u.customerprofile.discount_percent|default_if_none:0|stringformat:'0.2f' }}"
                    placeholder="0"
                    aria-label="Знижка %"
                  >
                  <button type="submit" class="btn btn-primary save-discount-btn d-none">Зберегти</button>
                </div>
              </form>
            </div>
            <div class="col-6 col-md-auto">
              <form method="post" class="d-inline-flex align-items-center gap-1">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_credit">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <input class="form-check-input" type="checkbox" name="credit_allowed" value="1" {% if u.customerprofile.credit_allowed %}checked{% endif %} onchange="this.form.submit()">
              </form>
            </div>
            <div class="col-6 col-md-auto">
              <form method="post" class="d-inline-flex align-items-center gap-1">
                {% csrf_token %}
                <input type="hidden" name="action" value="toggle_manager">
                <input type="hidden" name="user_id" value="{{ u.id }}">
                <input class="form-check-input" type="checkbox" name="is_manager" value="1" {% if u.is_manager %}checked{% endif %} onchange="this.form.submit()">
              </form>
            </div>
            <div class="col-12 col-md-3">
              <div class="d-flex flex-wrap gap-2">
                <a href="{% url 'accounts:profile_other' u.id %}" class="btn btn-sm btn-secondary">Переглянути</a>
                {% if request.user.is_superuser %}
                  <a href="{% url 'accounts:profile_password_change' u.id %}" class="btn btn-sm btn-warning text-dark">Змінити пароль</a>
                {% endif %}
                <a href="{% url 'orders:transaction_create' %}?customer={{ u.id }}" class="btn btn-sm btn-success">Створити транзакцію</a>
              </div>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="text-center text-muted py-4">
          Немає клієнтів
        </div>
      {% endfor %}
    </div>
  </div>
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const $customer = $('#clientsCustomerFilter');
      if ($customer.length) {
        $customer.select2({
          width: '100%',
          placeholder: $customer.data('placeholder') || 'Усі клієнти',
          allowClear: true,
        });
        $customer.on('change', function () {
          const form = document.querySelector('form[method=\"get\"]');
          if (form) form.submit();
        });
      }

      const form = document.querySelector('form[method="get"]');
      if (form) {
        const storageKey = 'clientsFilters';
        const readFields = () => {
          const data = {};
          form.querySelectorAll('select[name], input[name]').forEach((el) => {
            data[el.name] = el.value || '';
          });
          return data;
        };
        const writeFields = (data) => {
          Object.keys(data || {}).forEach((name) => {
            const el = form.querySelector(`[name="${name}"]`);
            if (!el) return;
            if (window.jQuery && el.classList.contains('select2-hidden-accessible')) {
              $(el).val(data[name] || '').trigger('change');
            } else {
              el.value = data[name] || '';
            }
          });
        };

        const hasQuery = window.location.search && window.location.search.length > 1;
        if (hasQuery) {
          try { localStorage.setItem(storageKey, JSON.stringify(readFields())); } catch (e) {}
        } else {
          try {
            const saved = localStorage.getItem(storageKey);
            if (saved) {
              writeFields(JSON.parse(saved));
              form.requestSubmit();
            }
          } catch (e) {}
        }

        form.addEventListener('change', function () {
          try { localStorage.setItem(storageKey, JSON.stringify(readFields())); } catch (e) {}
        });
        form.addEventListener('submit', function () {
          try { localStorage.setItem(storageKey, JSON.stringify(readFields())); } catch (e) {}
        });
      }

      document.querySelectorAll('.discount-input').forEach(function (input) {
        const form = input.closest('.discount-form')
        const button = form ? form.querySelector('.save-discount-btn') : null
        const initial = parseFloat((input.dataset.initial || '0').replace(',', '.'))
        const rawValue = input.dataset.rawValue
        if (rawValue !== undefined && rawValue !== '') {
          input.value = rawValue
          input.dataset.initial = rawValue
        }
        const toggleButton = function () {
          if (!button) return
          const value = parseFloat((input.value || '0').replace(',', '.'))
          if (isNaN(value)) {
            button.classList.remove('d-none')
            return
          }
          button.classList.toggle('d-none', value === initial)
        }
        input.addEventListener('input', toggleButton)
        toggleButton()
      })
    })
  </script>
{% endblock %}
