{% extends "core/dashboard_base.html" %}
{% load form_tags %}
{% block dashboard_title %}Профіль користувача{% endblock %}
{% block dashboard_heading %}
  {% if is_creation %}
    Створення клієнта
  {% elif target_user and target_user != request.user %}
    Профіль клієнта
  {% else %}
    Мій профіль
  {% endif %}
{% endblock %}

{% block dashboard_content %}
<div class="row justify-content-center">
  <div class="col-12 col-lg-8">
    <div class="card border-0 shadow-sm rounded-4">
      <div class="card-body p-4">
        <div class="d-flex align-items-center mb-4">
          {% if profile_instance and profile_instance.avatar %}
            <img src="{{ profile_instance.avatar.url }}" class="rounded-circle border me-3 avatar-click" width="72" height="72" alt="avatar" role="button" title="Змінити аватар">
          {% else %}
            <img src="/static/media/avatar.png" class="rounded-circle border me-3 avatar-click" width="72" height="72" alt="avatar" role="button" title="Змінити аватар">
          {% endif %}
          <div>
            <h2 class="h5 fw-semibold mb-0">{{ target_user.email }}</h2>
            {% if target_user.is_superuser %}
              <span class="badge bg-danger">Admin</span>
            {% elif target_user.is_staff %}
              <span class="badge bg-primary">Staff</span>
            {% endif %}
            {% if target_user.is_manager %}
              <span class="badge bg-warning text-dark">Manager</span>
            {% endif %}
            {% if target_user.is_customer and not target_user.is_manager %}
              <span class="badge bg-light text-dark">Customer</span>
            {% endif %}
          </div>
        </div>

        <form method="post" enctype="multipart/form-data" novalidate>
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-semibold">Email (логін)</label>
              {{ form.email|add_class:"form-control form-control-lg" }}
              {% if form.email.errors %}<div class="invalid-feedback d-block">{{ form.email.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Номер телефону *</label>
              {{ form.phone|add_class:"form-control form-control-lg" }}
              {% if form.phone.errors %}<div class="invalid-feedback d-block">{{ form.phone.errors|striptags }}</div>{% endif %}
            </div>
            {% if form.password %}
              <div class="col-md-6">
                <label class="form-label fw-semibold">Пароль</label>
                {{ form.password|add_class:"form-control form-control-lg" }}
                {% if form.password.errors %}<div class="invalid-feedback d-block">{{ form.password.errors|striptags }}</div>{% endif %}
              </div>
            {% endif %}
            {% if form.password2 %}
              <div class="col-md-6">
                <label class="form-label fw-semibold">Підтвердження пароля</label>
                {{ form.password2|add_class:"form-control form-control-lg" }}
                {% if form.password2.errors %}<div class="invalid-feedback d-block">{{ form.password2.errors|striptags }}</div>{% endif %}
              </div>
            {% endif %}
            <div class="col-md-6">
              <label class="form-label fw-semibold">Назва компанії *</label>
              {{ form.company_name|add_class:"form-control form-control-lg" }}
              {% if form.company_name.errors %}<div class="invalid-feedback d-block">{{ form.company_name.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">ПІБ</label>
              {{ form.full_name|add_class:"form-control form-control-lg" }}
              {% if form.full_name.errors %}<div class="invalid-feedback d-block">{{ form.full_name.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Адреса торгової точки</label>
              {{ form.trade_address|add_class:"form-control form-control-lg" }}
              {% if form.trade_address.errors %}<div class="invalid-feedback d-block">{{ form.trade_address.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Додаткові контакти</label>
              {{ contact_formset.management_form }}
              <div id="contactsContainer" class="d-flex flex-column gap-2">
                {% for cform in contact_formset %}
                  <div class="row g-2 align-items-end contact-row" data-form>
                    {{ cform.contact_id }}
                    {{ cform.DELETE|add_class:"d-none" }}
                    <div class="col-md-4">
                      <label class="form-label mb-1">Номер телефону *</label>
                      {{ cform.phone|add_class:"form-control" }}
                      {% if cform.phone.errors %}<div class="invalid-feedback d-block">{{ cform.phone.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-4">
                      <label class="form-label mb-1">Контактне лице *</label>
                      {{ cform.contact_name|add_class:"form-control" }}
                      {% if cform.contact_name.errors %}<div class="invalid-feedback d-block">{{ cform.contact_name.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-3">
                      <label class="form-label mb-1">Email</label>
                      {{ cform.email|add_class:"form-control" }}
                      {% if cform.email.errors %}<div class="invalid-feedback d-block">{{ cform.email.errors|striptags }}</div>{% endif %}
                    </div>
                    <div class="col-md-1 d-flex">
                      <button type="button" class="btn btn-outline-danger w-100 remove-contact">Видалити</button>
                    </div>
                  </div>
                {% endfor %}
              </div>
              <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="addContactBtn">
                <i class="bi bi-plus-lg me-1"></i>Додати контакт
              </button>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Спосіб доставки *</label>
              {{ form.delivery_method|add_class:"form-select form-select-lg" }}
              {% if form.delivery_method.errors %}<div class="invalid-feedback d-block">{{ form.delivery_method.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-md-6" id="deliveryBranchField">
              <label class="form-label fw-semibold">Вантажне відділення (від 200кг)</label>
              {{ form.delivery_branch|add_class:"form-control form-control-lg" }}
              {% if form.delivery_branch.errors %}<div class="invalid-feedback d-block">{{ form.delivery_branch.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-12">
              <label class="form-label fw-semibold">Примітка</label>
              {{ form.note|add_class:"form-control" }}
              {% if form.note.errors %}<div class="invalid-feedback d-block">{{ form.note.errors|striptags }}</div>{% endif %}
            </div>
            <div class="col-12">
              {{ form.avatar|add_class:"d-none" }}
              {% if form.avatar.errors %}<div class="invalid-feedback d-block">{{ form.avatar.errors|striptags }}</div>{% endif %}
            </div>
            {% if can_edit_credit and form.credit_allowed %}
              <div class="col-12">
                <div class="form-check mt-2">
                  {{ form.credit_allowed|add_class:"form-check-input" }}
                  <label class="form-check-label fw-semibold">&nbsp;Можливий кредит </label>
                </div>
              </div>
            {% endif %}
            {% if can_edit_role and form.is_manager %}
              <div class="col-12">
                <div class="form-check mt-2">
                  {{ form.is_manager|add_class:"form-check-input" }}
                  <label class="form-check-label fw-semibold">&nbsp;Роль: менеджер</label>
                </div>
              </div>
            {% endif %}
          </div>

          <div class="d-grid mt-4">
            <button type="submit" class="btn btn-primary btn-lg">
              <i class="bi bi-save me-2"></i>Зберегти зміни
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .avatar-click { cursor: pointer; }
  </style>
{% endblock %}

{% block body_extra %}
  {{ block.super }}
  <script>
    // EN: Auto fade flash messages; UA: Автоматичне згасання повідомлень
    setTimeout(() => {
      document.querySelectorAll('.alert').forEach(el => {
        new bootstrap.Alert(el).close();
      });
    }, 4000);

    document.addEventListener('DOMContentLoaded', function () {
      const avatarTrigger = document.querySelector('.avatar-click');
      const avatarInput = document.getElementById('id_avatar');
      if (avatarTrigger && avatarInput) {
        avatarTrigger.addEventListener('click', () => avatarInput.click());
      }

      const methodSelect = document.getElementById('id_delivery_method');
      const branchField = document.getElementById('deliveryBranchField');
      const contactsContainer = document.getElementById('contactsContainer');
      const addContactBtn = document.getElementById('addContactBtn');
      const totalForms = document.getElementById('id_contacts-TOTAL_FORMS');
      const emptyIndex = () => parseInt(totalForms.value || '0', 10);

      function toggleBranchField() {
        if (!methodSelect || !branchField) return;
        const show = methodSelect.value === 'nova_poshta';
        branchField.classList.toggle('d-none', !show);
      }

      function bindRemove(btn) {
        btn.addEventListener('click', function () {
          const row = btn.closest('[data-form]');
          if (!row) return;
          const delInput = row.querySelector('input[name$="-DELETE"]');
          if (delInput) {
            delInput.checked = true;
          }
          row.classList.add('d-none');
        });
      }

      function formatPhone(val) {
        const digits = (val || '').replace(/\D/g, '').slice(0, 10);
        const parts = [];
        if (digits.length > 0) parts.push(digits.slice(0, 3));
        if (digits.length > 3) parts.push(digits.slice(3, 6));
        if (digits.length > 6) parts.push(digits.slice(6, 8));
        if (digits.length > 8) parts.push(digits.slice(8, 10));
        return parts.join('-');
      }

      function bindPhoneMask(input) {
        if (!input) return;
        input.addEventListener('input', function () {
          this.value = formatPhone(this.value);
        });
      }

      if (methodSelect) {
        methodSelect.addEventListener('change', toggleBranchField);
        toggleBranchField();
      }

      contactsContainer.querySelectorAll('.remove-contact').forEach(bindRemove);
      // mask existing phone fields
      bindPhoneMask(document.getElementById('id_phone'));
      contactsContainer.querySelectorAll('input[name$="-phone"]').forEach(bindPhoneMask);

      if (addContactBtn) {
        addContactBtn.addEventListener('click', function () {
          const idx = emptyIndex();
          const row = document.createElement('div');
          row.className = 'row g-2 align-items-end contact-row';
          row.setAttribute('data-form', '1');
          row.innerHTML = `
            <input type="hidden" name="contacts-${idx}-contact_id" id="id_contacts-${idx}-contact_id">
            <input type="checkbox" name="contacts-${idx}-DELETE" id="id_contacts-${idx}-DELETE" class="d-none">
            <div class="col-md-4">
              <label class="form-label mb-1">Номер телефону *</label>
              <input type="text" name="contacts-${idx}-phone" class="form-control" id="id_contacts-${idx}-phone">
            </div>
            <div class="col-md-4">
              <label class="form-label mb-1">Контактне лице *</label>
              <input type="text" name="contacts-${idx}-contact_name" class="form-control" id="id_contacts-${idx}-contact_name">
            </div>
            <div class="col-md-3">
              <label class="form-label mb-1">Email</label>
              <input type="email" name="contacts-${idx}-email" class="form-control" id="id_contacts-${idx}-email">
            </div>
            <div class="col-md-1 d-flex">
              <button type="button" class="btn btn-outline-danger w-100 remove-contact">Видалити</button>
            </div>
          `;
          contactsContainer.appendChild(row);
          totalForms.value = idx + 1;
          bindRemove(row.querySelector('.remove-contact'));
          bindPhoneMask(row.querySelector('input[name$="-phone"]'));
        });
      }
    });
  </script>
{% endblock %}
